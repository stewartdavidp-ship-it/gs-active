{
  "rules": {
    // ========== USER DATA ==========
    // Users can only read/write their own data
    "users": {
      "$uid": {
        ".read": "$uid === auth.uid",
        ".write": "$uid === auth.uid",
        
        "shelf": {
          "wallet": {
            "tokens": {
              // Tokens: 0 to 50,000 range
              ".validate": "newData.isNumber() && newData.val() >= 0 && newData.val() <= 50000"
            },
            "coins": {
              // Coins: allow negative (debt from chargebacks) up to 10,000
              ".validate": "newData.isNumber() && newData.val() >= -1000 && newData.val() <= 10000"
            }
          },
          
          "games": {
            "$gameIndex": {
              ".validate": "newData.hasChildren(['id', 'name'])"
            }
          },
          
          "history": {
            "$date": {
              "$gameId": {
                ".validate": "newData.isString() || newData.hasChildren()"
              }
            }
          }
        },
        
        "displayName": {
          ".validate": "newData.isString() && newData.val().length >= 1 && newData.val().length <= 50"
        },
        
        "photoURL": {
          ".validate": "newData.isString() && newData.val().length <= 500"
        },
        
        "friendCode": {
          ".validate": "newData.isString() && newData.val().length >= 4 && newData.val().length <= 20"
        },
        
        // Referral info - can only be set once
        "referral": {
          "referredBy": {
            ".write": "!data.exists()",
            ".validate": "newData.isString()"
          }
        },
        
        // Token transaction history
        "tokenHistory": {
          "$transactionId": {
            ".validate": "newData.hasChildren(['type', 'amount', 'timestamp'])"
          }
        },
        
        // Pending rewards from referrals
        "pendingReferralRewards": {
          "$rewardId": {
            ".validate": "newData.hasChildren(['type', 'tokens', 'timestamp'])"
          }
        },
        
        // Purchase lock flag (set by server on chargeback)
        "purchaseLocked": {
          ".write": false
        },
        
        // Account creation timestamp
        "createdAt": {
          ".write": "!data.exists()",
          ".validate": "newData.isNumber()"
        },
        
        // Last visit for activity tracking
        "lastVisit": {
          ".validate": "newData.isNumber()"
        }
      }
    },
    
    // ========== FRIENDS ==========
    // Users can only manage their own friends list
    "friends": {
      "$uid": {
        ".read": "$uid === auth.uid",
        ".write": "$uid === auth.uid",
        
        "$friendUid": {
          ".validate": "newData.hasChildren(['odataId', 'addedAt']) && newData.child('odataId').val() === $friendUid"
        }
      }
    },
    
    // ========== REFERRAL CODES ==========
    // Public read, owner-only write, referees write-once
    "referralCodes": {
      "$code": {
        ".read": true,
        ".write": "!data.exists() || data.child('ownerId').val() === auth.uid",
        
        "ownerId": {
          ".validate": "newData.isString() && newData.val() === auth.uid"
        },
        
        "ownerName": {
          ".validate": "newData.isString() && newData.val().length <= 50"
        },
        
        "referees": {
          "$refereeUid": {
            // Referee entry can only be created once, by the referee themselves
            ".write": "!data.exists() && $refereeUid === auth.uid",
            ".validate": "newData.hasChildren(['joinedAt']) && newData.child('joinedAt').isNumber()"
          }
        },
        
        "stats": {
          // Stats can be updated by owner
          ".write": "root.child('referralCodes').child($code).child('ownerId').val() === auth.uid"
        }
      }
    },
    
    // ========== BATTLES ==========
    "battles": {
      "$battleId": {
        // Participants and public battles can be read
        ".read": "data.child('participants').child(auth.uid).exists() || data.child('isPublic').val() === true",
        
        // Creator can create battle
        ".write": "!data.exists() && auth != null",
        
        "name": {
          ".validate": "newData.isString() && newData.val().length >= 1 && newData.val().length <= 100"
        },
        
        "status": {
          ".validate": "newData.isString() && (newData.val() === 'pending' || newData.val() === 'active' || newData.val() === 'completed')"
        },
        
        "participants": {
          "$participantUid": {
            // Users can only update their own participant entry
            // Can join if battle not completed
            ".write": "$participantUid === auth.uid && (data.exists() || root.child('battles').child($battleId).child('status').val() !== 'completed')",
            
            "displayName": {
              ".validate": "newData.isString() && newData.val().length <= 50"
            },
            
            "score": {
              ".validate": "newData.isNumber() && newData.val() >= 0 && newData.val() <= 100000"
            },
            
            "games": {
              "$gameId": {
                ".validate": "newData.isNumber() && newData.val() >= 0"
              }
            }
          }
        },
        
        "entryFee": {
          ".validate": "newData.isNumber() && newData.val() >= 0 && newData.val() <= 50"
        },
        
        "prizePool": {
          ".validate": "newData.isNumber() && newData.val() >= 0"
        },
        
        "games": {
          ".validate": "newData.isString() || newData.hasChildren()"
        },
        
        "endDate": {
          ".validate": "newData.isNumber()"
        },
        
        "creatorId": {
          ".write": "!data.exists()",
          ".validate": "newData.val() === auth.uid"
        },
        
        "joinCode": {
          ".validate": "newData.isString() && newData.val().length >= 4 && newData.val().length <= 10"
        },
        
        "isPublic": {
          ".validate": "newData.isBoolean()"
        }
      }
    },
    
    // ========== PUBLIC BATTLES LOBBY ==========
    "public-battles": {
      ".read": "auth != null",
      
      "$battleId": {
        ".write": "auth != null && (!data.exists() || data.child('creatorId').val() === auth.uid)",
        ".validate": "newData.hasChildren(['name', 'endDate', 'creatorId'])"
      }
    },
    
    // ========== HINT USAGE (Rate Limiting) ==========
    "hint-usage": {
      "$uid": {
        ".read": "$uid === auth.uid",
        ".write": "$uid === auth.uid",
        
        "requests": {
          ".validate": "newData.hasChildren()"
        }
      }
    },
    
    // ========== SERVER-ONLY PATHS ==========
    // These are written by Cloud Functions which bypass security rules
    
    "purchases": {
      ".read": false,
      ".write": false,
      "$uid": {
        ".indexOn": ["stripeSessionId", "timestamp"]
      }
    },
    
    "flaggedAccounts": {
      ".read": false,
      ".write": false
    },
    
    "giftRedemptions": {
      ".read": false,
      ".write": false
    },
    
    "hint-analytics": {
      ".read": false,
      ".write": false
    },
    
    "securityAudit": {
      ".read": false,
      ".write": false
    },
    
    // ========== DEFAULT DENY ==========
    // Deny all other paths
    "$other": {
      ".read": false,
      ".write": false
    }
  }
}
