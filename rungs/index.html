<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="version" content="1.0.14">
    <title>Rungs - Daily Puzzle</title>
    
    <!-- PWA Support -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2d2535">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Rungs">
    <link rel="apple-touch-icon" href="icons/icon-192.png">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ü™ú</text></svg>">
    
    <style>
        :root {
            /* Dark theme (default) */
            --bg-primary: #1a1520;
            --bg-secondary: #2d2535;
            --bg-tertiary: #252030;
            --bg-hover: #3d3548;
            --bg-selected: #4a3555;
            --text-primary: #e8e0f0;
            --text-secondary: #a89fb0;
            --text-muted: #6a5f7a;
            --accent-gold: #ffd369;
            --accent-pink: #ff6b9d;
            --accent-success: #4ade80;
            --accent-error: #f87171;
            --border-color: #3d3548;
            --border-light: #5a4f6a;
            --shadow-glow: rgba(255, 107, 157, 0.3);
        }

        [data-theme="light"] {
            --bg-primary: #f5f3f7;
            --bg-secondary: #ffffff;
            --bg-tertiary: #ebe8ef;
            --bg-hover: #e0dce5;
            --bg-selected: #d4cfe0;
            --text-primary: #2d2535;
            --text-secondary: #5a4f6a;
            --text-muted: #8a7f9a;
            --accent-gold: #c9a030;
            --accent-pink: #d4527a;
            --accent-success: #2d8a4e;
            --accent-error: #c94444;
            --border-color: #d0c8d8;
            --border-light: #b8b0c0;
            --shadow-glow: rgba(212, 82, 122, 0.2);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 15px;
            /* PWA safe area support */
            padding-top: calc(env(safe-area-inset-top, 0px) + 15px);
            padding-bottom: calc(env(safe-area-inset-bottom, 0px) + 15px);
            padding-left: calc(env(safe-area-inset-left, 0px) + 15px);
            padding-right: calc(env(safe-area-inset-right, 0px) + 15px);
            transition: background 0.3s, color 0.3s;
        }

        .container {
            max-width: 420px;
            width: 100%;
        }

        /* Header */
        .header {
            text-align: center;
            margin-bottom: 20px;
            position: relative;
        }

        h1 {
            font-size: 2.5rem;
            font-weight: 300;
            letter-spacing: 0.5rem;
            color: var(--accent-gold);
            margin-bottom: 10px;
        }

        .subtitle {
            font-size: 0.85rem;
            color: var(--text-secondary);
            transition: all 0.3s;
        }

        .subtitle.hint-revealed {
            color: var(--accent-gold);
            font-weight: 600;
        }

        .difficulty-badge {
            display: inline-block;
            padding: 2px 10px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            margin: 5px 0;
        }

        .difficulty-badge.easy {
            background: rgba(76, 175, 80, 0.2);
            color: #4caf50;
        }

        .difficulty-badge.medium {
            background: rgba(255, 193, 7, 0.2);
            color: #ffc107;
        }

        .difficulty-badge.hard {
            background: rgba(244, 67, 54, 0.2);
            color: #f44336;
        }
        
        .difficulty-badge.tutorial {
            background: rgba(156, 39, 176, 0.2);
            color: #ce93d8;
        }
        
        /* Tutorial step dots */
        .step-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--bg-hover);
            transition: all 0.3s ease;
        }
        
        .step-dot.active {
            background: var(--accent-gold);
            transform: scale(1.2);
        }
        
        .step-dot.completed {
            background: var(--accent-success);
        }

        /* Attempts */
        .attempts {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 15px 0;
        }

        .attempt-dot {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: var(--border-color);
            border: 2px solid var(--border-light);
            transition: all 0.3s;
        }

        .attempt-dot.active {
            background: var(--accent-gold);
            border-color: var(--accent-gold);
        }

        .attempt-dot.used {
            background: var(--accent-error);
            border-color: var(--accent-error);
        }

        /* Item Pool */
        .pool {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .item {
            aspect-ratio: 1;
            background: var(--bg-secondary);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            padding: 8px;
            text-align: center;
            word-break: break-word;
        }

        .item:hover {
            background: var(--bg-hover);
        }

        .item.selected {
            background: var(--bg-selected);
            border-color: var(--accent-pink);
            box-shadow: 0 0 15px var(--shadow-glow);
        }

        .item.stacked {
            opacity: 0;
            pointer-events: none;
        }

        .item .emoji {
            font-size: 1.8rem;
        }

        /* Divider */
        .divider {
            height: 2px;
            background: linear-gradient(90deg, transparent, var(--border-light), transparent);
            margin: 10px 0 20px;
        }

        /* Stack Area */
        .stack-area {
            display: flex;
            flex-direction: column-reverse;
            gap: 8px;
            margin-bottom: 20px;
        }

        .stack-row {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .stack-number {
            width: 24px;
            font-size: 0.9rem;
            color: var(--text-muted);
            text-align: center;
        }

        .stack-slot {
            flex: 1;
            height: 50px;
            background: var(--bg-tertiary);
            border: 2px dashed var(--border-color);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            font-size: 1rem;
            color: var(--text-muted);
            transition: all 0.2s;
        }

        .stack-slot.filled {
            background: var(--bg-hover);
            border-style: solid;
            border-color: var(--border-light);
            color: var(--text-primary);
            cursor: pointer;
            position: relative;
        }

        .stack-slot.filled:hover {
            background: var(--bg-selected);
        }

        .stack-slot.selected {
            border-color: var(--accent-pink);
            box-shadow: 0 0 15px var(--shadow-glow);
        }

        .stack-slot .pair-item {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            padding: 0 40px;
            width: 100%;
        }

        .stack-slot .pair-divider {
            color: var(--accent-gold);
            font-weight: bold;
        }

        .stack-slot .drag-handle {
            position: absolute;
            right: 10px;
            color: var(--text-muted);
            cursor: grab;
            font-size: 1.2rem;
            letter-spacing: -3px;
            opacity: 0.5;
        }

        .stack-slot.filled:hover .drag-handle {
            opacity: 1;
        }

        .stack-slot .reorder-btn {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            width: 28px;
            height: 28px;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            padding: 0;
            transition: all 0.15s;
            z-index: 2;
        }
        
        .stack-slot .reorder-btn.btn-up {
            left: 6px;
        }
        
        .stack-slot .reorder-btn.btn-down {
            right: 6px;
        }

        .stack-slot .reorder-btn:hover {
            background: var(--accent-pink);
            color: white;
            border-color: var(--accent-pink);
        }

        .stack-slot .reorder-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .stack-slot .reorder-btn:disabled:hover {
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            border-color: var(--border-color);
        }

        .stack-slot.drag-over {
            border-color: var(--accent-gold);
            background: var(--bg-selected);
        }

        .stack-slot.dragging {
            opacity: 0.5;
        }

        /* Buttons */
        .buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 24px;
            font-size: 1rem;
            font-weight: 600;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            color: var(--text-primary);
            background: var(--bg-hover);
        }

        .btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--accent-pink), var(--accent-gold));
            color: var(--bg-primary);
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px var(--shadow-glow);
        }

        .btn-secondary {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .btn-secondary:hover:not(:disabled) {
            background: var(--bg-selected);
        }

        .btn-danger {
            background: #5a3040;
            color: var(--accent-error);
        }

        .btn-danger:hover:not(:disabled) {
            background: #6a3a50;
        }

        .btn-success {
            background: #2a5a40;
            color: var(--accent-success);
        }

        .btn-success:hover:not(:disabled) {
            background: #3a6a50;
        }

        /* Result Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(10, 8, 15, 0.95);
            z-index: 100;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        [data-theme="light"] .modal {
            background: rgba(100, 90, 110, 0.9);
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--bg-secondary);
            border-radius: 16px;
            padding: 30px;
            max-width: 360px;
            width: 100%;
            text-align: center;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }

        .modal-close-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 32px;
            height: 32px;
            border: none;
            background: var(--bg-hover);
            color: var(--text-muted);
            font-size: 1.5rem;
            cursor: pointer;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
        }

        .modal-close-btn:hover {
            background: var(--bg-selected);
            color: var(--text-primary);
        }

        .modal h2 {
            font-size: 1.5rem;
            margin-bottom: 20px;
            color: var(--accent-gold);
        }

        .modal h2.success {
            color: var(--accent-success);
        }

        .modal h2.fail {
            color: var(--accent-error);
        }

        .result-pairs {
            text-align: left;
            margin: 20px 0;
        }

        .result-pair {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px;
            background: var(--bg-tertiary);
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .result-pair .pair-text {
            font-size: 0.95rem;
        }

        .result-pair .pair-status {
            font-size: 1.2rem;
        }

        .result-order {
            padding: 12px;
            background: var(--bg-tertiary);
            border-radius: 8px;
            margin: 15px 0;
            font-weight: 600;
        }

        .result-order.correct {
            color: var(--accent-success);
        }

        .result-order.incorrect {
            color: var(--accent-error);
        }

        .attempts-remaining {
            margin: 15px 0;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        /* Tell Me More Section */
        .tell-me-more-btn {
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.85rem;
            margin-top: 15px;
            transition: all 0.2s;
        }

        .tell-me-more-btn:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
            border-color: var(--accent-gold);
        }

        .detailed-explanation {
            display: none;
            margin-top: 15px;
            padding: 15px;
            background: var(--bg-tertiary);
            border-radius: 10px;
            border-left: 3px solid var(--accent-gold);
            text-align: left;
            font-size: 0.9rem;
            line-height: 1.6;
        }

        .detailed-explanation.show {
            display: block;
        }

        .detailed-explanation h4 {
            color: var(--accent-gold);
            margin: 0 0 10px 0;
            font-size: 0.95rem;
        }

        .detailed-explanation table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
        }

        .detailed-explanation th,
        .detailed-explanation td {
            padding: 6px 8px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
            font-size: 0.85rem;
        }

        .detailed-explanation th {
            color: var(--accent-gold);
            font-weight: 600;
        }

        /* Bonus Round */
        .bonus-section {
            margin-top: 20px;
        }

        .bonus-section label {
            display: block;
            margin-bottom: 10px;
            font-size: 1rem;
        }

        .bonus-select {
            width: 100%;
            padding: 12px;
            font-size: 1rem;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            margin-bottom: 15px;
        }

        /* Win/Lose screens */
        .final-result {
            font-size: 3rem;
            margin: 20px 0;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin: 20px 0;
        }

        .stat-box {
            background: var(--bg-tertiary);
            padding: 15px 10px;
            border-radius: 8px;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--accent-gold);
        }

        .stat-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-top: 5px;
        }

        /* Share button */
        .share-text {
            background: var(--bg-tertiary);
            padding: 15px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 0.9rem;
            margin: 15px 0;
            white-space: pre-line;
        }

        /* Message toast */
        .message {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--bg-secondary);
            padding: 15px 25px;
            border-radius: 10px;
            font-weight: 500;
            z-index: 200;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        .message.show {
            opacity: 1;
        }

        .message.success {
            border: 2px solid var(--accent-success);
            color: var(--accent-success);
        }

        .message.error {
            border: 2px solid var(--accent-error);
            color: var(--accent-error);
        }

        /* Footer */
        .footer {
            margin-top: 30px;
            text-align: center;
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        /* Mode Toggle */
        .mode-toggle {
            display: flex;
            justify-content: center;
            gap: 5px;
            margin: 10px 0;
        }

        .mode-btn {
            padding: 6px 14px;
            font-size: 0.8rem;
            font-weight: 600;
            border: 2px solid var(--border-color);
            border-radius: 20px;
            background: transparent;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
        }

        .mode-btn:hover {
            border-color: var(--border-light);
            color: var(--text-primary);
        }

        .mode-btn.active {
            background: var(--bg-hover);
            border-color: var(--accent-gold);
            color: var(--accent-gold);
        }

        /* Hamburger Menu */
        .hamburger-btn {
            position: absolute;
            top: 0;
            right: 0;
            background: none;
            border: none;
            cursor: pointer;
            padding: 8px;
            display: flex;
            flex-direction: column;
            gap: 4px;
            z-index: 50;
        }

        .back-btn {
            position: absolute;
            top: 0;
            left: 0;
            background: none;
            border: none;
            cursor: pointer;
            padding: 8px 12px;
            z-index: 50;
            color: var(--text-secondary);
            font-size: 1.1rem;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 4px;
            transition: color 0.2s;
        }

        .back-btn:hover {
            color: var(--accent-gold);
        }

        .back-btn .back-text {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        @media (max-width: 400px) {
            .back-btn .back-text {
                display: none;
            }
        }

        .hamburger-btn span {
            display: block;
            width: 22px;
            height: 2px;
            background: var(--text-secondary);
            transition: all 0.2s;
        }

        .hamburger-btn:hover span {
            background: var(--accent-gold);
        }

        /* Menu Modal */
        .menu-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(10, 8, 15, 0.95);
            z-index: 150;
            align-items: flex-start;
            justify-content: center;
            padding: 40px 20px 20px;
            overflow-y: auto;
        }

        [data-theme="light"] .menu-modal {
            background: rgba(100, 90, 110, 0.95);
        }

        .menu-modal.active {
            display: flex;
        }

        .menu-content {
            background: var(--bg-secondary);
            border-radius: 16px;
            padding: 20px;
            max-width: 320px;
            width: 100%;
            max-height: calc(100vh - 80px);
            overflow-y: auto;
        }

        .menu-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
        }

        .menu-header h2 {
            font-size: 1.2rem;
            color: var(--accent-gold);
        }

        .close-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 5px;
            line-height: 1;
        }

        .close-btn:hover {
            color: var(--accent-error);
        }

        .menu-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px;
            background: var(--bg-tertiary);
            border-radius: 10px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .menu-item label {
            color: var(--text-primary);
        }

        .menu-item:hover {
            background: var(--bg-hover);
        }

        .menu-item-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .menu-item-icon {
            font-size: 1.2rem;
        }

        .menu-item-text {
            font-weight: 500;
        }

        .menu-item-arrow {
            color: var(--text-muted);
        }

        /* Toggle Switch (simple) */
        .toggle-switch {
            position: relative;
            width: 50px;
            height: 26px;
            background: var(--border-color);
            border-radius: 13px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .toggle-switch.active {
            background: var(--accent-gold);
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            top: 3px;
            left: 3px;
            width: 20px;
            height: 20px;
            background: var(--bg-secondary);
            border-radius: 50%;
            transition: all 0.3s;
        }

        .toggle-switch.active::after {
            left: 27px;
        }

        /* Toggle (checkbox-based) */
        .toggle {
            position: relative;
            width: 50px;
            height: 28px;
        }

        .toggle input {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
            z-index: 2;
            margin: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--border-color);
            transition: 0.3s;
            border-radius: 28px;
            z-index: 1;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 3px;
            bottom: 3px;
            background-color: var(--text-secondary);
            transition: 0.3s;
            border-radius: 50%;
        }

        .toggle input:checked + .toggle-slider {
            background-color: var(--accent-gold);
        }

        .toggle input:checked + .toggle-slider:before {
            transform: translateX(22px);
            background-color: var(--bg-primary);
        }

        /* Stats Display */
        .stats-container {
            text-align: left;
        }

        .stats-row {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .stats-row:last-child {
            border-bottom: none;
        }

        .stats-label {
            color: var(--text-secondary);
        }

        .stats-value {
            font-weight: 600;
            color: var(--accent-gold);
        }

        .streak-display {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-bottom: 15px;
        }

        .streak-item {
            text-align: center;
        }

        .streak-value {
            font-size: 2rem;
            font-weight: bold;
            color: var(--accent-gold);
        }

        .streak-value.fire::after {
            content: 'üî•';
            margin-left: 5px;
        }

        .streak-label {
            font-size: 0.7rem;
            color: var(--text-secondary);
            text-transform: uppercase;
        }

        .streak-fire {
            font-size: 1.2rem;
        }

        /* Menu Section */
        .menu-section {
            margin-bottom: 25px;
        }

        .menu-section:last-child {
            margin-bottom: 0;
        }

        .menu-section h3 {
            font-size: 0.85rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-bottom: 12px;
        }

        /* About Section */
        .about-text {
            text-align: left;
            line-height: 1.6;
            color: var(--text-secondary);
        }

        .about-text p {
            margin-bottom: 10px;
        }

        .about-text p:last-child {
            margin-bottom: 0;
        }

        .about-text strong {
            color: var(--accent-gold);
        }

        .about-text h4 {
            color: var(--accent-gold);
            margin: 15px 0 8px;
        }

        .about-text h4:first-child {
            margin-top: 0;
        }

        /* Setting description */
        .setting-desc {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-top: 8px;
            line-height: 1.4;
        }
        
        /* Date Picker Styles */
        .date-picker-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding: 10px;
            background: var(--bg-tertiary);
            border-radius: 10px;
        }
        
        .date-picker-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
            margin-bottom: 15px;
        }
        
        .day-label {
            text-align: center;
            font-size: 0.7rem;
            color: var(--text-muted);
            padding: 5px;
            font-weight: 600;
        }
        
        .date-cell {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
            background: var(--bg-tertiary);
        }
        
        .date-cell:hover:not(.disabled):not(.future) {
            background: var(--accent-gold);
            color: var(--bg-primary);
        }
        
        .date-cell.disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }
        
        .date-cell.future {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .date-cell.today {
            border: 2px solid var(--accent-gold);
        }
        
        .date-cell.won {
            background: var(--accent-success);
            color: white;
        }
        
        .date-cell.lost {
            background: var(--accent-error);
            color: white;
        }
        
        .date-picker-legend {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 15px;
            font-size: 0.75rem;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .legend-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }
        
        .legend-dot.available {
            background: var(--bg-tertiary);
            border: 1px solid var(--text-muted);
        }
        
        .legend-dot.won {
            background: var(--accent-success);
        }
        
        .legend-dot.lost {
            background: var(--accent-error);
        }
        
        .practice-stats-section {
            background: var(--bg-tertiary);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
        }
        
        .practice-stats-section h4 {
            margin-bottom: 10px;
            color: var(--accent-gold);
        }
        
        .practice-stats-row {
            display: flex;
            justify-content: space-around;
        }
        
        .practice-stats-row .stat-value {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--accent-gold);
        }
        
        .practice-stats-row .stat-label {
            font-size: 0.7rem;
            color: var(--text-muted);
        }
        
        /* Practice badge */
        .practice-badge {
            display: inline-block;
            padding: 2px 8px;
            background: var(--accent-gold);
            color: var(--bg-primary);
            font-size: 0.7rem;
            border-radius: 10px;
            margin-left: 5px;
        }

        /* Utility Classes */
        .text-secondary {
            color: var(--text-secondary);
        }

        .text-accent {
            color: var(--accent-gold);
        }

        /* Responsive */
        @media (max-width: 380px) {
            .container {
                padding: 10px;
            }

            .header {
                margin-bottom: 10px;
            }

            h1 {
                font-size: 1.8rem;
            }

            .subtitle {
                font-size: 0.85rem;
            }

            .pool {
                gap: 6px;
                margin-bottom: 12px;
            }

            .item {
                font-size: 0.75rem;
                padding: 4px;
                border-radius: 8px;
            }
            
            .item .emoji {
                font-size: 1.5rem;
            }

            .divider {
                margin: 6px 0 12px;
            }

            .stack-area {
                gap: 6px;
                margin-bottom: 12px;
            }

            .stack-slot {
                height: 42px;
                font-size: 0.85rem;
            }

            .buttons {
                gap: 6px;
            }

            .btn {
                padding: 10px 14px;
                font-size: 0.85rem;
            }

            .footer {
                margin-top: 10px;
                font-size: 0.7rem;
            }
        }

        @media (max-width: 340px) {
            .item {
                font-size: 0.7rem;
            }
            
            .stack-slot {
                height: 38px;
                font-size: 0.8rem;
            }
        }
        
        /* Account Section Styles */
        .account-section {
            background: var(--bg-tertiary);
            border-radius: 10px;
            padding: 12px;
        }
        
        .account-signed-in .account-user-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            flex-wrap: wrap;
            gap: 5px;
        }
        
        .account-email {
            font-size: 0.85rem;
            font-weight: 500;
            color: var(--text-primary);
        }
        
        .account-sync {
            font-size: 0.75rem;
            color: var(--text-muted);
        }
        
        .account-actions {
            display: flex;
            gap: 8px;
        }
        
        .account-actions .btn {
            flex: 1;
            font-size: 0.8rem;
        }
        
        .account-signed-out {
            text-align: center;
        }
        
        .account-signed-out.account-disabled {
            opacity: 0.7;
        }
        
        .btn.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background: var(--bg-tertiary) !important;
        }
        
        .btn.disabled:hover {
            transform: none;
        }
        
        /* Sync Indicator */
        .sync-indicator {
            position: absolute;
            top: 20px;
            right: 60px;
            padding: 6px 10px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            display: none;
            z-index: 100;
        }
        
        .sync-indicator:hover {
            background: var(--bg-secondary);
        }
        
        .sync-indicator.syncing {
            animation: pulse 1s ease-in-out infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        /* Plain Mode Styles */
        body.plain-mode .practice-badge,
        body.plain-mode #practice-mode-section {
            display: none;
        }
    </style>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <!-- RB Games Auth Module -->
    <script>
    const GSAuth = (function() {
        'use strict';
        
        const FIREBASE_CONFIG = {
            apiKey: "AIzaSyBQVwn8vOrFTzLlm2MYIPBwgZV2xR9AuhM",
            authDomain: "word-boxing.firebaseapp.com",
            databaseURL: "https://word-boxing-default-rtdb.firebaseio.com",
            projectId: "word-boxing",
            storageBucket: "word-boxing.firebasestorage.app",
            messagingSenderId: "300155036194",
            appId: "1:300155036194:web:b35463e6f9fbb04d7fe07b"
        };
        
        let currentUser = null;
        let gameId = null;
        let localKeys = {};
        let syncInProgress = false;
        let lastSyncTime = null;
        let isInitialized = false;
        
        function init(game, keys = {}) {
            if (isInitialized) return;
            gameId = game;
            localKeys = keys;
            
            if (typeof firebase !== 'undefined') {
                if (!firebase.apps.length) {
                    try {
                        firebase.initializeApp(FIREBASE_CONFIG);
                    } catch (e) { return; }
                }
                firebase.auth().onAuthStateChanged(handleAuthStateChange);
                isInitialized = true;
            }
        }
        
        function handleAuthStateChange(user) {
            const wasSignedIn = !!currentUser;
            currentUser = user;
            const isPlainModeOn = typeof plainMode !== 'undefined' ? plainMode : false;
            
            if (isPlainModeOn && user) {
                firebase.auth().signOut();
                return;
            }
            
            if (user && !wasSignedIn && !isPlainModeOn) {
                saveProfile();
                updateSyncIndicator('syncing');
                sync().then(() => {
                    updateUI();
                    updateSyncIndicator('synced');
                });
            } else {
                updateUI();
                if (!isPlainModeOn) {
                    updateSyncIndicator(user ? 'synced' : 'hidden');
                } else {
                    updateSyncIndicator('hidden');
                }
            }
        }
        
        async function signIn() {
            const isPlainModeOn = typeof plainMode !== 'undefined' ? plainMode : false;
            if (isPlainModeOn) return null;
            try {
                const provider = new firebase.auth.GoogleAuthProvider();
                const result = await firebase.auth().signInWithPopup(provider);
                return result.user;
            } catch (error) {
                alert('Sign in failed: ' + error.message);
                return null;
            }
        }
        
        async function signOut() {
            if (currentUser) await firebase.auth().signOut();
        }
        
        function isSignedIn() { return !!currentUser; }
        
        function getGameRef() {
            if (!currentUser || !gameId) return null;
            return firebase.database().ref(`users/${currentUser.uid}/games/${gameId}`);
        }
        
        async function saveProfile() {
            if (!currentUser) return;
            try {
                await firebase.database().ref(`users/${currentUser.uid}`).update({
                    email: currentUser.email,
                    displayName: currentUser.displayName || '',
                    lastSeen: firebase.database.ServerValue.TIMESTAMP
                });
            } catch (e) {}
        }
        
        async function saveToCloud(data) {
            const ref = getGameRef();
            if (!ref) return false;
            try {
                await ref.update({ ...data, lastSync: firebase.database.ServerValue.TIMESTAMP });
                lastSyncTime = new Date();
                return true;
            } catch (e) { return false; }
        }
        
        async function loadFromCloud() {
            const ref = getGameRef();
            if (!ref) return null;
            try {
                const snapshot = await ref.once('value');
                return snapshot.exists() ? snapshot.val() : null;
            } catch (e) { return null; }
        }
        
        function getLocalData() {
            const data = {};
            for (const [key, storageKey] of Object.entries(localKeys)) {
                try {
                    const raw = localStorage.getItem(storageKey);
                    if (raw) data[key] = JSON.parse(raw);
                } catch (e) {}
            }
            return data;
        }
        
        function saveLocalData(data) {
            for (const [key, storageKey] of Object.entries(localKeys)) {
                if (data[key] !== undefined) {
                    try { localStorage.setItem(storageKey, JSON.stringify(data[key])); } catch (e) {}
                }
            }
        }
        
        function mergeData(local, cloud) {
            const merged = {};
            if (local.stats || cloud.stats) {
                const ls = local.stats || {};
                const cs = cloud.stats || {};
                merged.stats = {
                    gamesPlayed: Math.max(ls.gamesPlayed || 0, cs.gamesPlayed || 0),
                    gamesWon: Math.max(ls.gamesWon || 0, cs.gamesWon || 0),
                    currentStreak: (ls.lastPlayedDate > cs.lastPlayedDate) ? (ls.currentStreak || 0) : (cs.currentStreak || 0),
                    maxStreak: Math.max(ls.maxStreak || 0, cs.maxStreak || 0),
                    lastPlayedDate: ls.lastPlayedDate > cs.lastPlayedDate ? ls.lastPlayedDate : cs.lastPlayedDate
                };
            }
            if (local.practice || cloud.practice) {
                const lp = local.practice || {};
                const cp = cloud.practice || {};
                merged.practice = {
                    played: Math.max(lp.played || 0, cp.played || 0),
                    won: Math.max(lp.won || 0, cp.won || 0),
                    history: { ...(lp.history || {}), ...(cp.history || {}) }
                };
            }
            return merged;
        }
        
        async function sync() {
            if (!currentUser || syncInProgress) return null;
            syncInProgress = true;
            try {
                const cloudData = await loadFromCloud();
                const localData = getLocalData();
                if (!cloudData || Object.keys(cloudData).length === 0) {
                    await saveToCloud(localData);
                    lastSyncTime = new Date();
                    return localData;
                }
                const merged = mergeData(localData, cloudData);
                saveLocalData(merged);
                await saveToCloud(merged);
                lastSyncTime = new Date();
                return merged;
            } catch (e) { return null; }
            finally { syncInProgress = false; }
        }
        
        function updateUI() {
            const section = document.getElementById('account-section');
            if (!section) return;
            const isPlainModeOn = typeof plainMode !== 'undefined' ? plainMode : false;
            
            if (currentUser) {
                section.innerHTML = `
                    <div class="account-signed-in">
                        <div class="account-user-row">
                            <span class="account-email">${currentUser.email}</span>
                            <span class="account-sync" id="sync-status">${getSyncStatusText()}</span>
                        </div>
                        <div class="account-actions">
                            <button class="btn" onclick="GSAuth.sync()">‚Üª Sync</button>
                            <button class="btn" onclick="GSAuth.signOut()">Sign Out</button>
                        </div>
                    </div>
                `;
            } else if (isPlainModeOn) {
                section.innerHTML = `
                    <div class="account-signed-out account-disabled">
                        <p style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 10px;">Cloud sync & extra features</p>
                        <button class="btn disabled" disabled>üîí Sign in with Google</button>
                        <p style="font-size: 0.75rem; color: var(--text-muted); margin-top: 8px;">Turn off Plain Mode to enable</p>
                    </div>
                `;
            } else {
                section.innerHTML = `
                    <div class="account-signed-out">
                        <p style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 10px;">Save progress across devices</p>
                        <button class="btn btn-primary" onclick="GSAuth.signIn()">üîê Sign in with Google</button>
                    </div>
                `;
            }
        }
        
        function getSyncStatusText() {
            if (!lastSyncTime) return '&#9729; Not synced';
            const diff = Math.floor((new Date() - lastSyncTime) / 1000);
            if (diff < 60) return '&#9729; Just synced';
            if (diff < 3600) return `&#9729; ${Math.floor(diff / 60)}m ago`;
            return `&#9729; ${Math.floor(diff / 3600)}h ago`;
        }
        
        function updateSyncIndicator(status) {
            const indicator = document.getElementById('sync-indicator');
            if (!indicator) return;
            const isPlainModeOn = typeof plainMode !== 'undefined' ? plainMode : false;
            if (isPlainModeOn) { indicator.style.display = 'none'; return; }
            
            indicator.classList.remove('syncing');
            switch (status) {
                case 'hidden': indicator.style.display = 'none'; break;
                case 'syncing':
                    indicator.style.display = 'block';
                    indicator.classList.add('syncing');
                    indicator.textContent = 'üîÑ';
                    break;
                case 'synced':
                    indicator.style.display = 'block';
                    indicator.innerHTML = '&#9729;';
                    break;
            }
        }
        
        return { init, signIn, signOut, isSignedIn, sync, updateUI, get currentUser() { return currentUser; } };
    })();
    </script>
</head>
<body>
    <div class="container" style="position: relative;">
        <!-- Back to Game Shelf Button -->
        <a href="https://gameshelf.co/" class="back-btn" aria-label="Back to Game Shelf">‚Üê <span class="back-text">Game Shelf</span></a>
        
        <!-- Menu Button -->
        <button class="hamburger-btn" onclick="openMenu()" aria-label="Menu">
            <span></span>
            <span></span>
            <span></span>
        </button>
        
        <!-- Sync Indicator -->
        <div class="sync-indicator" id="sync-indicator" onclick="openMenu()" title="Cloud sync status">&#9729;</div>

        <header class="header">
            <h1>RUNGS</h1>
            <div class="subtitle" id="subtitle">Pair the words. Climb the rungs.</div>
            <div style="display: flex; gap: 10px; justify-content: center; align-items: center; flex-wrap: wrap;">
                <div class="difficulty-badge" id="difficulty-badge"></div>
                <div class="solve-time" id="solve-time" style="font-size: 0.75rem; color: var(--text-muted); background: var(--bg-tertiary); padding: 4px 10px; border-radius: 12px;"></div>
            </div>
            <div class="attempts" id="attempts">
                <div class="attempt-dot active"></div>
                <div class="attempt-dot"></div>
                <div class="attempt-dot"></div>
                <div class="attempt-dot"></div>
            </div>
        </header>

        <div class="pool" id="pool"></div>

        <div class="divider"></div>

        <div class="stack-area" id="stack-area">
            <div class="stack-row">
                <div class="stack-number">1</div>
                <div class="stack-slot" id="slot-0" data-slot="0"></div>
            </div>
            <div class="stack-row">
                <div class="stack-number">2</div>
                <div class="stack-slot" id="slot-1" data-slot="1"></div>
            </div>
            <div class="stack-row">
                <div class="stack-number">3</div>
                <div class="stack-slot" id="slot-2" data-slot="2"></div>
            </div>
            <div class="stack-row">
                <div class="stack-number">4</div>
                <div class="stack-slot" id="slot-3" data-slot="3"></div>
            </div>
        </div>

        <div class="buttons">
            <button class="btn btn-primary" id="stack-btn" disabled onclick="stackSelected()">Place</button>
            <button class="btn btn-danger" id="unstack-btn" disabled onclick="unstackSelected()">Remove</button>
            <button class="btn btn-secondary" id="reset-btn" disabled onclick="resetGame()">Reset</button>
            <button class="btn btn-success" id="submit-btn" disabled onclick="validateStack()">Submit</button>
        </div>

        <footer class="footer">
            v1.0.9 &bull; Rungs
        </footer>
    </div>

    <!-- Result Modal -->
    <div class="modal" id="result-modal">
        <div class="modal-content" id="result-content">
            <!-- Filled dynamically -->
        </div>
    </div>

    <!-- Message Toast -->
    <div class="message" id="message"></div>

    <!-- Menu Modal -->
    <div class="menu-modal" id="menu-modal">
        <div class="menu-content">
            <div class="menu-header">
                <h2>üìã Menu</h2>
                <button class="close-btn" onclick="closeMenu()">&times;</button>
            </div>

            <!-- 0. ACCOUNT -->
            <div class="menu-section">
                <h3>&#9729; Account</h3>
                <div id="account-section" class="account-section">
                    <div class="account-signed-out account-disabled">
                        <p style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 10px;">Cloud sync & extra features</p>
                        <button class="btn disabled" disabled>üîí Sign in with Google</button>
                        <p style="font-size: 0.75rem; color: var(--text-muted); margin-top: 8px;">Turn off Plain Mode to enable</p>
                    </div>
                </div>
            </div>

            <!-- 1. DIFFICULTY -->
            <div class="menu-section">
                <h3>&#9881; Difficulty</h3>
                <div class="menu-item">
                    <label>Hard Mode</label>
                    <div class="toggle">
                        <input type="checkbox" id="hard-mode-toggle" onchange="toggleHardMode()">
                        <span class="toggle-slider"></span>
                    </div>
                </div>
                <p class="setting-desc">Easy: Theme revealed after 2nd attempt. Hard: Theme never revealed!</p>
            </div>

            <!-- 2. DISPLAY -->
            <div class="menu-section">
                <h3>üé® Display</h3>
                <div class="menu-item">
                    <label>Dark Mode</label>
                    <div class="toggle">
                        <input type="checkbox" id="dark-mode-toggle" onchange="toggleDarkMode()" checked>
                        <span class="toggle-slider"></span>
                    </div>
                </div>
            </div>

            <!-- 3. SOUND -->
            <div class="menu-section">
                <h3>üîä Sound</h3>
                <div class="menu-item">
                    <label>Sound Effects</label>
                    <div class="toggle">
                        <input type="checkbox" id="sound-toggle" onchange="toggleSound()" checked>
                        <span class="toggle-slider"></span>
                    </div>
                </div>
                <button class="btn" onclick="testSounds()" style="width: 100%; background: var(--bg-tertiary); font-size: 0.85rem; margin-top: 8px;">üîä Test Sounds</button>
            </div>

            <!-- 4. TUTORIAL -->
            <div class="menu-section">
                <h3>üìñ Tutorial</h3>
                <div class="menu-item">
                    <label>Show on First Visit</label>
                    <div class="toggle">
                        <input type="checkbox" id="intro-toggle" onchange="toggleIntroSetting()" checked>
                        <span class="toggle-slider"></span>
                    </div>
                </div>
                <button class="btn" onclick="replayTutorial()" style="width: 100%; background: var(--bg-tertiary); margin-top: 8px;">üéì Replay Tutorial</button>
            </div>

            <!-- 5. PRACTICE MODE -->
            <div class="menu-section">
                <h3>üìÖ Practice Mode</h3>
                <p class="setting-desc">Play any past puzzle! Stats tracked separately.</p>
                <button class="btn btn-primary" onclick="openPracticeModal()" style="width: 100%;">Browse Past Puzzles</button>
            </div>

            <!-- 5.5. PLAIN MODE -->
            <div class="menu-section">
                <h3>üìã Plain Mode</h3>
                <div class="menu-item">
                    <div>
                        <label>Plain Mode</label>
                        <p class="setting-desc" style="margin: 2px 0 0 0;">Simplified experience (Free tier)</p>
                    </div>
                    <div class="toggle">
                        <input type="checkbox" id="plain-mode-toggle" onchange="togglePlainMode()" checked>
                        <span class="toggle-slider"></span>
                    </div>
                </div>
            </div>

            <!-- 6. STATISTICS -->
            <div class="menu-section">
                <h3>üìä Statistics</h3>
                <div class="streak-display">
                    <div class="streak-item">
                        <div class="streak-value fire" id="current-streak">0</div>
                        <div class="streak-label">Current Streak</div>
                    </div>
                    <div class="streak-item">
                        <div class="streak-value" id="max-streak">0</div>
                        <div class="streak-label">Best Streak</div>
                    </div>
                </div>
                <div class="stats-grid">
                    <div class="stat-box">
                        <div class="stat-value" id="games-played">0</div>
                        <div class="stat-label">Played</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="win-rate">0%</div>
                        <div class="stat-label">Win Rate</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="games-won">0</div>
                        <div class="stat-label">Won</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="avg-attempts">-</div>
                        <div class="stat-label">Avg Attempts</div>
                    </div>
                </div>
            </div>

            <!-- 7. HOW TO PLAY -->
            <div class="menu-section">
                <h3>‚ùì How to Play</h3>
                <div class="about-text">
                    <p>Pair 8 items into 4 matches, then arrange them in the correct sequence on the rungs.</p>
                    <ul style="margin: 10px 0 0 15px; font-size: 0.9rem;">
                        <li>Drag items to form pairs</li>
                        <li>Stack pairs from least ‚Üí most</li>
                        <li>Submit to check your answer</li>
                    </ul>
                </div>
            </div>

            <!-- 8. GAME INFO -->
            <div class="menu-section">
                <h3>‚ÑπÔ∏è Game Info</h3>
                <p><strong>Puzzle #:</strong> <span id="puzzle-number-display">-</span></p>
                <p><strong>Total Puzzles:</strong> 52</p>
                <div style="margin-top: 10px; padding: 12px; background: var(--bg-tertiary); border-radius: 10px; text-align: center;">
                    <div style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 5px;">Next puzzle in</div>
                    <div id="countdown-timer" style="font-size: 1.3rem; font-weight: 600; color: var(--accent-gold);">--:--</div>
                </div>
                <p style="margin-top: 12px; font-size: 0.75rem; color: var(--text-muted); text-align: center;">v<span id="version-display"></span></p>
            </div>

            <!-- 9. DATA -->
            <div class="menu-section">
                <h3>üóëÔ∏è Data</h3>
                <button class="btn btn-danger" onclick="confirmResetStats()" style="width: 100%;">Reset Statistics</button>
            </div>

            <!-- Test Mode Section (hidden in production) -->
            <div class="menu-section" id="test-mode-section">
                <h3>üß™ Test Mode</h3>
                <div class="menu-item" style="flex-direction: column; align-items: stretch; gap: 10px;">
                    <label>Select Puzzle:</label>
                    <select id="puzzle-selector" style="padding: 10px; border-radius: 8px; background: var(--bg-tertiary); color: var(--text-primary); border: 1px solid var(--border-color); font-size: 0.9rem;">
                        <option value="">-- Daily Puzzle --</option>
                    </select>
                    <button class="btn btn-primary" onclick="loadSelectedPuzzle()" style="margin-top: 5px;">Load Puzzle</button>
                </div>
                <div class="menu-item" style="margin-top: 10px;">
                    <button class="btn" onclick="resetTutorialState()" style="width: 100%; background: var(--bg-tertiary); font-size: 0.85rem;">üîÑ Reset First-Time State</button>
                </div>
            </div>
            
            <!-- Game Shelf Badge -->
            <div class="menu-section" style="text-align: center; padding: 20px 15px; background: linear-gradient(135deg, rgba(102,126,234,0.15) 0%, rgba(118,75,162,0.15) 100%); border-radius: 12px;">
                <div style="display: flex; align-items: center; justify-content: center; gap: 12px; margin-bottom: 10px;">
                    <svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg" style="width: 40px; height: 40px;">
                        <defs>
                            <linearGradient id="gsBadgeGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                                <stop offset="0%" style="stop-color:#667eea"/>
                                <stop offset="100%" style="stop-color:#764ba2"/>
                            </linearGradient>
                        </defs>
                        <rect x="5" y="5" width="90" height="90" rx="20" fill="url(#gsBadgeGrad)"/>
                        <g transform="rotate(-12, 35, 50)">
                            <rect x="15" y="28" width="28" height="36" rx="4" fill="white"/>
                            <circle cx="43" cy="46" r="6" fill="white"/>
                            <text x="29" y="54" font-family="Arial, sans-serif" font-size="20" font-weight="bold" fill="#667eea" text-anchor="middle">G</text>
                        </g>
                        <g transform="rotate(12, 65, 50)">
                            <rect x="57" y="28" width="28" height="36" rx="4" fill="rgba(255,255,255,0.9)"/>
                            <circle cx="57" cy="46" r="6" fill="url(#gsBadgeGrad)"/>
                            <text x="71" y="54" font-family="Arial, sans-serif" font-size="20" font-weight="bold" fill="#764ba2" text-anchor="middle">S</text>
                        </g>
                    </svg>
                    <span style="font-size: 1.1rem; font-weight: 600; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">A Game Shelf Original</span>
                </div>
                <p style="font-size: 0.85rem; color: var(--text-muted); margin: 0;">
                    Track your daily puzzles at <a href="https://gameshelf.club" target="_blank" style="color: #667eea; text-decoration: none; font-weight: 500;">gameshelf.club</a>
                </p>
            </div>
        </div>
    </div>

    <!-- Practice Mode Modal -->
    <div class="modal" id="practice-modal">
        <div class="modal-content" style="max-width: 450px;">
            <button class="close-btn" onclick="closePracticeModal()" style="position: absolute; top: 15px; right: 15px;">&times;</button>
            <h2 style="color: var(--accent-gold); margin-bottom: 15px;">üìÖ Practice Mode</h2>
            <p style="text-align: center; color: var(--text-muted); margin-bottom: 15px;">Select a past puzzle to play</p>
            
            <div class="date-picker-header">
                <button class="btn" onclick="changeMonth(-1)" id="prev-month">‚óÄ</button>
                <span id="current-month" style="font-weight: 600;">January 2026</span>
                <button class="btn" onclick="changeMonth(1)" id="next-month">‚ñ∂</button>
            </div>
            
            <div class="date-picker-grid" id="date-picker-grid">
                <div class="day-label">Sun</div>
                <div class="day-label">Mon</div>
                <div class="day-label">Tue</div>
                <div class="day-label">Wed</div>
                <div class="day-label">Thu</div>
                <div class="day-label">Fri</div>
                <div class="day-label">Sat</div>
            </div>
            
            <div class="date-picker-legend">
                <div class="legend-item"><div class="legend-dot available"></div><span>Available</span></div>
                <div class="legend-item"><div class="legend-dot won"></div><span>Won</span></div>
                <div class="legend-item"><div class="legend-dot lost"></div><span>Lost</span></div>
            </div>
            
            <div class="practice-stats-section">
                <h4>Practice Stats</h4>
                <div class="practice-stats-row">
                    <div><div class="stat-value" id="practice-played">0</div><div class="stat-label">Played</div></div>
                    <div><div class="stat-value" id="practice-won">0</div><div class="stat-label">Won</div></div>
                    <div><div class="stat-value" id="practice-rate">0%</div><div class="stat-label">Win Rate</div></div>
                </div>
            </div>
            
            <button class="btn" onclick="returnToDaily()" style="width: 100%; margin-top: 15px; background: var(--bg-tertiary);">Return to Daily Puzzle</button>
        </div>
    </div>

    <!-- Reset Confirmation Modal -->
    <div class="modal" id="reset-modal">
        <div class="modal-content" style="max-width: 400px; text-align: center;">
            <h2 style="color: var(--accent-error); margin-bottom: 15px;">‚ö†Ô∏è Reset Statistics?</h2>
            <p style="margin-bottom: 20px;">This will clear all your game statistics. This action cannot be undone.</p>
            <div style="display: flex; gap: 10px; justify-content: center;">
                <button class="btn" onclick="closeResetModal()" style="background: var(--bg-tertiary);">Cancel</button>
                <button class="btn btn-danger" onclick="resetStats()">Yes, Reset</button>
            </div>
        </div>
    </div>

    <!-- Intro Modal -->
    <!-- Tutorial Choice Modal (first-time players) -->
    <div class="modal" id="tutorial-choice-modal">
        <div class="modal-content" style="max-width: 420px;">
            <h2 style="color: var(--accent-gold); margin-bottom: 15px;">üëã Welcome to Rungs!</h2>
            
            <div class="about-text" style="text-align: left;">
                <p>Pair words into concepts, then arrange them in order from <strong>least to most</strong>.</p>
                
                <p style="margin-top: 15px;">Is this your first time playing?</p>
            </div>
            
            <div style="margin-top: 25px; display: flex; flex-direction: column; gap: 12px;">
                <button class="btn btn-primary" onclick="startTutorial()" style="width: 100%; padding: 15px;">
                    üéì Yes, show me how to play<br>
                    <span style="font-size: 0.8rem; opacity: 0.8;">(Practice puzzle - won't count)</span>
                </button>
                
                <button class="btn" onclick="skipTutorial()" style="width: 100%; padding: 15px; background: var(--bg-hover);">
                    üöÄ I know the rules, let's go!<br>
                    <span style="font-size: 0.8rem; opacity: 0.8;">(Start today's puzzle)</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Tutorial Walkthrough Modal (step-by-step guide) -->
    <div class="modal" id="tutorial-walkthrough-modal">
        <div class="modal-content" style="max-width: 440px;">
            <button class="modal-close-btn" onclick="exitTutorialWalkthrough()">&times;</button>
            
            <!-- Step indicator -->
            <div id="tutorial-step-indicator" style="display: flex; justify-content: center; gap: 8px; margin-bottom: 20px;">
                <span class="step-dot active"></span>
                <span class="step-dot"></span>
                <span class="step-dot"></span>
                <span class="step-dot"></span>
            </div>
            
            <!-- Step 1: Word Pool -->
            <div class="tutorial-step" id="tutorial-step-1">
                <h2 style="color: var(--accent-gold); margin-bottom: 15px;">Step 1: Find Pairs</h2>
                <div class="about-text" style="text-align: left;">
                    <div style="background: var(--bg-tertiary); padding: 15px; border-radius: 12px; margin-bottom: 15px;">
                        <div style="display: flex; flex-wrap: wrap; gap: 8px; justify-content: center;">
                            <span style="background: var(--bg-hover); padding: 8px 12px; border-radius: 8px;">OCEAN</span>
                            <span style="background: var(--bg-hover); padding: 8px 12px; border-radius: 8px;">HEAT</span>
                            <span style="background: var(--bg-hover); padding: 8px 12px; border-radius: 8px;">CLOUD</span>
                            <span style="background: var(--bg-hover); padding: 8px 12px; border-radius: 8px;">FORM</span>
                        </div>
                    </div>
                    <p>You'll see <strong>8 words</strong> in the pool above.</p>
                    <p style="margin-top: 10px;">Tap two words that form a <strong>conceptual pair</strong>. For example: <strong>OCEAN + HEAT</strong> = evaporation.</p>
                    <p style="margin-top: 10px;">Then tap <strong>Place</strong> to add the pair to the rungs below.</p>
                </div>
            </div>
            
            <!-- Step 2: The Rungs -->
            <div class="tutorial-step" id="tutorial-step-2" style="display: none;">
                <h2 style="color: var(--accent-gold); margin-bottom: 15px;">Step 2: Arrange the Rungs</h2>
                <div class="about-text" style="text-align: left;">
                    <div style="background: var(--bg-tertiary); padding: 15px; border-radius: 12px; margin-bottom: 15px;">
                        <div style="display: flex; flex-direction: column; gap: 6px;">
                            <div style="background: var(--bg-hover); padding: 10px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center;">
                                <span>4. RIVER & FLOW</span>
                                <span style="color: var(--text-muted);">‚ñ≤ ‚ñº</span>
                            </div>
                            <div style="background: var(--bg-hover); padding: 10px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center;">
                                <span>3. RAIN & FALL</span>
                                <span style="color: var(--text-muted);">‚ñ≤ ‚ñº</span>
                            </div>
                            <div style="background: var(--bg-hover); padding: 10px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center;">
                                <span>2. CLOUD & FORM</span>
                                <span style="color: var(--text-muted);">‚ñ≤ ‚ñº</span>
                            </div>
                            <div style="background: var(--bg-hover); padding: 10px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center;">
                                <span>1. OCEAN & HEAT</span>
                                <span style="color: var(--text-muted);">‚ñ≤ ‚ñº</span>
                            </div>
                        </div>
                    </div>
                    <p>Once placed, use <strong>‚ñ≤</strong> (left) to move up and <strong>‚ñº</strong> (right) to move down.</p>
                    <p style="margin-top: 10px; padding: 10px; background: var(--bg-tertiary); border-radius: 8px;">
                        <strong style="color: var(--accent-gold);">üìè Key Rule:</strong> Order goes from <strong>least to most</strong> ‚Äî smallest‚Üílargest, first‚Üílast, start‚Üífinish.
                    </p>
                </div>
            </div>
            
            <!-- Step 3: Results -->
            <div class="tutorial-step" id="tutorial-step-3" style="display: none;">
                <h2 style="color: var(--accent-gold); margin-bottom: 15px;">Step 3: Check Your Answer</h2>
                <div class="about-text" style="text-align: left;">
                    <p style="margin-bottom: 12px;"><strong>Example: Wrong pairs</strong></p>
                    <div style="background: var(--bg-tertiary); padding: 12px; border-radius: 12px; margin-bottom: 15px; font-size: 0.9rem;">
                        <div style="display: flex; flex-direction: column; gap: 6px;">
                            <div style="display: flex; justify-content: space-between;">
                                <span>1. OCEAN & HEAT</span>
                                <span style="color: var(--accent-success);">‚úì</span>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span>2. CLOUD & RAIN</span>
                                <span style="color: var(--accent-error);">‚úó</span>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span>3. FORM & FALL</span>
                                <span style="color: var(--accent-error);">‚úó</span>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span>4. RIVER & FLOW</span>
                                <span style="color: var(--accent-success);">‚úì</span>
                            </div>
                        </div>
                    </div>
                    <p style="margin-bottom: 12px;"><strong>Example: Right pairs, wrong order</strong></p>
                    <div style="background: var(--bg-tertiary); padding: 12px; border-radius: 12px; margin-bottom: 15px; font-size: 0.9rem;">
                        <div style="display: flex; flex-direction: column; gap: 6px;">
                            <div style="display: flex; justify-content: space-between;">
                                <span>All pairs: ‚úì ‚úì ‚úì ‚úì</span>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span>Order: <span style="color: var(--accent-success);">‚úì</span> <span style="color: var(--accent-error);">‚úó</span> <span style="color: var(--accent-error);">‚úó</span> <span style="color: var(--accent-success);">‚úì</span></span>
                                <span style="color: var(--text-muted);">swap 2‚Üî3</span>
                            </div>
                        </div>
                    </div>
                    <p>Wrong pairs always come in twos ‚Äî if CLOUD+RAIN is wrong, the orphaned FORM and FALL must pair together (also wrong).</p>
                    <p style="margin-top: 10px;">You have <strong>4 attempts</strong> to solve each puzzle!</p>
                </div>
            </div>
            
            <!-- Step 4: Victory & Learn More -->
            <div class="tutorial-step" id="tutorial-step-4" style="display: none;">
                <h2 style="color: var(--accent-gold); margin-bottom: 15px;">Step 4: Victory!</h2>
                <div class="about-text" style="text-align: left;">
                    <div style="background: var(--bg-tertiary); padding: 15px; border-radius: 12px; margin-bottom: 15px; text-align: center;">
                        <div style="font-size: 2rem; margin-bottom: 10px;">üéâ</div>
                        <div style="color: var(--accent-success); font-weight: bold;">Victory!</div>
                        <div style="margin-top: 8px; color: var(--text-secondary);">The stack was: <strong style="color: var(--accent-gold);">Water Cycle</strong></div>
                        <div style="margin-top: 12px;">
                            <span style="background: var(--bg-hover); padding: 6px 12px; border-radius: 6px; font-size: 0.9rem;">üìñ Tell me more</span>
                        </div>
                    </div>
                    <p>When you win, the <strong>theme is revealed</strong> along with an explanation.</p>
                    <p style="margin-top: 10px;">Tap <strong>"Tell me more"</strong> for a detailed breakdown of each pair and why they connect!</p>
                    <p style="margin-top: 10px;">Share your results with friends using the <strong>Share</strong> button.</p>
                </div>
            </div>
            
            <!-- Navigation buttons -->
            <div style="margin-top: 25px; display: flex; gap: 12px;">
                <button class="btn" id="tutorial-prev-btn" onclick="prevTutorialStep()" style="flex: 1; background: var(--bg-hover); display: none;">‚Üê Back</button>
                <button class="btn btn-primary" id="tutorial-next-btn" onclick="nextTutorialStep()" style="flex: 1;">Next ‚Üí</button>
            </div>
            <button class="btn" onclick="exitTutorialWalkthrough()" style="width: 100%; margin-top: 10px; background: transparent; color: var(--text-muted);">Skip tutorial</button>
        </div>
    </div>

    <div class="modal" id="intro-modal">
        <div class="modal-content" style="max-width: 400px;">
            <h2 style="color: var(--accent-gold); margin-bottom: 20px;">How to Play</h2>
            
            <div class="about-text" style="text-align: left;">
                <p><strong>Goal:</strong> Pair 8 items into 4 conceptual matches, then place them on the rungs in the correct sequence.</p>
                
                <p><strong>Step 1:</strong> Find pairs that together represent a concept</p>
                
                <p><strong>Step 2:</strong> Tap <strong>Place</strong> to add the pair</p>
                
                <p><strong>Step 3:</strong> Order the pairs using ‚ñ≤ (left) and ‚ñº (right) buttons</p>
                
                <p><strong>Step 4:</strong> Tap <strong>Submit</strong> when ready</p>
                
                <p style="margin-top: 15px; padding: 10px; background: var(--bg-tertiary); border-radius: 8px;">
                    <strong style="color: var(--accent-gold);">üìè Order Rule:</strong> Rungs always go from <strong>least to most</strong> ‚Äî smaller‚Üílarger, earlier‚Üílater, start‚Üífinish.
                </p>
                
                <p style="margin-top: 10px; padding: 10px; background: var(--bg-tertiary); border-radius: 8px;">
                    <strong style="color: var(--accent-gold);">üí° Tip:</strong> In Easy Mode, the theme is revealed after 2 attempts. In Hard Mode, it stays hidden!
                </p>
            </div>
            
            <div style="margin-top: 20px;">
                <label style="display: flex; align-items: center; gap: 10px; font-size: 0.9rem; color: var(--text-secondary); cursor: pointer;">
                    <input type="checkbox" id="skip-intro-checkbox" style="width: 18px; height: 18px;">
                    Don't show this again
                </label>
            </div>
            
            <button class="btn btn-primary" onclick="closeIntro()" style="margin-top: 20px; width: 100%;">Let's Play!</button>
        </div>
    </div>

    <script>
        // ============ GAME SHELF INTEGRATION MODULE v1.0.9 ============
        (function() {
            'use strict';
            const GAMESHELF_VERSION = '1.0.14';
            if (window.GameShelfIntegration) return;
            
            window.GameShelfIntegration = {
                version: GAMESHELF_VERSION,
                gameId: null,
                gameConfig: null,
                _initialized: false,
                
                init: function(gameId, config) {
                    if (this._initialized) return;
                    this.gameId = gameId;
                    this.gameConfig = {
                        name: config.name || gameId,
                        icon: config.icon || 'üéÆ',
                        url: config.url || window.location.hostname,
                        version: config.version || '1.0.14',
                        type: config.type || 'daily',
                        ...config
                    };
                    this._initialized = true;
                    this._announcePresence();
                    console.log(`üéÆ Game Shelf Integration initialized for ${this.gameConfig.name}`);
                },
                
                reportComplete: function(result) {
                    if (!this._initialized) return null;
                    const payload = this._buildPayload(result);
                    // Removed: this._storeResult(payload) - copy/paste is now standard
                    this._dispatchEvents(payload);
                    return payload;
                },
                
                _buildPayload: function(result) {
                    return {
                        gameId: this.gameId,
                        gameName: this.gameConfig.name,
                        gameIcon: this.gameConfig.icon,
                        gameUrl: this.gameConfig.url,
                        gameVersion: this.gameConfig.version,
                        timestamp: new Date().toISOString(),
                        date: this._getTodayString(),
                        puzzleId: result.puzzleId || this._getTodayString(),
                        puzzleNumber: result.puzzleNumber || null,
                        result: {
                            won: !!result.won,
                            score: result.score ?? null,
                            attempts: result.attempts ?? null,
                            maxAttempts: result.maxAttempts ?? null,
                            hintsUsed: result.hintsUsed ?? 0,
                            gaveUp: !!result.gaveUp,
                            perfect: !!result.perfect
                        },
                        streak: result.streak || null,
                        meta: {
                            difficulty: result.difficulty ?? null,
                            mode: result.mode ?? null,
                            category: result.category ?? null,
                            ...(result.meta || {})
                        },
                        grid: result.grid || null,
                        scoreLine: result.scoreLine || null,
                        shareText: result.shareText || null
                    };
                },
                
                _announcePresence: function() {
                    document.documentElement.setAttribute('data-gameshelf-game', this.gameId);
                    document.documentElement.setAttribute('data-gameshelf-version', GAMESHELF_VERSION);
                    window.dispatchEvent(new CustomEvent('gameshelf:presence', {
                        detail: { gameId: this.gameId, config: this.gameConfig }
                    }));
                },
                
                _dispatchEvents: function(payload) {
                    window.dispatchEvent(new CustomEvent('gameshelf:complete', { detail: payload }));
                    window.dispatchEvent(new CustomEvent('gameshelf:gameComplete', { detail: payload }));
                },
                
                _storeResult: function(payload) {
                    try {
                        localStorage.setItem(`gameshelf_${this.gameId}_latest`, JSON.stringify(payload));
                        let history = JSON.parse(localStorage.getItem(`gameshelf_${this.gameId}_history`) || '[]');
                        history = history.filter(h => h.puzzleId !== payload.puzzleId);
                        history.unshift(payload);
                        localStorage.setItem(`gameshelf_${this.gameId}_history`, JSON.stringify(history.slice(0, 30)));
                    } catch (e) {}
                },
                
                _getTodayString: function() {
                    const d = new Date();
                    return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
                }
            };
        })();
        // ============ END GAME SHELF INTEGRATION ============

        // ============ CONFIGURATION ============
        const VERSION = '1.0.14';
        const GAME_URL = 'https://rfrbrn.github.io/rungs/rungs.html'; // Update this when hosted
        const DEBUG_MODE = false; // Set to true to show test mode in menu
        
        // ============ PUZZLE DATABASE ============
        // Tutorial puzzle - shown to first-time players
        const TUTORIAL_PUZZLE = {
            items: [
                { id: 1, display: 'OCEAN', type: 'text' },
                { id: 2, display: 'HEAT', type: 'text' },
                { id: 3, display: 'CLOUD', type: 'text' },
                { id: 4, display: 'FORM', type: 'text' },
                { id: 5, display: 'RAIN', type: 'text' },
                { id: 6, display: 'FALL', type: 'text' },
                { id: 7, display: 'RIVER', type: 'text' },
                { id: 8, display: 'FLOW', type: 'text' }
            ],
            pairs: [[1, 2], [3, 4], [5, 6], [7, 8]],
            order: [0, 1, 2, 3],
            stackName: 'Water Cycle (Tutorial)',
            explanation: 'OCEAN+HEAT (sun evaporates water) ‚Üí CLOUD+FORM (vapor condenses) ‚Üí RAIN+FALL (precipitation) ‚Üí RIVER+FLOW (water returns to sea)',
            decoys: ['Weather', 'Geography', 'Seasons'],
            detailedExplanation: `<h4>The Hydrological Cycle</h4> <table> <tr><th>Step</th><th>Pair</th><th>Scientific Process</th></tr> <tr><td>1. Evaporation</td><td>OCEAN + HEAT</td><td>Sun heats ocean water, turning it to vapor</td></tr> <tr><td>2. Condensation</td><td>CLOUD + FORM</td><td>Water vapor cools and forms clouds</td></tr> <tr><td>3. Precipitation</td><td>RAIN + FALL</td><td>Water falls back to earth as rain</td></tr> <tr><td>4. Collection</td><td>RIVER + FLOW</td><td>Water flows back toward the ocean</td></tr> </table> <p>This is the continuous cycle that circulates water through Earth's systems.</p>`,
            difficulty: 'tutorial',
            solveTime: '1 min'
        };

        const PUZZLES = [// Puzzle 1: Building Wealth (poorest ‚Üí richest)
            {
                items: [
                    { id: 1, display: 'SPARE', type: 'text' },
                    { id: 2, display: 'CHANGE', type: 'text' },
                    { id: 3, display: 'PIGGY', type: 'text' },
                    { id: 4, display: 'BANK', type: 'text' },
                    { id: 5, display: 'STOCK', type: 'text' },
                    { id: 6, display: 'BROKER', type: 'text' },
                    { id: 7, display: 'TRUST', type: 'text' },
                    { id: 8, display: 'FUND', type: 'text' }
                ],
                // SPARE+CHANGE (coins) ‚Üí PIGGY+BANK (saving) ‚Üí STOCK+BROKER (investing) ‚Üí TRUST+FUND (wealthy)
                pairs: [[1, 2], [3, 4], [5, 6], [7, 8]],
                order: [0, 1, 2, 3],
                stackName: 'Building Wealth',
                explanation: 'SPARE+CHANGE (pocket coins) ‚Üí PIGGY+BANK (modest savings) ‚Üí STOCK+BROKER (investments) ‚Üí TRUST+FUND (generational wealth)',
                decoys: ['Banking', 'Wall Street', 'Money Terms'],
                detailedExplanation: `<h4>Financial Growth Stages</h4> <table> <tr><th>Stage</th><th>Pair</th><th>What It Represents</th></tr> <tr><td>1. Broke</td><td>SPARE + CHANGE</td><td>Pocket coins, living paycheck to paycheck</td></tr> <tr><td>2. Saving</td><td>PIGGY + BANK</td><td>Starting to save small amounts</td></tr> <tr><td>3. Investing</td><td>STOCK + BROKER</td><td>Growing wealth through investments</td></tr> <tr><td>4. Wealthy</td><td>TRUST + FUND</td><td>Generational wealth, money manages itself</td></tr> </table> <p>The progression follows how people typically build wealth over a lifetime.</p>`,
                difficulty: 'medium',
                solveTime: '1-2 min'
            },
            // Puzzle 2: Career Ladder (entry ‚Üí executive)
            {
                items: [
                    { id: 1, display: 'HELP', type: 'text' },
                    { id: 2, display: 'WANTED', type: 'text' },
                    { id: 3, display: 'TEMP', type: 'text' },
                    { id: 4, display: 'WORK', type: 'text' },
                    { id: 5, display: 'CORNER', type: 'text' },
                    { id: 6, display: 'OFFICE', type: 'text' },
                    { id: 7, display: 'BOARD', type: 'text' },
                    { id: 8, display: 'CHAIR', type: 'text' }
                ],
                // HELP+WANTED (seeking) ‚Üí TEMP+WORK (entry) ‚Üí CORNER+OFFICE (manager) ‚Üí BOARD+CHAIR (executive)
                // Red herring: OFFICE+CHAIR (furniture) - tempting but wrong!
                pairs: [[1, 2], [3, 4], [5, 6], [7, 8]],
                order: [0, 1, 2, 3],
                stackName: 'Career Ladder',
                explanation: 'HELP+WANTED (job hunting) ‚Üí TEMP+WORK (starting out) ‚Üí CORNER+OFFICE (management) ‚Üí BOARD+CHAIR (chairman)',
                decoys: ['Office Chair', 'Furniture', 'Signs'],
                detailedExplanation: `<h4>Professional Advancement</h4> <table> <tr><th>Level</th><th>Pair</th><th>Career Stage</th></tr> <tr><td>1. Job Seeker</td><td>HELP + WANTED</td><td>Looking for employment</td></tr> <tr><td>2. Entry Level</td><td>TEMP + WORK</td><td>First job, often temporary or contract</td></tr> <tr><td>3. Management</td><td>CORNER + OFFICE</td><td>Promoted to manager with prime office</td></tr> <tr><td>4. Executive</td><td>BOARD + CHAIR</td><td>Chairman of the board</td></tr> </table> <p>Tricky: OFFICE+CHAIR (furniture) is tempting, but CORNER+OFFICE represents management and BOARD+CHAIR means chairman!</p>`,
                difficulty: 'medium',
                solveTime: '2-3 min'
            },
            // Puzzle 3: Chain - Computing Evolution
            {
                items: [
                    { id: 1, display: 'PUNCH', type: 'text' },
                    { id: 2, display: 'CARD', type: 'text' },
                    { id: 3, display: 'MAIN', type: 'text' },
                    { id: 4, display: 'FRAME', type: 'text' },
                    { id: 5, display: 'NOTE', type: 'text' },
                    { id: 6, display: 'BOOK', type: 'text' },
                    { id: 7, display: 'SMART', type: 'text' },
                    { id: 8, display: 'WATCH', type: 'text' }
                ],
                // PUNCH CARD, MAINFRAME, NOTEBOOK, SMARTWATCH
                pairs: [[1, 2], [3, 4], [5, 6], [7, 8]],
                order: [0, 1, 2, 3],
                stackName: 'Computing Evolution',
                puzzleType: 'chain',
                explanation: 'Computing got smaller: punch card (1950s) ‚Üí mainframe (1960s) ‚Üí notebook (1990s) ‚Üí smartwatch (2010s)',
                decoys: ['Office Supplies', 'Library', 'Jewelry'],
                difficulty: 'hard',
                solveTime: '2-3 min',
                detailedExplanation: `
                    <h4>Computing Devices Got Smaller Over Time</h4>
                    <table>
                        <tr><th>Era</th><th>Pair</th><th>Device</th><th>Size</th></tr>
                        <tr><td>1950s</td><td>PUNCH + CARD</td><td>Punch cards fed into room-sized computers</td><td>Building</td></tr>
                        <tr><td>1960s</td><td>MAIN + FRAME</td><td>Mainframe computers</td><td>Room</td></tr>
                        <tr><td>1990s</td><td>NOTE + BOOK</td><td>Notebook/laptop computers</td><td>Briefcase</td></tr>
                        <tr><td>2010s</td><td>SMART + WATCH</td><td>Smartwatch with full computing power</td><td>Wrist</td></tr>
                    </table>
                    <p>The sequence follows the miniaturization of computing from building-sized machines to devices on your wrist.</p>
                `
            },
            // Puzzle 4: Making Bread
            {
                items: [
                    { id: 1, display: 'FLOUR', type: 'text' },
                    { id: 2, display: 'WATER', type: 'text' },
                    { id: 3, display: 'YEAST', type: 'text' },
                    { id: 4, display: 'BUBBLE', type: 'text' },
                    { id: 5, display: 'OVEN', type: 'text' },
                    { id: 6, display: 'BROWN', type: 'text' },
                    { id: 7, display: 'BUTTER', type: 'text' },
                    { id: 8, display: 'SLICE', type: 'text' }
                ],
                // FLOUR+WATER (mix) ‚Üí YEAST+BUBBLE (rise) ‚Üí OVEN+BROWN (bake) ‚Üí BUTTER+SLICE (serve)
                // Red herring: BROWN+BUTTER (brown butter is a real culinary technique!)
                pairs: [[1, 2], [3, 4], [5, 6], [7, 8]],
                order: [0, 1, 2, 3],
                stackName: 'Making Bread',
                explanation: 'FLOUR+WATER (mix dough) ‚Üí YEAST+BUBBLE (dough rises) ‚Üí OVEN+BROWN (bake it) ‚Üí BUTTER+SLICE (serve and eat)',
                decoys: ['Brown Butter', 'Baking', 'Kitchen'],
                detailedExplanation: `<h4>Bread Baking Process</h4> <table> <tr><th>Step</th><th>Pair</th><th>What Happens</th></tr> <tr><td>1. Mix</td><td>FLOUR + WATER</td><td>Combine basic ingredients into dough</td></tr> <tr><td>2. Rise</td><td>YEAST + BUBBLE</td><td>Yeast ferments, creating gas bubbles</td></tr> <tr><td>3. Bake</td><td>OVEN + BROWN</td><td>Heat transforms dough into bread</td></tr> <tr><td>4. Serve</td><td>BUTTER + SLICE</td><td>Cut and serve with butter</td></tr> </table> <p>Tricky: BROWN+BUTTER is a real cooking technique (butter cooked until browned), but here OVEN+BROWN represents baking and BUTTER+SLICE is serving!</p>`,
                difficulty: 'medium',
                solveTime: '2-3 min'
            },
            // Puzzle 5: A Thunderstorm
            {
                items: [
                    { id: 1, display: 'STILL', type: 'text' },
                    { id: 2, display: 'AIR', type: 'text' },
                    { id: 3, display: 'DARK', type: 'text' },
                    { id: 4, display: 'SKY', type: 'text' },
                    { id: 5, display: 'FLASH', type: 'text' },
                    { id: 6, display: 'BOOM', type: 'text' },
                    { id: 7, display: 'BIRD', type: 'text' },
                    { id: 8, display: 'SING', type: 'text' }
                ],
                // STILL+AIR (calm) ‚Üí DARK+SKY (clouds) ‚Üí FLASH+BOOM (storm) ‚Üí BIRD+SING (clear)
                pairs: [[1, 2], [3, 4], [5, 6], [7, 8]],
                order: [0, 1, 2, 3],
                stackName: 'A Thunderstorm',
                explanation: 'STILL+AIR (calm before storm) ‚Üí DARK+SKY (clouds roll in) ‚Üí FLASH+BOOM (lightning and thunder) ‚Üí BIRD+SING (storm passes)',
                decoys: ['Weather', 'Nature', 'Seasons'],
                detailedExplanation: `<h4>Storm Development Stages</h4> <table> <tr><th>Stage</th><th>Pair</th><th>Weather Condition</th></tr> <tr><td>1. Calm</td><td>STILL + AIR</td><td>Eerie quiet before the storm</td></tr> <tr><td>2. Building</td><td>DARK + SKY</td><td>Clouds gathering, sky darkening</td></tr> <tr><td>3. Storm</td><td>FLASH + BOOM</td><td>Lightning and thunder</td></tr> <tr><td>4. Clearing</td><td>BIRD + SING</td><td>Storm passes, nature resumes</td></tr> </table> <p>The classic progression of a summer thunderstorm.</p>`,
                difficulty: 'easy',
                solveTime: '1-2 min'
            },
            // Puzzle 6: Feeling Sick (minor ‚Üí critical)
            {
                items: [
                    { id: 1, display: 'RUNNY', type: 'text' },
                    { id: 2, display: 'NOSE', type: 'text' },
                    { id: 3, display: 'SICK', type: 'text' },
                    { id: 4, display: 'DAY', type: 'text' },
                    { id: 5, display: 'BED', type: 'text' },
                    { id: 6, display: 'REST', type: 'text' },
                    { id: 7, display: 'LIFE', type: 'text' },
                    { id: 8, display: 'SUPPORT', type: 'text' }
                ],
                // RUNNY+NOSE (cold) ‚Üí SICK+DAY (miss work) ‚Üí BED+REST (serious) ‚Üí LIFE+SUPPORT (critical)
                pairs: [[1, 2], [3, 4], [5, 6], [7, 8]],
                order: [0, 1, 2, 3],
                stackName: 'Feeling Sick',
                explanation: 'RUNNY+NOSE (minor cold) ‚Üí SICK+DAY (stay home) ‚Üí BED+REST (serious illness) ‚Üí LIFE+SUPPORT (critical)',
                decoys: ['Body Parts', 'Sleep', 'Medical'],
                detailedExplanation: `<h4>Illness Severity Scale</h4> <table> <tr><th>Severity</th><th>Pair</th><th>Condition</th></tr> <tr><td>1. Minor</td><td>RUNNY + NOSE</td><td>Common cold symptoms, still functional</td></tr> <tr><td>2. Moderate</td><td>SICK + DAY</td><td>Bad enough to miss work</td></tr> <tr><td>3. Serious</td><td>BED + REST</td><td>Doctor-ordered rest, can't do much</td></tr> <tr><td>4. Critical</td><td>LIFE + SUPPORT</td><td>Hospital ICU, fighting for life</td></tr> </table> <p>From "push through it" to "call 911" - a progression nobody wants to experience.</p>`,
                difficulty: 'medium',
                solveTime: '2 min'
            },
            // Puzzle 7: Growing Up
            {
                items: [
                    { id: 1, display: 'PLAY', type: 'text' },
                    { id: 2, display: 'PEN', type: 'text' },
                    { id: 3, display: 'SAND', type: 'text' },
                    { id: 4, display: 'BOX', type: 'text' },
                    { id: 5, display: 'BACK', type: 'text' },
                    { id: 6, display: 'PACK', type: 'text' },
                    { id: 7, display: 'BRIEF', type: 'text' },
                    { id: 8, display: 'CASE', type: 'text' }
                ],
                // PLAYPEN, SANDBOX, BACKPACK, BRIEFCASE
                pairs: [[1, 2], [3, 4], [5, 6], [7, 8]],
                order: [0, 1, 2, 3],
                stackName: 'Growing Up',
                puzzleType: 'chain',
                explanation: 'Life stages: playpen (baby) ‚Üí sandbox (toddler) ‚Üí backpack (student) ‚Üí briefcase (professional)',
                decoys: ['Childhood', 'Education', 'Business'],
            detailedExplanation: `<h4>Life Stages by Container</h4> <table> <tr><th>Age</th><th>Pair</th><th>What You Carry</th></tr> <tr><td>0-1</td><td>PLAY + PEN</td><td>Baby - contained for safety</td></tr> <tr><td>2-5</td><td>SAND + BOX</td><td>Toddler - outdoor play</td></tr> <tr><td>6-18</td><td>BACK + PACK</td><td>Student - books and homework</td></tr> <tr><td>Adult</td><td>BRIEF + CASE</td><td>Professional - work documents</td></tr> </table> <p>What you carry changes as you grow.</p>`,
                difficulty: 'hard',
                solveTime: '3-4 min'
            },
            // Puzzle 8: Day at the Beach
            {
                items: [
                    { id: 1, display: 'CAR', type: 'text' },
                    { id: 2, display: 'PARK', type: 'text' },
                    { id: 3, display: 'WAVE', type: 'text' },
                    { id: 4, display: 'POOL', type: 'text' },
                    { id: 5, display: 'TOWEL', type: 'text' },
                    { id: 6, display: 'DRY', type: 'text' },
                    { id: 7, display: 'SUN', type: 'text' },
                    { id: 8, display: 'SET', type: 'text' }
                ],
                // CAR+PARK (arrive) ‚Üí WAVE+POOL (swim) ‚Üí TOWEL+DRY (rest) ‚Üí SUN+SET (leave)
                // Red herring: CAR+POOL (carpool) - tempting but wrong!
                pairs: [[1, 2], [3, 4], [5, 6], [7, 8]],
                order: [0, 1, 2, 3],
                stackName: 'Day at the Beach',
                explanation: 'CAR+PARK (arrive at beach) ‚Üí WAVE+POOL (go swimming) ‚Üí TOWEL+DRY (dry off) ‚Üí SUN+SET (time to go home)',
                decoys: ['Carpooling', 'Summer', 'Vacation'],
                detailedExplanation: `<h4>Beach Day Timeline</h4> <table> <tr><th>Time</th><th>Pair</th><th>Activity</th></tr> <tr><td>Morning</td><td>CAR + PARK</td><td>Arrive and find parking</td></tr> <tr><td>Midday</td><td>WAVE + POOL</td><td>Swimming in the wave pool</td></tr> <tr><td>Afternoon</td><td>TOWEL + DRY</td><td>Dry off on the beach</td></tr> <tr><td>Evening</td><td>SUN + SET</td><td>Watch sunset, head home</td></tr> </table> <p>Tricky: CAR+POOL (carpool) is tempting, but WAVE+POOL fits the beach theme!</p>`,
                difficulty: 'medium',
                solveTime: '2-3 min'
            },
            // Puzzle 9: First Day of School (emotional journey)
            {
                items: [
                    { id: 1, display: 'COLD', type: 'text' },
                    { id: 2, display: 'SWEAT', type: 'text' },
                    { id: 3, display: 'IRON', type: 'text' },
                    { id: 4, display: 'SHIRT', type: 'text' },
                    { id: 5, display: 'NEW', type: 'text' },
                    { id: 6, display: 'FACE', type: 'text' },
                    { id: 7, display: 'WARM', type: 'text' },
                    { id: 8, display: 'SMILE', type: 'text' }
                ],
                // COLD+SWEAT (nervous) ‚Üí IRON+SHIRT (dressed up) ‚Üí NEW+FACE (strangers) ‚Üí WARM+SMILE (welcomed)
                // Red herring: SWEAT+SHIRT (sweatshirt) - very tempting!
                pairs: [[1, 2], [3, 4], [5, 6], [7, 8]],
                order: [0, 1, 2, 3],
                stackName: 'First Day of School',
                explanation: 'COLD+SWEAT (nervous) ‚Üí IRON+SHIRT (dressed sharp) ‚Üí NEW+FACE (meeting strangers) ‚Üí WARM+SMILE (feeling welcomed)',
                decoys: ['Sweatshirt', 'Clothing', 'Emotions'],
                detailedExplanation: `<h4>First Day Emotions</h4> <table> <tr><th>Stage</th><th>Pair</th><th>Feeling</th></tr> <tr><td>1. Nervous</td><td>COLD + SWEAT</td><td>Anxiety before the big day</td></tr> <tr><td>2. Prepared</td><td>IRON + SHIRT</td><td>Looking sharp in pressed clothes</td></tr> <tr><td>3. Uncertain</td><td>NEW + FACE</td><td>Surrounded by strangers</td></tr> <tr><td>4. Welcomed</td><td>WARM + SMILE</td><td>Making friends, feeling accepted</td></tr> </table> <p>Tricky: SWEAT+SHIRT (sweatshirt) is tempting, but that orphans IRON!</p>`,
                difficulty: 'medium',
                solveTime: '2-3 min'
            },
            // Puzzle 10: Buying a House (looking ‚Üí owning)
            {
                items: [
                    { id: 1, display: 'WINDOW', type: 'text' },
                    { id: 2, display: 'SHOP', type: 'text' },
                    { id: 3, display: 'OPEN', type: 'text' },
                    { id: 4, display: 'DOOR', type: 'text' },
                    { id: 5, display: 'CLOSING', type: 'text' },
                    { id: 6, display: 'COST', type: 'text' },
                    { id: 7, display: 'MOVE', type: 'text' },
                    { id: 8, display: 'IN', type: 'text' }
                ],
                // WINDOW+SHOP (browsing) ‚Üí OPEN+DOOR (viewing) ‚Üí CLOSING+COST (buying) ‚Üí MOVE+IN (owning)
                pairs: [[1, 2], [3, 4], [5, 6], [7, 8]],
                order: [0, 1, 2, 3],
                stackName: 'Buying a House',
                explanation: 'WINDOW+SHOP (browsing listings) ‚Üí OPEN+DOOR (touring homes) ‚Üí CLOSING+COST (purchase fees) ‚Üí MOVE+IN (ownership)',
                decoys: ['Real Estate', 'Shopping', 'Home'],
                detailedExplanation: `<h4>Home Buying Journey</h4> <table> <tr><th>Phase</th><th>Pair</th><th>Activity</th></tr> <tr><td>1. Dreaming</td><td>WINDOW + SHOP</td><td>Browsing listings online, imagining</td></tr> <tr><td>2. Touring</td><td>OPEN + DOOR</td><td>Visiting open houses, seeing properties</td></tr> <tr><td>3. Purchasing</td><td>CLOSING + COST</td><td>Finalizing the sale, paying fees</td></tr> <tr><td>4. Owning</td><td>MOVE + IN</td><td>Keys in hand, it's yours!</td></tr> </table> <p>The exciting (and stressful) path to homeownership.</p>`,
                difficulty: 'medium',
                solveTime: '2 min'
            },
            // Puzzle 11: Shortest to Longest Trip
            {
                items: [
                    { id: 1, display: 'SIDE', type: 'text' },
                    { id: 2, display: 'WALK', type: 'text' },
                    { id: 3, display: 'JOY', type: 'text' },
                    { id: 4, display: 'RIDE', type: 'text' },
                    { id: 5, display: 'ROAD', type: 'text' },
                    { id: 6, display: 'TRIP', type: 'text' },
                    { id: 7, display: 'WORLD', type: 'text' },
                    { id: 8, display: 'TOUR', type: 'text' }
                ],
                // SIDEWALK, JOYRIDE, ROADTRIP, WORLDTOUR
                pairs: [[1, 2], [3, 4], [5, 6], [7, 8]],
                order: [0, 1, 2, 3],
                stackName: 'Shortest to Longest Trip',
                explanation: 'Travel distance: a few blocks ‚Üí around town ‚Üí cross country ‚Üí around the world',
                decoys: ['Transportation', 'Vacation Types', 'Music Events'],
            detailedExplanation: `<h4>Travel Distances</h4> <table> <tr><th>Duration</th><th>Pair</th><th>Trip Type</th></tr> <tr><td>Minutes</td><td>SIDE + WALK</td><td>Walking nearby</td></tr> <tr><td>Hours</td><td>JOY + RIDE</td><td>Casual drive for fun</td></tr> <tr><td>Days</td><td>ROAD + TRIP</td><td>Multi-day driving adventure</td></tr> <tr><td>Weeks</td><td>WORLD + TOUR</td><td>Global travel experience</td></tr> </table> <p>From a stroll to circumnavigating the globe.</p>`,
                difficulty: 'hard',
                solveTime: '3-4 min'
            },
            // Puzzle 12: Planting a Garden
            {
                items: [
                    { id: 1, display: 'SHOVEL', type: 'text' },
                    { id: 2, display: 'DIRT', type: 'text' },
                    { id: 3, display: 'SEED', type: 'text' },
                    { id: 4, display: 'BED', type: 'text' },
                    { id: 5, display: 'HOSE', type: 'text' },
                    { id: 6, display: 'SPRAY', type: 'text' },
                    { id: 7, display: 'BASKET', type: 'text' },
                    { id: 8, display: 'FULL', type: 'text' }
                ],
                // SHOVEL+DIRT (dig) ‚Üí SEED+BED (plant) ‚Üí HOSE+SPRAY (water) ‚Üí BASKET+FULL (harvest)
                // Red herring: DIRT+BED (garden bed) - tempting but orphans SHOVEL!
                pairs: [[1, 2], [3, 4], [5, 6], [7, 8]],
                order: [0, 1, 2, 3],
                stackName: 'Planting a Garden',
                explanation: 'SHOVEL+DIRT (prepare soil) ‚Üí SEED+BED (plant in seedbed) ‚Üí HOSE+SPRAY (water daily) ‚Üí BASKET+FULL (harvest crops)',
                decoys: ['Dirt Bed', 'Farming', 'Outdoors'],
                detailedExplanation: `<h4>Garden Growing Seasons</h4> <table> <tr><th>Season</th><th>Pair</th><th>Activity</th></tr> <tr><td>Early Spring</td><td>SHOVEL + DIRT</td><td>Prepare the soil</td></tr> <tr><td>Spring</td><td>SEED + BED</td><td>Plant seeds in the seedbed</td></tr> <tr><td>Summer</td><td>HOSE + SPRAY</td><td>Water regularly</td></tr> <tr><td>Fall</td><td>BASKET + FULL</td><td>Harvest the crops</td></tr> </table> <p>Tricky: DIRT+BED (garden bed) is tempting, but that orphans SHOVEL! SHOVEL+DIRT means preparing soil.</p>`,
                difficulty: 'medium',
                solveTime: '2-3 min'
            },
            // Puzzle 13: Cooking an Egg (breakfast experience)
            {
                items: [
                    { id: 1, display: 'YOLK', type: 'text' },
                    { id: 2, display: 'BREAK', type: 'text' },
                    { id: 3, display: 'SUNNY', type: 'text' },
                    { id: 4, display: 'SIDE', type: 'text' },
                    { id: 5, display: 'MAIN', type: 'text' },
                    { id: 6, display: 'DISH', type: 'text' },
                    { id: 7, display: 'FEED', type: 'text' },
                    { id: 8, display: 'WELL', type: 'text' }
                ],
                // YOLK+BREAK (crack egg) ‚Üí SUNNY+SIDE (style) ‚Üí MAIN+DISH (entr√©e) ‚Üí FEED+WELL (nourish)
                // Red herring: SIDE+DISH (side dish) - very tempting!
                pairs: [[1, 2], [3, 4], [5, 6], [7, 8]],
                order: [0, 1, 2, 3],
                stackName: 'Cooking an Egg',
                explanation: 'YOLK+BREAK (crack the egg) ‚Üí SUNNY+SIDE (sunny side up) ‚Üí MAIN+DISH (it\'s the entr√©e) ‚Üí FEED+WELL (nourish yourself)',
                decoys: ['Side Dish', 'Breakfast', 'Kitchen'],
                detailedExplanation: `<h4>Breakfast Experience</h4> <table> <tr><th>Step</th><th>Pair</th><th>Meaning</th></tr> <tr><td>1. Prep</td><td>YOLK + BREAK</td><td>Crack the egg, break the yolk</td></tr> <tr><td>2. Style</td><td>SUNNY + SIDE</td><td>Cook it sunny side up</td></tr> <tr><td>3. Serve</td><td>MAIN + DISH</td><td>Eggs are the main dish</td></tr> <tr><td>4. Enjoy</td><td>FEED + WELL</td><td>Nourish yourself</td></tr> </table> <p>Tricky: SIDE+DISH (side dish) is tempting, but that orphans SUNNY!</p>`,
                difficulty: 'medium',
                solveTime: '2-3 min'
            },
            // Puzzle 14: Growing Noise (quiet ‚Üí deafening)
            {
                items: [
                    { id: 1, display: 'PIN', type: 'text' },
                    { id: 2, display: 'DROP', type: 'text' },
                    { id: 3, display: 'WHISPER', type: 'text' },
                    { id: 4, display: 'SOFT', type: 'text' },
                    { id: 5, display: 'ALARM', type: 'text' },
                    { id: 6, display: 'BELL', type: 'text' },
                    { id: 7, display: 'SONIC', type: 'text' },
                    { id: 8, display: 'BOOM', type: 'text' }
                ],
                // PIN+DROP (silent) ‚Üí WHISPER+SOFT (quiet) ‚Üí ALARM+BELL (loud) ‚Üí SONIC+BOOM (deafening)
                pairs: [[1, 2], [3, 4], [5, 6], [7, 8]],
                order: [0, 1, 2, 3],
                stackName: 'Growing Noise',
                explanation: 'PIN+DROP (near silence) ‚Üí WHISPER+SOFT (quiet) ‚Üí ALARM+BELL (loud) ‚Üí SONIC+BOOM (deafening)',
                decoys: ['Sounds', 'Music', 'Aviation'],
                detailedExplanation: `<h4>Sound Intensity Scale</h4> <table> <tr><th>Level</th><th>Pair</th><th>Decibels</th></tr> <tr><td>1. Silent</td><td>PIN + DROP</td><td>~10 dB - near total silence</td></tr> <tr><td>2. Quiet</td><td>WHISPER + SOFT</td><td>~30 dB - barely audible</td></tr> <tr><td>3. Loud</td><td>ALARM + BELL</td><td>~80 dB - startling</td></tr> <tr><td>4. Deafening</td><td>SONIC + BOOM</td><td>~150 dB - can cause hearing damage</td></tr> </table> <p>From "you could hear a pin drop" to window-shattering sonic booms.</p>`,
                difficulty: 'medium',
                solveTime: '2 min'
            },
            // Puzzle 15: GR-8 Words
            {
                items: [
                    { id: 1, display: 'SK', type: 'text' },
                    { id: 2, display: '8', type: 'text' },
                    { id: 3, display: 'PL', type: 'text' },
                    { id: 4, display: 'VIII', type: 'text' },
                    { id: 5, display: 'CR', type: 'text' },
                    { id: 6, display: '8Ô∏è‚É£', type: 'emoji' },
                    { id: 7, display: 'ST', type: 'text' },
                    { id: 8, display: 'ATE', type: 'text' }
                ],
                // SKATE, PLATE, CRATE, STATE
                pairs: [[1, 2], [3, 4], [5, 6], [7, 8]],
                order: [0, 1, 2, 3],
                stackName: 'Smallest to Largest',
                explanation: 'Size: skate (foot) ‚Üí plate (dinner) ‚Üí crate (shipping) ‚Üí state (geographic)',
                decoys: ['Rhyming Words', 'Sports', 'Geography'],
            detailedExplanation: `<h4>GR-8 Word Sizes</h4> <table> <tr><th>Size</th><th>Pair</th><th>Word</th></tr> <tr><td>Foot-sized</td><td>SK + 8</td><td>SKATE - fits on your foot</td></tr> <tr><td>Dinner-sized</td><td>PL + VIII</td><td>PLATE - holds a meal</td></tr> <tr><td>Box-sized</td><td>CR + 8Ô∏è‚É£</td><td>CRATE - shipping container</td></tr> <tr><td>Geographic</td><td>ST + ATE</td><td>STATE - entire region</td></tr> </table> <p>All words end in the "ate" sound but vary wildly in size.</p>`,
                difficulty: 'hard',
                solveTime: '4-5 min'
            },
            // Puzzle 16: Making a Movie (concept ‚Üí theater)
            {
                items: [
                    { id: 1, display: 'BRAIN', type: 'text' },
                    { id: 2, display: 'STORM', type: 'text' },
                    { id: 3, display: 'SCREEN', type: 'text' },
                    { id: 4, display: 'PLAY', type: 'text' },
                    { id: 5, display: 'FILM', type: 'text' },
                    { id: 6, display: 'CREW', type: 'text' },
                    { id: 7, display: 'BOX', type: 'text' },
                    { id: 8, display: 'OFFICE', type: 'text' }
                ],
                // BRAIN+STORM (idea) ‚Üí SCREEN+PLAY (script) ‚Üí FILM+CREW (production) ‚Üí BOX+OFFICE (release)
                pairs: [[1, 2], [3, 4], [5, 6], [7, 8]],
                order: [0, 1, 2, 3],
                stackName: 'Making a Movie',
                explanation: 'BRAIN+STORM (generate ideas) ‚Üí SCREEN+PLAY (write script) ‚Üí FILM+CREW (shoot movie) ‚Üí BOX+OFFICE (theatrical release)',
                decoys: ['Hollywood', 'Writing', 'Business'],
                detailedExplanation: `<h4>Film Production Phases</h4> <table> <tr><th>Phase</th><th>Pair</th><th>Industry Term</th></tr> <tr><td>1. Development</td><td>BRAIN + STORM</td><td>Generating and pitching ideas</td></tr> <tr><td>2. Pre-Production</td><td>SCREEN + PLAY</td><td>Writing the script</td></tr> <tr><td>3. Production</td><td>FILM + CREW</td><td>Actually shooting the movie</td></tr> <tr><td>4. Distribution</td><td>BOX + OFFICE</td><td>Theatrical release and revenue</td></tr> </table> <p>Every Hollywood blockbuster follows this path from idea to theater.</p>`,
                difficulty: 'medium',
                solveTime: '2 min'
            },
            // Puzzle 17: Going Fishing
            {
                items: [
                    { id: 1, display: 'ROD', type: 'text' },
                    { id: 2, display: 'CAST', type: 'text' },
                    { id: 3, display: 'FLOAT', type: 'text' },
                    { id: 4, display: 'BOB', type: 'text' },
                    { id: 5, display: 'LINE', type: 'text' },
                    { id: 6, display: 'TUG', type: 'text' },
                    { id: 7, display: 'NET', type: 'text' },
                    { id: 8, display: 'SCOOP', type: 'text' }
                ],
                // ROD+CAST (throw line) ‚Üí FLOAT+BOB (wait) ‚Üí LINE+TUG (bite!) ‚Üí NET+SCOOP (catch)
                pairs: [[1, 2], [3, 4], [5, 6], [7, 8]],
                order: [0, 1, 2, 3],
                stackName: 'Going Fishing',
                explanation: 'ROD+CAST (throw out line) ‚Üí FLOAT+BOB (wait patiently) ‚Üí LINE+TUG (fish bites!) ‚Üí NET+SCOOP (land the catch)',
                decoys: ['Lake', 'Hobby', 'Outdoors'],
                detailedExplanation: `<h4>Fishing Sequence</h4> <table> <tr><th>Step</th><th>Pair</th><th>Action</th></tr> <tr><td>1. Cast</td><td>ROD + CAST</td><td>Throw your line into the water</td></tr> <tr><td>2. Wait</td><td>FLOAT + BOB</td><td>Watch the bobber, be patient</td></tr> <tr><td>3. Bite</td><td>LINE + TUG</td><td>Fish takes the bait!</td></tr> <tr><td>4. Catch</td><td>NET + SCOOP</td><td>Land the fish</td></tr> </table> <p>The patient art of fishing, from cast to catch.</p>`,
                difficulty: 'easy',
                solveTime: '1-2 min'
            },
            // Puzzle 18: Playing Cards
            {
                items: [
                    { id: 1, display: 'SHUFFLE', type: 'text' },
                    { id: 2, display: 'DECK', type: 'text' },
                    { id: 3, display: 'DEAL', type: 'text' },
                    { id: 4, display: 'HAND', type: 'text' },
                    { id: 5, display: 'SIDE', type: 'text' },
                    { id: 6, display: 'BET', type: 'text' },
                    { id: 7, display: 'SHOW', type: 'text' },
                    { id: 8, display: 'DOWN', type: 'text' }
                ],
                // SHUFFLE DECK, DEAL HAND, SIDE BET, SHOWDOWN
                // Red herring: SIDE+SHOW (sideshow) - tempting but wrong!
                pairs: [[1, 2], [3, 4], [5, 6], [7, 8]],
                order: [0, 1, 2, 3],
                stackName: 'Playing Cards',
                explanation: 'Poker sequence: shuffle deck ‚Üí deal hand ‚Üí side bet ‚Üí showdown (reveal cards)',
                decoys: ['Sideshow', 'Casino', 'Gambling'],
                detailedExplanation: `<h4>Poker Hand Sequence</h4> <table> <tr><th>Order</th><th>Pair</th><th>Game Action</th></tr> <tr><td>1. Prepare</td><td>SHUFFLE + DECK</td><td>Mix the cards</td></tr> <tr><td>2. Distribute</td><td>DEAL + HAND</td><td>Give cards to players</td></tr> <tr><td>3. Wager</td><td>SIDE + BET</td><td>Additional wager on the side</td></tr> <tr><td>4. Reveal</td><td>SHOW + DOWN</td><td>Players reveal their cards</td></tr> </table> <p>Tricky: SIDE+SHOW (sideshow) is tempting, but SIDE+BET is the poker term!</p>`,
                difficulty: 'medium',
                solveTime: '2-3 min'
            },
            // Puzzle 19: Cooking Meat (raw ‚Üí done)
            {
                items: [
                    { id: 1, display: 'RAW', type: 'text' },
                    { id: 2, display: 'DEAL', type: 'text' },
                    { id: 3, display: 'RARE', type: 'text' },
                    { id: 4, display: 'BIRD', type: 'text' },
                    { id: 5, display: 'MEDIUM', type: 'text' },
                    { id: 6, display: 'WELL', type: 'text' },
                    { id: 7, display: 'BURNT', type: 'text' },
                    { id: 8, display: 'OUT', type: 'text' }
                ],
                // RAW+DEAL (uncooked) ‚Üí RARE+BIRD (barely cooked) ‚Üí MEDIUM+WELL (properly done) ‚Üí BURNT+OUT (overcooked)
                pairs: [[1, 2], [3, 4], [5, 6], [7, 8]],
                order: [0, 1, 2, 3],
                stackName: 'Cooking Meat',
                explanation: 'RAW+DEAL (uncooked) ‚Üí RARE+BIRD (red center) ‚Üí MEDIUM+WELL (pink) ‚Üí BURNT+OUT (charred)',
                decoys: ['Card Games', 'Animals', 'Exhaustion'],
                detailedExplanation: `<h4>Steak Doneness Levels</h4> <table> <tr><th>Level</th><th>Pair</th><th>Internal Temp</th></tr> <tr><td>1. Uncooked</td><td>RAW + DEAL</td><td>Cold, red throughout</td></tr> <tr><td>2. Rare</td><td>RARE + BIRD</td><td>125¬∞F - red center, seared outside</td></tr> <tr><td>3. Medium</td><td>MEDIUM + WELL</td><td>150¬∞F - pink center</td></tr> <tr><td>4. Overdone</td><td>BURNT + OUT</td><td>Charred, past well-done</td></tr> </table> <p>From tartare to hockey puck - know your temperatures!</p>`,
                difficulty: 'hard',
                solveTime: '4-5 min'
            },
            // Puzzle 20: Crime and Punishment (minor ‚Üí major)
            {
                items: [
                    { id: 1, display: 'JAY', type: 'text' },
                    { id: 2, display: 'WALK', type: 'text' },
                    { id: 3, display: 'SHOP', type: 'text' },
                    { id: 4, display: 'LIFT', type: 'text' },
                    { id: 5, display: 'CAR', type: 'text' },
                    { id: 6, display: 'JACK', type: 'text' },
                    { id: 7, display: 'BANK', type: 'text' },
                    { id: 8, display: 'HEIST', type: 'text' }
                ],
                // JAY+WALK (ticket) ‚Üí SHOP+LIFT (misdemeanor) ‚Üí CAR+JACK (felony) ‚Üí BANK+HEIST (major crime)
                pairs: [[1, 2], [3, 4], [5, 6], [7, 8]],
                order: [0, 1, 2, 3],
                stackName: 'Crime and Punishment',
                explanation: 'JAY+WALK (minor ticket) ‚Üí SHOP+LIFT (misdemeanor) ‚Üí CAR+JACK (violent felony) ‚Üí BANK+HEIST (major crime)',
                decoys: ['Walking', 'Shopping', 'Cars'],
                detailedExplanation: `<h4>Escalating Offenses</h4> <table> <tr><th>Severity</th><th>Pair</th><th>Consequence</th></tr> <tr><td>Infraction</td><td>JAY + WALK</td><td>Small fine, no record</td></tr> <tr><td>Misdemeanor</td><td>SHOP + LIFT</td><td>Possible jail time under 1 year</td></tr> <tr><td>Felony</td><td>CAR + JACK</td><td>Serious prison time</td></tr> <tr><td>Major Crime</td><td>BANK + HEIST</td><td>Federal charges, years in prison</td></tr> </table> <p>From a ticket to federal prison - don't start down this path!</p>`,
                difficulty: 'medium',
                solveTime: '2 min'
            },
            // Puzzle 21: Rocket Launch
            {
                items: [
                    { id: 1, display: 'TEN', type: 'text' },
                    { id: 2, display: 'NINE', type: 'text' },
                    { id: 3, display: 'FLAME', type: 'text' },
                    { id: 4, display: 'ROAR', type: 'text' },
                    { id: 5, display: 'CLOUD', type: 'text' },
                    { id: 6, display: 'PIERCE', type: 'text' },
                    { id: 7, display: 'STAR', type: 'text' },
                    { id: 8, display: 'FLOAT', type: 'text' }
                ],
                // TEN+NINE (countdown) ‚Üí FLAME+ROAR (ignition) ‚Üí CLOUD+PIERCE (ascent) ‚Üí STAR+FLOAT (orbit)
                pairs: [[1, 2], [3, 4], [5, 6], [7, 8]],
                order: [0, 1, 2, 3],
                stackName: 'Rocket Launch',
                explanation: 'TEN+NINE (countdown begins) ‚Üí FLAME+ROAR (engines ignite) ‚Üí CLOUD+PIERCE (rocket ascends) ‚Üí STAR+FLOAT (reach orbit)',
                decoys: ['Space', 'NASA', 'Science'],
                detailedExplanation: `<h4>Space Launch Sequence</h4> <table> <tr><th>Phase</th><th>Pair</th><th>What Happens</th></tr> <tr><td>T-10</td><td>TEN + NINE</td><td>Final countdown begins</td></tr> <tr><td>T-0</td><td>FLAME + ROAR</td><td>Engines ignite</td></tr> <tr><td>Ascent</td><td>CLOUD + PIERCE</td><td>Rocket breaks through atmosphere</td></tr> <tr><td>Orbit</td><td>STAR + FLOAT</td><td>Weightlessness achieved in space</td></tr> </table> <p>The dramatic sequence from countdown to orbit!</p>`,
                difficulty: 'easy',
                solveTime: '1-2 min'
            },
            // Puzzle 22: Starting a Business (idea ‚Üí success)
            {
                items: [
                    { id: 1, display: 'BRAIN', type: 'text' },
                    { id: 2, display: 'CHILD', type: 'text' },
                    { id: 3, display: 'BUSINESS', type: 'text' },
                    { id: 4, display: 'PLAN', type: 'text' },
                    { id: 5, display: 'GRAND', type: 'text' },
                    { id: 6, display: 'OPENING', type: 'text' },
                    { id: 7, display: 'PROFIT', type: 'text' },
                    { id: 8, display: 'MARGIN', type: 'text' }
                ],
                // BRAIN+CHILD (idea) ‚Üí BUSINESS+PLAN (planning) ‚Üí GRAND+OPENING (launch) ‚Üí PROFIT+MARGIN (success)
                pairs: [[1, 2], [3, 4], [5, 6], [7, 8]],
                order: [0, 1, 2, 3],
                stackName: 'Starting a Business',
                explanation: 'BRAIN+CHILD (the idea) ‚Üí BUSINESS+PLAN (document it) ‚Üí GRAND+OPENING (launch day) ‚Üí PROFIT+MARGIN (making money)',
                decoys: ['Parenting', 'Events', 'Finance'],
                detailedExplanation: `<h4>Entrepreneurship Journey</h4> <table> <tr><th>Stage</th><th>Pair</th><th>Milestone</th></tr> <tr><td>1. Ideation</td><td>BRAIN + CHILD</td><td>Your "baby" - the initial concept</td></tr> <tr><td>2. Planning</td><td>BUSINESS + PLAN</td><td>Document strategy for investors</td></tr> <tr><td>3. Launch</td><td>GRAND + OPENING</td><td>Doors open to customers</td></tr> <tr><td>4. Success</td><td>PROFIT + MARGIN</td><td>Actually making money!</td></tr> </table> <p>From napkin sketch to profitable business.</p>`,
                difficulty: 'medium',
                solveTime: '2 min'
            },
            // Puzzle 23: Poker Hands
            {
                items: [
                    { id: 1, display: 'HIGH', type: 'text' },
                    { id: 2, display: 'FIVE', type: 'text' },
                    { id: 3, display: 'STRAIGHT', type: 'text' },
                    { id: 4, display: 'EDGE', type: 'text' },
                    { id: 5, display: 'FULL', type: 'text' },
                    { id: 6, display: 'HOUSE', type: 'text' },
                    { id: 7, display: 'ROYAL', type: 'text' },
                    { id: 8, display: 'FLUSH', type: 'text' }
                ],
                // HIGHFIVE, STRAIGHTEDGE, FULLHOUSE, ROYALFLUSH
                pairs: [[1, 2], [3, 4], [5, 6], [7, 8]],
                order: [0, 1, 2, 3],
                stackName: 'Worst to Best Hand',
                explanation: 'Poker rankings: high card ‚Üí straight ‚Üí full house ‚Üí royal flush',
                decoys: ['Gestures', 'TV Shows', 'Bathroom Terms'],
            detailedExplanation: `<h4>Poker Hand Rankings</h4> <table> <tr><th>Rank</th><th>Pair</th><th>Hand</th></tr> <tr><td>Lowest</td><td>HIGH + FIVE</td><td>High Card (no pairs)</td></tr> <tr><td>Low</td><td>STRAIGHT + EDGE</td><td>Straight (5 in sequence)</td></tr> <tr><td>High</td><td>FULL + HOUSE</td><td>Full House (3 + 2 of a kind)</td></tr> <tr><td>Highest</td><td>ROYAL + FLUSH</td><td>Royal Flush (10-J-Q-K-A suited)</td></tr> </table> <p>Official poker rankings - royal flush beats everything!</p>`,
                difficulty: 'hard',
                solveTime: '4-5 min'
            },
            // Puzzle 24: Relationship Stages (casual ‚Üí committed)
            {
                items: [
                    { id: 1, display: 'BLIND', type: 'text' },
                    { id: 2, display: 'DATE', type: 'text' },
                    { id: 3, display: 'FIRST', type: 'text' },
                    { id: 4, display: 'KISS', type: 'text' },
                    { id: 5, display: 'DIAMOND', type: 'text' },
                    { id: 6, display: 'RING', type: 'text' },
                    { id: 7, display: 'HONEY', type: 'text' },
                    { id: 8, display: 'MOON', type: 'text' }
                ],
                // BLIND+DATE (meeting) ‚Üí FIRST+KISS (dating) ‚Üí DIAMOND+RING (engaged) ‚Üí HONEY+MOON (married)
                pairs: [[1, 2], [3, 4], [5, 6], [7, 8]],
                order: [0, 1, 2, 3],
                stackName: 'Relationship Stages',
                explanation: 'BLIND+DATE (first meeting) ‚Üí FIRST+KISS (dating) ‚Üí DIAMOND+RING (engagement) ‚Üí HONEY+MOON (newlywed)',
                decoys: ['Jewelry', 'Calendar', 'Romance Movies'],
                detailedExplanation: `<h4>Romance Timeline</h4> <table> <tr><th>Stage</th><th>Pair</th><th>Milestone</th></tr> <tr><td>1. Meeting</td><td>BLIND + DATE</td><td>First introduction, nervous energy</td></tr> <tr><td>2. Dating</td><td>FIRST + KISS</td><td>Romance begins</td></tr> <tr><td>3. Engaged</td><td>DIAMOND + RING</td><td>The proposal</td></tr> <tr><td>4. Married</td><td>HONEY + MOON</td><td>Newlywed celebration</td></tr> </table> <p>From strangers to life partners - the classic love story.</p>`,
                difficulty: 'medium',
                solveTime: '2 min'
            },
            // Puzzle 25: Baking a Cake (birthday emotions)
            {
                items: [
                    { id: 1, display: 'SWEET', type: 'text' },
                    { id: 2, display: 'TOOTH', type: 'text' },
                    { id: 3, display: 'LABOR', type: 'text' },
                    { id: 4, display: 'LOVE', type: 'text' },
                    { id: 5, display: 'WISH', type: 'text' },
                    { id: 6, display: 'COME', type: 'text' },
                    { id: 7, display: 'GUILT', type: 'text' },
                    { id: 8, display: 'FREE', type: 'text' }
                ],
                // SWEET+TOOTH (craving) ‚Üí LABOR+LOVE (homemade) ‚Üí WISH+COME (birthday wish) ‚Üí GUILT+FREE (indulge)
                // Red herring: FREE+LOVE (1960s movement) - tempting!
                pairs: [[1, 2], [3, 4], [5, 6], [7, 8]],
                order: [0, 1, 2, 3],
                stackName: 'Baking a Cake',
                explanation: 'SWEET+TOOTH (craving dessert) ‚Üí LABOR of LOVE (homemade with care) ‚Üí WISH+COME true (birthday candles) ‚Üí GUILT+FREE (enjoy it!)',
                decoys: ['Free Love', 'Hippie', 'Emotions'],
                detailedExplanation: `<h4>Birthday Cake Emotions</h4> <table> <tr><th>Stage</th><th>Pair</th><th>Feeling</th></tr> <tr><td>1. Craving</td><td>SWEET + TOOTH</td><td>Wanting something sweet</td></tr> <tr><td>2. Making</td><td>LABOR + LOVE</td><td>Homemade with care</td></tr> <tr><td>3. Wishing</td><td>WISH + COME</td><td>Birthday wish comes true</td></tr> <tr><td>4. Enjoying</td><td>GUILT + FREE</td><td>Indulge without guilt</td></tr> </table> <p>Tricky: FREE+LOVE (1960s movement) is tempting, but that orphans LABOR!</p>`,
                difficulty: 'medium',
                solveTime: '2-3 min'
            },
            // Puzzle 26: Getting Famous (unknown ‚Üí celebrity)
            {
                items: [
                    { id: 1, display: 'OPEN', type: 'text' },
                    { id: 2, display: 'MIC', type: 'text' },
                    { id: 3, display: 'FAN', type: 'text' },
                    { id: 4, display: 'MAIL', type: 'text' },
                    { id: 5, display: 'SOLD', type: 'text' },
                    { id: 6, display: 'OUT', type: 'text' },
                    { id: 7, display: 'HALL', type: 'text' },
                    { id: 8, display: 'FAME', type: 'text' }
                ],
                // OPEN+MIC (starting) ‚Üí FAN+MAIL (getting recognition) ‚Üí SOLD+OUT (popular) ‚Üí HALL+FAME (legendary)
                // Red herring: MAIL+OUT (mailing something) - tempting but wrong!
                pairs: [[1, 2], [3, 4], [5, 6], [7, 8]],
                order: [0, 1, 2, 3],
                stackName: 'Getting Famous',
                explanation: 'OPEN+MIC (amateur start) ‚Üí FAN+MAIL (letters from fans) ‚Üí SOLD+OUT (mainstream success) ‚Üí HALL of FAME (legendary status)',
                decoys: ['Mailing Out', 'Music', 'Concerts'],
                detailedExplanation: `<h4>Path to Stardom</h4> <table> <tr><th>Level</th><th>Pair</th><th>Recognition</th></tr> <tr><td>1. Amateur</td><td>OPEN + MIC</td><td>Performing for free, building skills</td></tr> <tr><td>2. Rising</td><td>FAN + MAIL</td><td>Getting letters from admirers</td></tr> <tr><td>3. Popular</td><td>SOLD + OUT</td><td>Venues at capacity</td></tr> <tr><td>4. Legend</td><td>HALL of + FAME</td><td>Immortalized for contributions</td></tr> </table> <p>Tricky: MAIL+OUT (sending mail) is tempting, but FAN+MAIL represents receiving fan letters!</p>`,
                difficulty: 'medium',
                solveTime: '2-3 min'
            },
            // Puzzle 27: Look-and-Say Sequence (extremely hard)
            {
                items: [
                    { id: 1, display: '2', type: 'text' },
                    { id: 2, display: '1', type: 'text' },
                    { id: 3, display: '12', type: 'text' },
                    { id: 4, display: '11', type: 'text' },
                    { id: 5, display: '1112', type: 'text' },
                    { id: 6, display: '21', type: 'text' },
                    { id: 7, display: '312', type: 'text' },
                    { id: 8, display: '211', type: 'text' }
                ],
                // Look-and-Say: each term describes the previous
                // 1 ‚Üí 11 ‚Üí 21 ‚Üí 1211 ‚Üí 111221 ‚Üí 312211
                pairs: [[1, 2], [3, 4], [5, 6], [7, 8]],
                order: [0, 1, 2, 3],
                stackName: 'Look-and-Say Sequence',
                explanation: '21 (one 2, one 1) ‚Üí 1211 (one 1, one 2, two 1s) ‚Üí 111221 ‚Üí 312211. Each number describes what you SEE in the previous number.',
                decoys: ['Binary Code', 'Phone Numbers', 'Math Puzzle'],
                detailedExplanation: `<h4>Morris Number Sequence</h4> <table> <tr><th>Term</th><th>Pair</th><th>How to Read It</th></tr> <tr><td>1</td><td>2 + 1</td><td>"Two ones" ‚Üí 21</td></tr> <tr><td>2</td><td>12 + 11</td><td>"One 2, one 1" ‚Üí 1211</td></tr> <tr><td>3</td><td>1112 + 21</td><td>"One 1, one 2, two 1s" ‚Üí 111221</td></tr> <tr><td>4</td><td>312 + 211</td><td>"Three 1s, two 2s, one 1" ‚Üí 312211</td></tr> </table> <p>Each term describes the previous term. The pairing IS the puzzle - you must understand the pattern to pair correctly!</p>`,
                difficulty: 'hard',
                solveTime: '5-7 min'
            },
            // Puzzle 28: Writing a Song (inspiration ‚Üí hit)
            {
                items: [
                    { id: 1, display: 'SONG', type: 'text' },
                    { id: 2, display: 'IDEA', type: 'text' },
                    { id: 3, display: 'ROUGH', type: 'text' },
                    { id: 4, display: 'CUT', type: 'text' },
                    { id: 5, display: 'STUDIO', type: 'text' },
                    { id: 6, display: 'TIME', type: 'text' },
                    { id: 7, display: 'CHART', type: 'text' },
                    { id: 8, display: 'TOPPER', type: 'text' }
                ],
                // SONG+IDEA (inspiration) ‚Üí ROUGH+CUT (demo) ‚Üí STUDIO+TIME (recording) ‚Üí CHART+TOPPER (hit)
                pairs: [[1, 2], [3, 4], [5, 6], [7, 8]],
                order: [0, 1, 2, 3],
                stackName: 'Writing a Song',
                explanation: 'SONG+IDEA (inspiration) ‚Üí ROUGH+CUT (early demo) ‚Üí STUDIO+TIME (professional recording) ‚Üí CHART+TOPPER (hit single)',
                decoys: ['Music', 'Editing', 'Success'],
                detailedExplanation: `<h4>Music Production Journey</h4> <table> <tr><th>Phase</th><th>Pair</th><th>Activity</th></tr> <tr><td>1. Inspiration</td><td>SONG + IDEA</td><td>A melody or lyric comes to you</td></tr> <tr><td>2. Demo</td><td>ROUGH + CUT</td><td>Record a basic version</td></tr> <tr><td>3. Recording</td><td>STUDIO + TIME</td><td>Professional production</td></tr> <tr><td>4. Success</td><td>CHART + TOPPER</td><td>Number one hit!</td></tr> </table> <p>From shower singing to Billboard charts.</p>`,
                difficulty: 'medium',
                solveTime: '2 min'
            },
            // Puzzle 29: Getting in Trouble (speeding ‚Üí prison)
            {
                items: [
                    { id: 1, display: 'DRIVE', type: 'text' },
                    { id: 2, display: 'FAST', type: 'text' },
                    { id: 3, display: 'CAR', type: 'text' },
                    { id: 4, display: 'CRASH', type: 'text' },
                    { id: 5, display: 'COURT', type: 'text' },
                    { id: 6, display: 'DATE', type: 'text' },
                    { id: 7, display: 'JAIL', type: 'text' },
                    { id: 8, display: 'TIME', type: 'text' }
                ],
                // DRIVE+FAST (speeding) ‚Üí CAR+CRASH (accident) ‚Üí COURT+DATE (trial) ‚Üí JAIL+TIME (prison)
                pairs: [[1, 2], [3, 4], [5, 6], [7, 8]],
                order: [0, 1, 2, 3],
                stackName: 'Getting in Trouble',
                explanation: 'DRIVE+FAST (speeding) ‚Üí CAR+CRASH (accident) ‚Üí COURT+DATE (face charges) ‚Üí JAIL+TIME (serve sentence)',
                decoys: ['Racing', 'Vehicles', 'Calendar'],
                detailedExplanation: `<h4>Consequences Escalate</h4> <table> <tr><th>Action</th><th>Pair</th><th>Result</th></tr> <tr><td>1. Speeding</td><td>DRIVE + FAST</td><td>Reckless decision</td></tr> <tr><td>2. Accident</td><td>CAR + CRASH</td><td>Direct consequence</td></tr> <tr><td>3. Charges</td><td>COURT + DATE</td><td>Face the legal system</td></tr> <tr><td>4. Sentence</td><td>JAIL + TIME</td><td>Pay for the crime</td></tr> </table> <p>One bad decision leads to another - a cautionary tale.</p>`,
                difficulty: 'easy',
                solveTime: '1-2 min'
            },
            // Puzzle 30: Healing an Injury (hurt ‚Üí recovered)
            {
                items: [
                    { id: 1, display: 'PAPER', type: 'text' },
                    { id: 2, display: 'CUT', type: 'text' },
                    { id: 3, display: 'FIRST', type: 'text' },
                    { id: 4, display: 'AID', type: 'text' },
                    { id: 5, display: 'SICK', type: 'text' },
                    { id: 6, display: 'LEAVE', type: 'text' },
                    { id: 7, display: 'CLEAN', type: 'text' },
                    { id: 8, display: 'BILL', type: 'text' }
                ],
                // PAPER+CUT (minor injury) ‚Üí FIRST+AID (treatment) ‚Üí SICK+LEAVE (recovery) ‚Üí CLEAN+BILL (of health)
                pairs: [[1, 2], [3, 4], [5, 6], [7, 8]],
                order: [0, 1, 2, 3],
                stackName: 'Healing an Injury',
                explanation: 'PAPER+CUT (ouch) ‚Üí FIRST+AID (bandage it) ‚Üí SICK+LEAVE (time off) ‚Üí CLEAN+BILL of health (recovered)',
                decoys: ['Office', 'Medical', 'Finance'],
                detailedExplanation: `<h4>Recovery Process</h4> <table> <tr><th>Phase</th><th>Pair</th><th>Status</th></tr> <tr><td>1. Injury</td><td>PAPER + CUT</td><td>Ouch! Something happened</td></tr> <tr><td>2. Treatment</td><td>FIRST + AID</td><td>Clean and bandage</td></tr> <tr><td>3. Recovery</td><td>SICK + LEAVE</td><td>Time off to heal</td></tr> <tr><td>4. Healed</td><td>CLEAN + BILL</td><td>Doctor says you're 100%</td></tr> </table> <p>From "ouch" to "all clear" - the healing timeline.</p>`,
                difficulty: 'medium',
                solveTime: '2 min'
            },
            // Puzzle 31: When in Rome (phonetic Roman numerals)
            {
                items: [
                    { id: 1, display: 'SINGLE', type: 'text' },
                    { id: 2, display: 'EYE', type: 'text' },
                    { id: 3, display: 'HAND', type: 'text' },
                    { id: 4, display: 'VEE', type: 'text' },
                    { id: 5, display: 'DIME', type: 'text' },
                    { id: 6, display: 'EX', type: 'text' },
                    { id: 7, display: 'CENTURY', type: 'text' },
                    { id: 8, display: 'SEE', type: 'text' }
                ],
                // Phonetic Roman numerals: I=1, V=5, X=10, C=100
                // Red herring: EYE+SEE ("I see!") is incredibly tempting!
                pairs: [[1, 2], [3, 4], [5, 6], [7, 8]],
                order: [0, 1, 2, 3],
                stackName: 'When in Rome',
                explanation: 'SINGLE+EYE (one=I) ‚Üí HAND+VEE (five=V) ‚Üí DIME+EX (ten=X) ‚Üí CENTURY+SEE (hundred=C). Phonetic Roman numerals!',
                decoys: ['I See', 'Eyesight', 'Letters'],
                detailedExplanation: `<h4>Phonetic Roman Numerals</h4> <table> <tr><th>Value</th><th>Pair</th><th>Why</th></tr> <tr><td>I = 1</td><td>SINGLE + EYE</td><td>"Single" means one, "Eye" sounds like "I"</td></tr> <tr><td>V = 5</td><td>HAND + VEE</td><td>Hand has five fingers, "Vee" sounds like "V"</td></tr> <tr><td>X = 10</td><td>DIME + EX</td><td>Dime is ten cents, "Ex" sounds like "X"</td></tr> <tr><td>C = 100</td><td>CENTURY + SEE</td><td>Century is 100 years, "See" sounds like "C"</td></tr> </table> <p>Deadly trap: EYE+SEE looks like "I see!" but that leaves SINGLE+HAND which doesn't work!</p>`,
                difficulty: 'hard',
                solveTime: '4-5 min'
            },
            // Puzzle 32: Getting a Pet (want ‚Üí family)
            {
                items: [
                    { id: 1, display: 'PET', type: 'text' },
                    { id: 2, display: 'STORE', type: 'text' },
                    { id: 3, display: 'PUPPY', type: 'text' },
                    { id: 4, display: 'LOVE', type: 'text' },
                    { id: 5, display: 'HOUSE', type: 'text' },
                    { id: 6, display: 'TRAIN', type: 'text' },
                    { id: 7, display: 'FAMILY', type: 'text' },
                    { id: 8, display: 'DOG', type: 'text' }
                ],
                // PET+STORE (shopping) ‚Üí PUPPY+LOVE (adopt) ‚Üí HOUSE+TRAIN (teaching) ‚Üí FAMILY+DOG (part of family)
                pairs: [[1, 2], [3, 4], [5, 6], [7, 8]],
                order: [0, 1, 2, 3],
                stackName: 'Getting a Pet',
                explanation: 'PET+STORE (visit shop) ‚Üí PUPPY+LOVE (fall in love) ‚Üí HOUSE+TRAIN (teach rules) ‚Üí FAMILY+DOG (new family member)',
                decoys: ['Shopping', 'Romance', 'Home'],
                detailedExplanation: `<h4>New Pet Journey</h4> <table> <tr><th>Stage</th><th>Pair</th><th>Experience</th></tr> <tr><td>1. Shopping</td><td>PET + STORE</td><td>Looking at adorable animals</td></tr> <tr><td>2. Bonding</td><td>PUPPY + LOVE</td><td>Falling in love with one</td></tr> <tr><td>3. Training</td><td>HOUSE + TRAIN</td><td>Teaching rules and routines</td></tr> <tr><td>4. Family</td><td>FAMILY + DOG</td><td>Fully integrated family member</td></tr> </table> <p>From "just looking" to "part of the family."</p>`,
                difficulty: 'medium',
                solveTime: '2 min'
            },
            // Puzzle 33: School Years (youngest ‚Üí graduate)
            {
                items: [
                    { id: 1, display: 'FINGER', type: 'text' },
                    { id: 2, display: 'PAINT', type: 'text' },
                    { id: 3, display: 'RECESS', type: 'text' },
                    { id: 4, display: 'BELL', type: 'text' },
                    { id: 5, display: 'PROM', type: 'text' },
                    { id: 6, display: 'NIGHT', type: 'text' },
                    { id: 7, display: 'CAP', type: 'text' },
                    { id: 8, display: 'GOWN', type: 'text' }
                ],
                // FINGER+PAINT (preschool) ‚Üí RECESS+BELL (elementary) ‚Üí PROM+NIGHT (high school) ‚Üí CAP+GOWN (graduation)
                pairs: [[1, 2], [3, 4], [5, 6], [7, 8]],
                order: [0, 1, 2, 3],
                stackName: 'School Years',
                explanation: 'FINGER+PAINT (preschool) ‚Üí RECESS+BELL (elementary) ‚Üí PROM+NIGHT (high school) ‚Üí CAP+GOWN (graduation)',
                decoys: ['Art Supplies', 'School Events', 'Clothing'],
                detailedExplanation: `<h4>Educational Journey</h4> <table> <tr><th>Age</th><th>Pair</th><th>Stage</th></tr> <tr><td>3-5</td><td>FINGER + PAINT</td><td>Preschool - learning through play</td></tr> <tr><td>6-10</td><td>RECESS + BELL</td><td>Elementary - structured learning begins</td></tr> <tr><td>14-18</td><td>PROM + NIGHT</td><td>High school - social milestones</td></tr> <tr><td>18+</td><td>CAP + GOWN</td><td>Graduation - achievement unlocked</td></tr> </table> <p>From finger painting to diploma - the academic journey.</p>`,
                difficulty: 'easy',
                solveTime: '1-2 min'
            },
            // Puzzle 34: Learning to Drive (permit ‚Üí freedom)
            {
                items: [
                    { id: 1, display: 'PERMIT', type: 'text' },
                    { id: 2, display: 'TEST', type: 'text' },
                    { id: 3, display: 'PARKING', type: 'text' },
                    { id: 4, display: 'LOT', type: 'text' },
                    { id: 5, display: 'DRIVING', type: 'text' },
                    { id: 6, display: 'SCHOOL', type: 'text' },
                    { id: 7, display: 'ROAD', type: 'text' },
                    { id: 8, display: 'TRIP', type: 'text' }
                ],
                // PERMIT+TEST (get permit) ‚Üí PARKING+LOT (practice) ‚Üí DRIVING+SCHOOL (lessons) ‚Üí ROAD+TRIP (freedom)
                pairs: [[1, 2], [3, 4], [5, 6], [7, 8]],
                order: [0, 1, 2, 3],
                stackName: 'Learning to Drive',
                explanation: 'PERMIT+TEST (get learners permit) ‚Üí PARKING+LOT (practice basics) ‚Üí DRIVING+SCHOOL (formal lessons) ‚Üí ROAD+TRIP (earned freedom)',
                decoys: ['Travel', 'School', 'DMV'],
                detailedExplanation: `<h4>Driver's License Journey</h4> <table> <tr><th>Stage</th><th>Pair</th><th>Milestone</th></tr> <tr><td>1. Qualify</td><td>PERMIT + TEST</td><td>Pass written exam, get learner's permit</td></tr> <tr><td>2. Practice</td><td>PARKING + LOT</td><td>Learn basics in empty lots</td></tr> <tr><td>3. Lessons</td><td>DRIVING + SCHOOL</td><td>Professional instruction</td></tr> <tr><td>4. Freedom</td><td>ROAD + TRIP</td><td>License earned, independence achieved</td></tr> </table> <p>The rite of passage every teenager dreams of.</p>`,
                difficulty: 'medium',
                solveTime: '2-3 min'
            },
            // Puzzle 35: Poker Night (emoji poker hands)
            {
                items: [
                    { id: 1, display: 'HIGH', type: 'text' },
                    { id: 2, display: 'üÉè', type: 'emoji' },
                    { id: 3, display: '3Ô∏è‚É£', type: 'emoji' },
                    { id: 4, display: 'KIND', type: 'text' },
                    { id: 5, display: 'FULL', type: 'text' },
                    { id: 6, display: 'üè†', type: 'emoji' },
                    { id: 7, display: 'üëë', type: 'emoji' },
                    { id: 8, display: 'FLUSH', type: 'text' }
                ],
                // Poker hands worst to best: High Card ‚Üí Three of a Kind ‚Üí Full House ‚Üí Royal Flush
                // Red herring: üëë+HIGH = "Royal Highness" is very tempting!
                pairs: [[1, 2], [3, 4], [5, 6], [7, 8]],
                order: [0, 1, 2, 3],
                stackName: 'Poker Night',
                explanation: 'HIGH+üÉè (High Card) ‚Üí 3Ô∏è‚É£+KIND (Three of a Kind) ‚Üí FULL+üè† (Full House) ‚Üí üëë+FLUSH (Royal Flush). Worst to best poker hands!',
                decoys: ['Royal Highness', 'Card Games', 'Gambling'],
                detailedExplanation: `<h4>Poker Hand Rankings</h4> <table> <tr><th>Rank</th><th>Pair</th><th>Hand</th></tr> <tr><td>Weakest</td><td>HIGH + üÉè</td><td>High Card - no matching cards</td></tr> <tr><td>Medium</td><td>3Ô∏è‚É£ + KIND</td><td>Three of a Kind - three matching</td></tr> <tr><td>Strong</td><td>FULL + üè†</td><td>Full House - three + pair</td></tr> <tr><td>Best</td><td>üëë + FLUSH</td><td>Royal Flush - unbeatable hand</td></tr> </table> <p>Deadly trap: üëë+HIGH looks like "Royal Highness" but then üÉè+FLUSH isn't a real hand!</p>`,
                difficulty: 'hard',
                solveTime: '3-4 min'
            },
            // Puzzle 36: Falling Asleep (awake ‚Üí deep sleep)
            {
                items: [
                    { id: 1, display: 'NIGHT', type: 'text' },
                    { id: 2, display: 'OWL', type: 'text' },
                    { id: 3, display: 'HEAVY', type: 'text' },
                    { id: 4, display: 'EYELID', type: 'text' },
                    { id: 5, display: 'POWER', type: 'text' },
                    { id: 6, display: 'NAP', type: 'text' },
                    { id: 7, display: 'DEAD', type: 'text' },
                    { id: 8, display: 'SLEEP', type: 'text' }
                ],
                // NIGHT+OWL (staying up late) ‚Üí HEAVY+EYELID (getting sleepy) ‚Üí POWER+NAP (light sleep) ‚Üí DEAD+SLEEP (out cold)
                pairs: [[1, 2], [3, 4], [5, 6], [7, 8]],
                order: [0, 1, 2, 3],
                stackName: 'Falling Asleep',
                explanation: 'NIGHT+OWL (wide awake) ‚Üí HEAVY+EYELID (drowsy) ‚Üí POWER+NAP (dozing) ‚Üí DEAD asleep (unconscious)',
                decoys: ['Birds', 'Body Parts', 'Energy'],
                detailedExplanation: `<h4>Sleep Depth Stages</h4> <table> <tr><th>State</th><th>Pair</th><th>Consciousness</th></tr> <tr><td>1. Alert</td><td>NIGHT + OWL</td><td>Wide awake, staying up late</td></tr> <tr><td>2. Drowsy</td><td>HEAVY + EYELID</td><td>Fighting to stay awake</td></tr> <tr><td>3. Light Sleep</td><td>POWER + NAP</td><td>Dozing, easily awakened</td></tr> <tr><td>4. Deep Sleep</td><td>DEAD + SLEEP</td><td>Completely unconscious</td></tr> </table> <p>The journey from "one more episode" to completely out.</p>`,
                difficulty: 'medium',
                solveTime: '2-3 min'
            },
            // Puzzle 37: Storm Approaching (calm ‚Üí severe)
            {
                items: [
                    { id: 1, display: 'CLEAR', type: 'text' },
                    { id: 2, display: 'SKY', type: 'text' },
                    { id: 3, display: 'WIND', type: 'text' },
                    { id: 4, display: 'GUST', type: 'text' },
                    { id: 5, display: 'THUNDER', type: 'text' },
                    { id: 6, display: 'STORM', type: 'text' },
                    { id: 7, display: 'FLASH', type: 'text' },
                    { id: 8, display: 'FLOOD', type: 'text' }
                ],
                // CLEAR+SKY (fair) ‚Üí WIND+GUST (breezy) ‚Üí THUNDER+STORM (storm) ‚Üí FLASH+FLOOD (severe)
                pairs: [[1, 2], [3, 4], [5, 6], [7, 8]],
                order: [0, 1, 2, 3],
                stackName: 'Storm Approaching',
                explanation: 'CLEAR+SKY (fair weather) ‚Üí WIND+GUST (getting windy) ‚Üí THUNDER+STORM (storm hits) ‚Üí FLASH+FLOOD (severe damage)',
                decoys: ['Weather', 'Nature', 'Disasters'],
                detailedExplanation: `<h4>Weather Progression</h4> <table> <tr><th>Stage</th><th>Pair</th><th>Conditions</th></tr> <tr><td>1. Fair</td><td>CLEAR + SKY</td><td>Beautiful day, no clouds</td></tr> <tr><td>2. Changing</td><td>WIND + GUST</td><td>Breeze picks up</td></tr> <tr><td>3. Storm</td><td>THUNDER + STORM</td><td>Full storm arrives</td></tr> <tr><td>4. Severe</td><td>FLASH + FLOOD</td><td>Dangerous conditions</td></tr> </table> <p>How quickly weather can change from pleasant to dangerous.</p>`,
                difficulty: 'easy',
                solveTime: '1-2 min'
            },
            // Puzzle 38: Building Height (ground ‚Üí sky)
            {
                items: [
                    { id: 1, display: 'GROUND', type: 'text' },
                    { id: 2, display: 'FLOOR', type: 'text' },
                    { id: 3, display: 'SECOND', type: 'text' },
                    { id: 4, display: 'STORY', type: 'text' },
                    { id: 5, display: 'PENT', type: 'text' },
                    { id: 6, display: 'HOUSE', type: 'text' },
                    { id: 7, display: 'ROOF', type: 'text' },
                    { id: 8, display: 'TOP', type: 'text' }
                ],
                // GROUND+FLOOR (bottom) ‚Üí SECOND+STORY (middle) ‚Üí PENT+HOUSE (high) ‚Üí ROOF+TOP (highest)
                pairs: [[1, 2], [3, 4], [5, 6], [7, 8]],
                order: [0, 1, 2, 3],
                stackName: 'Building Height',
                explanation: 'GROUND+FLOOR (street level) ‚Üí SECOND+STORY (above) ‚Üí PENT+HOUSE (top floor) ‚Üí ROOF+TOP (very top)',
                decoys: ['Real Estate', 'Construction', 'Architecture'],
                detailedExplanation: `<h4>Vertical Position in Building</h4> <table> <tr><th>Height</th><th>Pair</th><th>Location</th></tr> <tr><td>1. Street</td><td>GROUND + FLOOR</td><td>Entry level, lobby</td></tr> <tr><td>2. Low</td><td>SECOND + STORY</td><td>One floor up</td></tr> <tr><td>3. High</td><td>PENT + HOUSE</td><td>Top floor luxury unit</td></tr> <tr><td>4. Highest</td><td>ROOF + TOP</td><td>Above the penthouse</td></tr> </table> <p>From street level to the sky.</p>`,
                difficulty: 'medium',
                solveTime: '2 min'
            },
            // Puzzle 39: Acid Test (pH scale)
            {
                items: [
                    { id: 1, display: 'BATTERY', type: 'text' },
                    { id: 2, display: 'ACID', type: 'text' },
                    { id: 3, display: 'LEMON', type: 'text' },
                    { id: 4, display: 'DROP', type: 'text' },
                    { id: 5, display: 'PURE', type: 'text' },
                    { id: 6, display: 'WATER', type: 'text' },
                    { id: 7, display: 'DRAIN', type: 'text' },
                    { id: 8, display: 'CLEANER', type: 'text' }
                ],
                // pH scale: acidic (low) ‚Üí basic (high)
                // Red herring: ACID+DROP (British candy), LEMON+CLEANER, WATER+DRAIN
                pairs: [[1, 2], [3, 4], [5, 6], [7, 8]],
                order: [0, 1, 2, 3],
                stackName: 'Acid Test',
                explanation: 'BATTERY+ACID (pH~1) ‚Üí LEMON+DROP (pH~2) ‚Üí PURE+WATER (pH 7) ‚Üí DRAIN+CLEANER (pH~14). Acidic to basic!',
                decoys: ['Acid Drop', 'Lemon Cleaner', 'Chemistry'],
                detailedExplanation: `<h4>The pH Scale</h4> <table> <tr><th>pH</th><th>Pair</th><th>Substance</th></tr> <tr><td>~1 (Very Acidic)</td><td>BATTERY + ACID</td><td>Sulfuric acid in car batteries</td></tr> <tr><td>~2 (Acidic)</td><td>LEMON + DROP</td><td>Citrus candy, lemon juice</td></tr> <tr><td>7 (Neutral)</td><td>PURE + WATER</td><td>Distilled water is perfectly neutral</td></tr> <tr><td>~14 (Very Basic)</td><td>DRAIN + CLEANER</td><td>Lye-based cleaners are extremely basic</td></tr> </table> <p>Deadly trap: ACID+DROP is a real British hard candy! But that leaves BATTERY+LEMON which doesn't work.</p>`,
                difficulty: 'hard',
                solveTime: '3-4 min'
            },
            // Puzzle 40: Becoming Rich (broke ‚Üí wealthy)
            {
                items: [
                    { id: 1, display: 'FLAT', type: 'text' },
                    { id: 2, display: 'BROKE', type: 'text' },
                    { id: 3, display: 'SIDE', type: 'text' },
                    { id: 4, display: 'HUSTLE', type: 'text' },
                    { id: 5, display: 'NEST', type: 'text' },
                    { id: 6, display: 'EGG', type: 'text' },
                    { id: 7, display: 'MONEY', type: 'text' },
                    { id: 8, display: 'BAGS', type: 'text' }
                ],
                // FLAT+BROKE (poor) ‚Üí SIDE+HUSTLE (earning) ‚Üí NEST+EGG (saving) ‚Üí MONEY+BAGS (rich)
                pairs: [[1, 2], [3, 4], [5, 6], [7, 8]],
                order: [0, 1, 2, 3],
                stackName: 'Becoming Rich',
                explanation: 'FLAT+BROKE (no money) ‚Üí SIDE+HUSTLE (extra income) ‚Üí NEST+EGG (savings) ‚Üí MONEY+BAGS (wealthy)',
                decoys: ['Housing', 'Birds', 'Shopping'],
                detailedExplanation: `<h4>Wealth Building Stages</h4> <table> <tr><th>Status</th><th>Pair</th><th>Financial State</th></tr> <tr><td>1. Broke</td><td>FLAT + BROKE</td><td>No money at all</td></tr> <tr><td>2. Hustle</td><td>SIDE + HUSTLE</td><td>Working extra to earn more</td></tr> <tr><td>3. Saving</td><td>NEST + EGG</td><td>Building up savings</td></tr> <tr><td>4. Wealthy</td><td>MONEY + BAGS</td><td>More than you need</td></tr> </table> <p>The grind from nothing to abundance.</p>`,
                difficulty: 'medium',
                solveTime: '2 min'
            },
            // Puzzle 41: Throwing a Party (planning ‚Üí aftermath)
            {
                items: [
                    { id: 1, display: 'GUEST', type: 'text' },
                    { id: 2, display: 'LIST', type: 'text' },
                    { id: 3, display: 'PARTY', type: 'text' },
                    { id: 4, display: 'FAVOR', type: 'text' },
                    { id: 5, display: 'DANCE', type: 'text' },
                    { id: 6, display: 'FLOOR', type: 'text' },
                    { id: 7, display: 'CLEAN', type: 'text' },
                    { id: 8, display: 'UP', type: 'text' }
                ],
                // GUEST+LIST (plan) ‚Üí PARTY+FAVOR (prepare) ‚Üí DANCE+FLOOR (party) ‚Üí CLEAN+UP (after)
                pairs: [[1, 2], [3, 4], [5, 6], [7, 8]],
                order: [0, 1, 2, 3],
                stackName: 'Throwing a Party',
                explanation: 'GUEST+LIST (planning) ‚Üí PARTY+FAVOR (preparing) ‚Üí DANCE+FLOOR (partying) ‚Üí CLEAN+UP (aftermath)',
                decoys: ['Events', 'Supplies', 'Chores'],
                detailedExplanation: `<h4>Party Planning Timeline</h4> <table> <tr><th>Phase</th><th>Pair</th><th>Task</th></tr> <tr><td>1. Plan</td><td>GUEST + LIST</td><td>Decide who to invite</td></tr> <tr><td>2. Prepare</td><td>PARTY + FAVOR</td><td>Get supplies and gifts</td></tr> <tr><td>3. Party</td><td>DANCE + FLOOR</td><td>The main event!</td></tr> <tr><td>4. After</td><td>CLEAN + UP</td><td>The not-so-fun part</td></tr> </table> <p>Every great party has the same before and after.</p>`,
                difficulty: 'easy',
                solveTime: '1-2 min'
            },
            // Puzzle 42: Morning Workout (start ‚Üí finish)
            {
                items: [
                    { id: 1, display: 'WARM', type: 'text' },
                    { id: 2, display: 'UP', type: 'text' },
                    { id: 3, display: 'HEART', type: 'text' },
                    { id: 4, display: 'RATE', type: 'text' },
                    { id: 5, display: 'SWEAT', type: 'text' },
                    { id: 6, display: 'SHOP', type: 'text' },
                    { id: 7, display: 'COOL', type: 'text' },
                    { id: 8, display: 'DOWN', type: 'text' }
                ],
                // WARM+UP (stretch) ‚Üí HEART+RATE (cardio) ‚Üí SWEAT+SHOP (intense) ‚Üí COOL+DOWN (end)
                pairs: [[1, 2], [3, 4], [5, 6], [7, 8]],
                order: [0, 1, 2, 3],
                stackName: 'Morning Workout',
                explanation: 'WARM+UP (stretch first) ‚Üí HEART+RATE (cardio starts) ‚Üí SWEAT+SHOP (peak intensity) ‚Üí COOL+DOWN (recover)',
                decoys: ['Temperature', 'Medical', 'Shopping'],
                detailedExplanation: `<h4>Exercise Session</h4> <table> <tr><th>Phase</th><th>Pair</th><th>Activity</th></tr> <tr><td>1. Prepare</td><td>WARM + UP</td><td>Light stretching, get blood flowing</td></tr> <tr><td>2. Cardio</td><td>HEART + RATE</td><td>Elevated heart rate exercise</td></tr> <tr><td>3. Peak</td><td>SWEAT + SHOP</td><td>Maximum intensity</td></tr> <tr><td>4. Recover</td><td>COOL + DOWN</td><td>Slow down, stretch, breathe</td></tr> </table> <p>Never skip the warm-up or cool-down!</p>`,
                difficulty: 'medium',
                solveTime: '2-3 min'
            },
            // Puzzle 43: Wind Scale (Beaufort scale)
            {
                items: [
                    { id: 1, display: 'GLASS', type: 'text' },
                    { id: 2, display: 'LAKE', type: 'text' },
                    { id: 3, display: 'KITE', type: 'text' },
                    { id: 4, display: 'SURF', type: 'text' },
                    { id: 5, display: 'WIND', type: 'text' },
                    { id: 6, display: 'FARM', type: 'text' },
                    { id: 7, display: 'STORM', type: 'text' },
                    { id: 8, display: 'CHASE', type: 'text' }
                ],
                // Beaufort scale: calm ‚Üí hurricane
                // Red herring: WIND+SURF (windsurfing) is MORE famous than kitesurfing!
                pairs: [[1, 2], [3, 4], [5, 6], [7, 8]],
                order: [0, 1, 2, 3],
                stackName: 'Wind Scale',
                explanation: 'GLASS+LAKE (dead calm) ‚Üí KITE+SURF (light breeze) ‚Üí WIND+FARM (strong wind) ‚Üí STORM+CHASE (severe). Beaufort wind scale!',
                decoys: ['Windsurfing', 'Weather', 'Sports'],
                detailedExplanation: `<h4>Beaufort Wind Scale</h4> <table> <tr><th>Force</th><th>Pair</th><th>Conditions</th></tr> <tr><td>0 - Calm</td><td>GLASS + LAKE</td><td>Mirror-like water, no wind</td></tr> <tr><td>3-4 - Light</td><td>KITE + SURF</td><td>Enough wind for kitesurfing</td></tr> <tr><td>6-7 - Strong</td><td>WIND + FARM</td><td>Optimal for wind turbines</td></tr> <tr><td>10+ - Severe</td><td>STORM + CHASE</td><td>Tornado hunters pursue severe weather</td></tr> </table> <p>Deadly trap: WIND+SURF (windsurfing) is more famous than kitesurfing! But that leaves KITE+FARM which makes no sense.</p>`,
                difficulty: 'hard',
                solveTime: '4-5 min'
            },
            // Puzzle 44: Morning Coffee (waking up ‚Üí alert)
            {
                items: [
                    { id: 1, display: 'SNOOZE', type: 'text' },
                    { id: 2, display: 'BUTTON', type: 'text' },
                    { id: 3, display: 'FRENCH', type: 'text' },
                    { id: 4, display: 'PRESS', type: 'text' },
                    { id: 5, display: 'COFFEE', type: 'text' },
                    { id: 6, display: 'BREAK', type: 'text' },
                    { id: 7, display: 'WIDE', type: 'text' },
                    { id: 8, display: 'AWAKE', type: 'text' }
                ],
                // SNOOZE+BUTTON (still sleepy) ‚Üí FRENCH+PRESS (make coffee) ‚Üí COFFEE+BREAK (drink it) ‚Üí WIDE+AWAKE (alert)
                pairs: [[1, 2], [3, 4], [5, 6], [7, 8]],
                order: [0, 1, 2, 3],
                stackName: 'Morning Coffee',
                explanation: 'SNOOZE+BUTTON (groggy) ‚Üí FRENCH+PRESS (brew coffee) ‚Üí COFFEE+BREAK (drinking) ‚Üí WIDE+AWAKE (fully alert)',
                decoys: ['Alarm', 'Cooking', 'Exercise'],
                detailedExplanation: `<h4>Caffeine Activation</h4> <table> <tr><th>State</th><th>Pair</th><th>Alertness</th></tr> <tr><td>1. Groggy</td><td>SNOOZE + BUTTON</td><td>Still half asleep</td></tr> <tr><td>2. Brewing</td><td>FRENCH + PRESS</td><td>Making the coffee</td></tr> <tr><td>3. Drinking</td><td>COFFEE + BREAK</td><td>Consuming caffeine</td></tr> <tr><td>4. Alert</td><td>WIDE + AWAKE</td><td>Fully functional human</td></tr> </table> <p>The transformation from zombie to person.</p>`,
                difficulty: 'easy',
                solveTime: '1-2 min'
            },
            // Puzzle 45: Having a Baby (conception ‚Üí birth)
            {
                items: [
                    { id: 1, display: 'DUE', type: 'text' },
                    { id: 2, display: 'DATE', type: 'text' },
                    { id: 3, display: 'BABY', type: 'text' },
                    { id: 4, display: 'BUMP', type: 'text' },
                    { id: 5, display: 'WATER', type: 'text' },
                    { id: 6, display: 'BREAK', type: 'text' },
                    { id: 7, display: 'BIRTH', type: 'text' },
                    { id: 8, display: 'DAY', type: 'text' }
                ],
                // DUE+DATE (learn pregnant) ‚Üí BABY+BUMP (showing) ‚Üí WATER+BREAK (labor starts) ‚Üí BIRTH+DAY (baby born)
                pairs: [[1, 2], [3, 4], [5, 6], [7, 8]],
                order: [0, 1, 2, 3],
                stackName: 'Having a Baby',
                explanation: 'DUE+DATE (doctor visit) ‚Üí BABY+BUMP (visible pregnancy) ‚Üí WATER+BREAK (labor begins) ‚Üí BIRTH+DAY (baby arrives)',
                decoys: ['Calendar', 'Party', 'Swimming'],
                detailedExplanation: `<h4>Pregnancy Journey</h4> <table> <tr><th>Stage</th><th>Pair</th><th>Milestone</th></tr> <tr><td>1. Confirm</td><td>DUE + DATE</td><td>Doctor confirms pregnancy</td></tr> <tr><td>2. Show</td><td>BABY + BUMP</td><td>Pregnancy becomes visible</td></tr> <tr><td>3. Labor</td><td>WATER + BREAK</td><td>Contractions begin</td></tr> <tr><td>4. Birth</td><td>BIRTH + DAY</td><td>Baby arrives!</td></tr> </table> <p>The nine-month journey to parenthood.</p>`,
                difficulty: 'easy',
                solveTime: '1-2 min'
            },
            // Puzzle 46: Fine Dining (dress up ‚Üí satisfaction)
            {
                items: [
                    { id: 1, display: 'BLACK', type: 'text' },
                    { id: 2, display: 'TIE', type: 'text' },
                    { id: 3, display: 'WHITE', type: 'text' },
                    { id: 4, display: 'LINEN', type: 'text' },
                    { id: 5, display: 'RICH', type: 'text' },
                    { id: 6, display: 'TASTE', type: 'text' },
                    { id: 7, display: 'FULL', type: 'text' },
                    { id: 8, display: 'STOP', type: 'text' }
                ],
                // BLACK+TIE (formal attire) ‚Üí WHITE+LINEN (tablecloth) ‚Üí RICH+TASTE (indulge) ‚Üí FULL+STOP (satisfied)
                // Red herring: BLACK+WHITE (movie/photo style) - very tempting!
                pairs: [[1, 2], [3, 4], [5, 6], [7, 8]],
                order: [0, 1, 2, 3],
                stackName: 'Fine Dining',
                explanation: 'BLACK+TIE (dress formally) ‚Üí WHITE+LINEN (elegant table) ‚Üí RICH+TASTE (savory flavors) ‚Üí FULL+STOP (completely satisfied)',
                decoys: ['Black and White', 'Photography', 'Movies'],
                detailedExplanation: `<h4>Fine Dining Experience</h4> <table> <tr><th>Stage</th><th>Pair</th><th>Meaning</th></tr> <tr><td>1. Dress Up</td><td>BLACK + TIE</td><td>Formal black-tie attire</td></tr> <tr><td>2. Seated</td><td>WHITE + LINEN</td><td>Elegant white tablecloth</td></tr> <tr><td>3. Indulge</td><td>RICH + TASTE</td><td>Rich, complex flavors</td></tr> <tr><td>4. Satisfied</td><td>FULL + STOP</td><td>Completely full, done eating</td></tr> </table> <p>Tricky: BLACK+WHITE (photography/film) is tempting, but that orphans TIE!</p>`,
                difficulty: 'medium',
                solveTime: '2-3 min'
            },
            // Puzzle 47: Four Seasons
            {
                items: [
                    { id: 1, display: 'SNOW', type: 'text' },
                    { id: 2, display: 'WHITE', type: 'text' },
                    { id: 3, display: 'RAIN', type: 'text' },
                    { id: 4, display: 'GREEN', type: 'text' },
                    { id: 5, display: 'SKY', type: 'text' },
                    { id: 6, display: 'BLUE', type: 'text' },
                    { id: 7, display: 'DROP', type: 'text' },
                    { id: 8, display: 'BROWN', type: 'text' }
                ],
                // Seasons: Winter ‚Üí Spring ‚Üí Summer ‚Üí Fall
                // Red herring: RAIN+DROP (raindrop) is incredibly common!
                pairs: [[1, 2], [3, 4], [5, 6], [7, 8]],
                order: [0, 1, 2, 3],
                stackName: 'Four Seasons',
                explanation: 'SNOW+WHITE (winter) ‚Üí RAIN+GREEN (spring growth) ‚Üí SKY+BLUE (summer) ‚Üí DROP+BROWN (falling leaves). Seasonal cycle!',
                decoys: ['Raindrop', 'Colors', 'Weather'],
                detailedExplanation: `<h4>The Four Seasons</h4> <table> <tr><th>Season</th><th>Pair</th><th>Why</th></tr> <tr><td>Winter</td><td>SNOW + WHITE</td><td>Snow blankets the ground white</td></tr> <tr><td>Spring</td><td>RAIN + GREEN</td><td>Spring rains bring new green growth</td></tr> <tr><td>Summer</td><td>SKY + BLUE</td><td>Clear blue summer skies</td></tr> <tr><td>Fall</td><td>DROP + BROWN</td><td>Brown leaves drop from trees</td></tr> </table> <p>Deadly trap: RAIN+DROP (raindrop) is such a common word! But that leaves SNOW+GREEN which makes no sense for seasons.</p>`,
                difficulty: 'hard',
                solveTime: '4-5 min'
            },
            // Puzzle 48: Phases of Life (associative pairs)
            {
                items: [
                    { id: 1, display: 'BABY', type: 'text' },
                    { id: 2, display: 'HOSPITAL', type: 'text' },
                    { id: 3, display: 'SCHOOL', type: 'text' },
                    { id: 4, display: 'TEACHER', type: 'text' },
                    { id: 5, display: 'RETIRE', type: 'text' },
                    { id: 6, display: 'GOLF', type: 'text' },
                    { id: 7, display: 'MEMORIAL', type: 'text' },
                    { id: 8, display: 'SPEECH', type: 'text' }
                ],
                // BABY+HOSPITAL=Born, SCHOOL+TEACHER=Grow, RETIRE+GOLF=Decline, MEMORIAL+SPEECH=Die
                pairs: [[1, 2], [3, 4], [5, 6], [7, 8]],
                order: [0, 1, 2, 3],
                stackName: 'Phases of Life',
                explanation: 'BABY+HOSPITAL (born) ‚Üí SCHOOL+TEACHER (grow) ‚Üí RETIRE+GOLF (decline) ‚Üí MEMORIAL+SPEECH (die)',
                decoys: ['Healthcare', 'Education', 'Hobbies'],
                detailedExplanation: `<h4>Human Life Cycle</h4> <table> <tr><th>Phase</th><th>Pair</th><th>Life Stage</th></tr> <tr><td>Born</td><td>BABY + HOSPITAL</td><td>Entering the world</td></tr> <tr><td>Grow</td><td>SCHOOL + TEACHER</td><td>Learning and developing</td></tr> <tr><td>Decline</td><td>RETIRE + GOLF</td><td>Slowing down, enjoying leisure</td></tr> <tr><td>Die</td><td>MEMORIAL + SPEECH</td><td>Being remembered</td></tr> </table> <p>The universal human journey from birth to legacy.</p>`,
                difficulty: 'easy',
                solveTime: '1-2 min'
            },
            // Puzzle 49: Bug's Life (metamorphosis)
            {
                items: [
                    { id: 1, display: 'TINY', type: 'text' },
                    { id: 2, display: 'EGG', type: 'text' },
                    { id: 3, display: 'HUNGRY', type: 'text' },
                    { id: 4, display: 'WORM', type: 'text' },
                    { id: 5, display: 'SILK', type: 'text' },
                    { id: 6, display: 'WRAP', type: 'text' },
                    { id: 7, display: 'SPREAD', type: 'text' },
                    { id: 8, display: 'WING', type: 'text' }
                ],
                // Metamorphosis: Egg ‚Üí Larva ‚Üí Pupa ‚Üí Adult
                // Red herring: SILK+WORM (silkworm) is a common word!
                pairs: [[1, 2], [3, 4], [5, 6], [7, 8]],
                order: [0, 1, 2, 3],
                stackName: "Bug's Life",
                explanation: 'TINY+EGG (egg) ‚Üí HUNGRY+WORM (caterpillar) ‚Üí SILK+WRAP (cocoon) ‚Üí SPREAD+WING (butterfly). Complete metamorphosis!',
                decoys: ['Silkworm', 'Insects', 'Nature'],
                detailedExplanation: `<h4>Complete Metamorphosis</h4> <table> <tr><th>Stage</th><th>Pair</th><th>What Happens</th></tr> <tr><td>1. Egg</td><td>TINY + EGG</td><td>Life begins as a tiny egg</td></tr> <tr><td>2. Larva</td><td>HUNGRY + WORM</td><td>Caterpillar eats constantly to grow</td></tr> <tr><td>3. Pupa</td><td>SILK + WRAP</td><td>Wraps itself in silk cocoon</td></tr> <tr><td>4. Adult</td><td>SPREAD + WING</td><td>Emerges as butterfly, spreads wings</td></tr> </table> <p>Deadly trap: SILK+WORM (silkworm) is such a common word! But that leaves HUNGRY+WRAP which makes no sense.</p>`,
                difficulty: 'hard',
                solveTime: '3-4 min'
            },
            // Puzzle 50: Half Life (radioactive decay chain)
            {
                items: [
                    { id: 1, display: 'YELLOW', type: 'text' },
                    { id: 2, display: 'CAKE', type: 'text' },
                    { id: 3, display: 'WATCH', type: 'text' },
                    { id: 4, display: 'DIAL', type: 'text' },
                    { id: 5, display: 'BASEMENT', type: 'text' },
                    { id: 6, display: 'GAS', type: 'text' },
                    { id: 7, display: 'PIPE', type: 'text' },
                    { id: 8, display: 'LEAD', type: 'text' }
                ],
                // Decay chain: Uranium ‚Üí Radium ‚Üí Radon ‚Üí Lead
                // Red herring: LEAD+PIPE (Clue board game weapon!)
                pairs: [[1, 2], [3, 4], [5, 6], [7, 8]],
                order: [0, 1, 2, 3],
                stackName: 'Half Life',
                explanation: 'YELLOW+CAKE (uranium ore) ‚Üí WATCH+DIAL (radium paint) ‚Üí BASEMENT+GAS (radon) ‚Üí PIPE+LEAD (stable lead). Radioactive decay chain!',
                decoys: ['Lead Pipe', 'Clue Game', 'Nuclear'],
                detailedExplanation: `<h4>Radioactive Decay Chain</h4> <table> <tr><th>Element</th><th>Pair</th><th>Connection</th></tr> <tr><td>Uranium</td><td>YELLOW + CAKE</td><td>"Yellowcake" is processed uranium ore</td></tr> <tr><td>Radium</td><td>WATCH + DIAL</td><td>Old watches used radium paint to glow</td></tr> <tr><td>Radon</td><td>BASEMENT + GAS</td><td>Radon gas accumulates in basements</td></tr> <tr><td>Lead</td><td>PIPE + LEAD</td><td>Lead is the stable end of the decay chain</td></tr> </table> <p>Deadly trap: LEAD+PIPE is the murder weapon from Clue! But that leaves BASEMENT+WATCH which doesn't fit the chain.</p>`,
                difficulty: 'hard',
                solveTime: '4-5 min'
            },
            // Puzzle 51: Stellar Ending (death of a star)
            {
                items: [
                    { id: 1, display: 'SPACE', type: 'text' },
                    { id: 2, display: 'DUST', type: 'text' },
                    { id: 3, display: 'BURN', type: 'text' },
                    { id: 4, display: 'BRIGHT', type: 'text' },
                    { id: 5, display: 'SWELL', type: 'text' },
                    { id: 6, display: 'RED', type: 'text' },
                    { id: 7, display: 'COOL', type: 'text' },
                    { id: 8, display: 'DOWN', type: 'text' }
                ],
                // Star lifecycle: Nebula ‚Üí Main Sequence ‚Üí Red Giant ‚Üí White Dwarf
                // Red herring: BURN+DOWN (burn down a building)
                pairs: [[1, 2], [3, 4], [5, 6], [7, 8]],
                order: [0, 1, 2, 3],
                stackName: 'Stellar Ending',
                explanation: 'SPACE+DUST (nebula) ‚Üí BURN+BRIGHT (fusion) ‚Üí SWELL+RED (red giant) ‚Üí COOL+DOWN (white dwarf). Life and death of a star!',
                decoys: ['Burn Down', 'Fire', 'Astronomy'],
                detailedExplanation: `<h4>Life Cycle of a Star</h4> <table> <tr><th>Phase</th><th>Pair</th><th>What Happens</th></tr> <tr><td>Birth</td><td>SPACE + DUST</td><td>Stars form from cosmic dust clouds</td></tr> <tr><td>Main Sequence</td><td>BURN + BRIGHT</td><td>Hydrogen fusion makes the star shine</td></tr> <tr><td>Red Giant</td><td>SWELL + RED</td><td>Star expands and cools to red</td></tr> <tr><td>White Dwarf</td><td>COOL + DOWN</td><td>Remnant slowly cools forever</td></tr> </table> <p>Deadly trap: BURN+DOWN sounds like setting fire to something! But that leaves SPACE+BRIGHT which doesn't fit stellar evolution.</p>`,
                difficulty: 'hard',
                solveTime: '4-5 min'
            },
            // Puzzle 52: Gotta Catch 'Em All (Pokemon journey)
            {
                items: [
                    { id: 1, display: 'POKE', type: 'text' },
                    { id: 2, display: 'BALL', type: 'text' },
                    { id: 3, display: 'RARE', type: 'text' },
                    { id: 4, display: 'CATCH', type: 'text' },
                    { id: 5, display: 'GYM', type: 'text' },
                    { id: 6, display: 'BADGE', type: 'text' },
                    { id: 7, display: 'LEAGUE', type: 'text' },
                    { id: 8, display: 'CHAMPION', type: 'text' }
                ],
                // Pokemon journey: Get balls ‚Üí Catch ‚Üí Badges ‚Üí Champion
                // Red herring: CHAMPION+LEAGUE (UEFA soccer!)
                pairs: [[1, 2], [3, 4], [5, 6], [7, 8]],
                order: [0, 1, 2, 3],
                stackName: "Gotta Catch 'Em All",
                explanation: 'POKE+BALL (equipment) ‚Üí RARE+CATCH (catch Pokemon) ‚Üí GYM+BADGE (train) ‚Üí LEAGUE+CHAMPION (victory). Pokemon trainer journey!',
                decoys: ['Champions League', 'Soccer', 'Sports'],
                detailedExplanation: `<h4>Pokemon Trainer Journey</h4> <table> <tr><th>Stage</th><th>Pair</th><th>What Happens</th></tr> <tr><td>1. Start</td><td>POKE + BALL</td><td>Get your Pokeballs from Professor</td></tr> <tr><td>2. Hunt</td><td>RARE + CATCH</td><td>Catch rare Pokemon in the wild</td></tr> <tr><td>3. Train</td><td>GYM + BADGE</td><td>Defeat gym leaders, earn badges</td></tr> <tr><td>4. Victory</td><td>LEAGUE + CHAMPION</td><td>Beat the Elite Four, become Champion</td></tr> </table> <p>Deadly trap: CHAMPION+LEAGUE is UEFA Champions League soccer! But that leaves RARE+BADGE and GYM+CATCH which don't work.</p>`,
                difficulty: 'hard',
                solveTime: '3-4 min'
            }
        ];

        // ============ GAME STATE ============
        let currentPuzzle = null;
        let currentPuzzleNumber = 0; // Puzzle number for share text
        let selectedItems = []; // Items selected from pool
        let selectedSlot = null; // Rung slot selected for removal
        let stack = [null, null, null, null]; // 4 slots, bottom to top
        let attemptsUsed = 0;
        let gameOver = false;
        let gameWon = false;
        let gameMode = localStorage.getItem('rungsMode') || 'easy';
        let hintRevealed = false;
        let showIntroOnStart = localStorage.getItem('rungsShowIntro') !== 'false';
        let tutorialCompleted = localStorage.getItem('rungsTutorialDone') === 'true';
        let isTutorialMode = false;
        let skipIntroAfterTutorial = false;
        
        // ============ SOUND MANAGER ============
        let soundEnabled = localStorage.getItem('rungsSound') !== 'false';
        
        // Plain Mode - defaults to ON for first run (free tier)
        if (localStorage.getItem('rungsPlainMode') === null) {
            localStorage.setItem('rungsPlainMode', 'true');
        }
        let plainMode = localStorage.getItem('rungsPlainMode') === 'true';
        let audioContext = null;
        
        // v1.0.9: Save/restore in-progress game state to survive page reloads
        function saveGameState() {
            if (isPracticeMode || isTutorialMode || gameOver) return;
            
            const today = getTodayString();
            const state = {
                date: today,
                stack: stack,
                attemptsUsed: attemptsUsed,
                hintRevealed: hintRevealed,
                // Track which items are stacked (by their IDs)
                stackedItems: []
            };
            
            // Collect stacked item IDs
            document.querySelectorAll('.item.stacked').forEach(el => {
                state.stackedItems.push(parseInt(el.dataset.id));
            });
            
            try {
                localStorage.setItem('rungsGameState', JSON.stringify(state));
            } catch (e) {
                console.error('Error saving game state:', e);
            }
        }
        
        function loadGameState() {
            try {
                const saved = localStorage.getItem('rungsGameState');
                if (!saved) return null;
                
                const state = JSON.parse(saved);
                const today = getTodayString();
                
                // Only restore if it's from today and game not finished
                if (state.date === today && !hasPlayedToday()) {
                    return state;
                }
                
                // Clear stale state
                localStorage.removeItem('rungsGameState');
                return null;
            } catch (e) {
                console.error('Error loading game state:', e);
                return null;
            }
        }
        
        function restoreGameState(state) {
            console.log('üîÑ Restoring saved game state');
            
            // Restore state variables
            stack = state.stack || [null, null, null, null];
            attemptsUsed = state.attemptsUsed || 0;
            hintRevealed = state.hintRevealed || false;
            
            // Mark stacked items
            (state.stackedItems || []).forEach(id => {
                const itemEl = document.querySelector(`.item[data-id="${id}"]`);
                if (itemEl) {
                    itemEl.classList.add('stacked');
                }
            });
            
            // Update displays
            updateStackDisplay();
            updateAttempts();
            updateButtons();
            updateThemeHint();
        }
        
        function clearGameState() {
            localStorage.removeItem('rungsGameState');
        }
        
        function getAudioContext() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
            if (audioContext.state === 'suspended') {
                audioContext.resume();
            }
            return audioContext;
        }
        
        function playTone(frequency, duration, type = 'sine', volume = 0.3) {
            if (!soundEnabled) return;
            
            try {
                const ctx = getAudioContext();
                const oscillator = ctx.createOscillator();
                const gainNode = ctx.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(ctx.destination);
                
                oscillator.frequency.value = frequency;
                oscillator.type = type;
                
                gainNode.gain.setValueAtTime(volume, ctx.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + duration);
                
                oscillator.start(ctx.currentTime);
                oscillator.stop(ctx.currentTime + duration);
            } catch (e) {
                console.error('Sound error:', e);
            }
        }
        
        function playClickSound() {
            if (!soundEnabled) return;
            playTone(800, 0.08, 'sine', 0.15);
        }
        
        function playDropSound() {
            if (!soundEnabled) return;
            playTone(400, 0.15, 'sine', 0.2);
        }
        
        function playCorrectSound() {
            if (!soundEnabled) return;
            playTone(523.25, 0.12, 'sine', 0.25); // C5
            setTimeout(() => playTone(659.25, 0.12, 'sine', 0.25), 80); // E5
            setTimeout(() => playTone(783.99, 0.2, 'sine', 0.3), 160); // G5
        }
        
        function playIncorrectSound() {
            if (!soundEnabled) return;
            playTone(349.23, 0.2, 'triangle', 0.2); // F4
            setTimeout(() => playTone(293.66, 0.25, 'triangle', 0.15), 150); // D4
        }
        
        function playWinSound() {
            if (!soundEnabled) return;
            playTone(523.25, 0.12, 'sine', 0.25); // C5
            setTimeout(() => playTone(659.25, 0.12, 'sine', 0.25), 100); // E5
            setTimeout(() => playTone(783.99, 0.12, 'sine', 0.25), 200); // G5
            setTimeout(() => playTone(1046.50, 0.35, 'sine', 0.35), 300); // C6
        }
        
        function playLoseSound() {
            if (!soundEnabled) return;
            playTone(392.00, 0.25, 'triangle', 0.2); // G4
            setTimeout(() => playTone(329.63, 0.25, 'triangle', 0.18), 200); // E4
            setTimeout(() => playTone(261.63, 0.4, 'triangle', 0.15), 400); // C4
        }
        
        function toggleSound() {
            soundEnabled = !soundEnabled;
            localStorage.setItem('rungsSound', soundEnabled ? 'true' : 'false');
            updateSoundToggle();
            if (soundEnabled) {
                playTone(440, 0.1, 'sine', 0.2);
            }
        }
        
        function updateSoundToggle() {
            const toggle = document.getElementById('sound-toggle');
            if (toggle) toggle.checked = soundEnabled;
        }
        
        function testSounds() {
            const wasEnabled = soundEnabled;
            soundEnabled = true;
            playCorrectSound();
            setTimeout(() => {
                playIncorrectSound();
                soundEnabled = wasEnabled;
                
                // v1.0.14: Show mute reminder (browsers can't detect hardware mute)
                setTimeout(() => {
                    showMessage('üîá No sound? Check if your device is muted', 'info');
                }, 400);
            }, 600);
        }

        // ============ PLAIN MODE FUNCTIONS ============
        function togglePlainMode() {
            plainMode = document.getElementById('plain-mode-toggle').checked;
            localStorage.setItem('rungsPlainMode', plainMode);
            applyPlainMode();
            
            // If Plain Mode is turned ON while signed in, sign out
            if (plainMode && typeof GSAuth !== 'undefined' && GSAuth.isSignedIn()) {
                GSAuth.signOut();
            }
            
            // Update account section
            if (typeof GSAuth !== 'undefined') {
                GSAuth.updateUI();
            }
        }
        
        function initPlainModeToggle() {
            const toggle = document.getElementById('plain-mode-toggle');
            if (toggle) {
                toggle.checked = plainMode;
            }
        }
        
        function applyPlainMode() {
            if (plainMode) {
                document.body.classList.add('plain-mode');
                const syncIndicator = document.getElementById('sync-indicator');
                if (syncIndicator) syncIndicator.style.display = 'none';
            } else {
                document.body.classList.remove('plain-mode');
            }
        }

        // ============ TUTORIAL FUNCTIONS ============
        function showTutorialChoice() {
            document.getElementById('tutorial-choice-modal').classList.add('active');
        }
        
        function hideTutorialChoice() {
            document.getElementById('tutorial-choice-modal').classList.remove('active');
        }
        
        let currentTutorialStep = 1;
        const totalTutorialSteps = 4;
        
        function startTutorial() {
            hideTutorialChoice();
            isTutorialMode = true;
            currentPuzzle = TUTORIAL_PUZZLE;
            renderPuzzleQuietly();
            
            // Show tutorial walkthrough instead of intro
            currentTutorialStep = 1;
            showTutorialWalkthrough();
        }
        
        function showTutorialWalkthrough() {
            updateTutorialStep();
            document.getElementById('tutorial-walkthrough-modal').classList.add('active');
        }
        
        function hideTutorialWalkthrough() {
            document.getElementById('tutorial-walkthrough-modal').classList.remove('active');
        }
        
        function updateTutorialStep() {
            // Hide all steps
            for (let i = 1; i <= totalTutorialSteps; i++) {
                document.getElementById(`tutorial-step-${i}`).style.display = 'none';
            }
            // Show current step
            document.getElementById(`tutorial-step-${currentTutorialStep}`).style.display = 'block';
            
            // Update step dots
            const dots = document.querySelectorAll('#tutorial-step-indicator .step-dot');
            dots.forEach((dot, i) => {
                dot.classList.remove('active', 'completed');
                if (i + 1 === currentTutorialStep) {
                    dot.classList.add('active');
                } else if (i + 1 < currentTutorialStep) {
                    dot.classList.add('completed');
                }
            });
            
            // Update navigation buttons
            const prevBtn = document.getElementById('tutorial-prev-btn');
            const nextBtn = document.getElementById('tutorial-next-btn');
            
            prevBtn.style.display = currentTutorialStep === 1 ? 'none' : 'block';
            nextBtn.textContent = currentTutorialStep === totalTutorialSteps ? "Let's Play! üéÆ" : 'Next ‚Üí';
        }
        
        function nextTutorialStep() {
            if (currentTutorialStep < totalTutorialSteps) {
                currentTutorialStep++;
                updateTutorialStep();
            } else {
                // End of walkthrough - start playing (skip intro since we just did the tutorial)
                skipIntroAfterTutorial = true;
                hideTutorialWalkthrough();
            }
        }
        
        function prevTutorialStep() {
            if (currentTutorialStep > 1) {
                currentTutorialStep--;
                updateTutorialStep();
            }
        }
        
        function exitTutorialWalkthrough() {
            // Skip intro since user chose to exit tutorial early
            skipIntroAfterTutorial = true;
            hideTutorialWalkthrough();
            // Stay in tutorial mode with the tutorial puzzle loaded
        }
        
        function replayTutorial() {
            closeMenu();
            isTutorialMode = true;
            currentPuzzle = TUTORIAL_PUZZLE;
            renderPuzzleQuietly();
            
            // Show walkthrough
            currentTutorialStep = 1;
            showTutorialWalkthrough();
        }
        
        function resetTutorialState() {
            localStorage.removeItem('rungsTutorialDone');
            tutorialCompleted = false;
            closeMenu();
            alert('Tutorial state reset! Refresh the page to see the first-time experience.');
        }
        
        function skipTutorial() {
            hideTutorialChoice();
            tutorialCompleted = true;
            localStorage.setItem('rungsTutorialDone', 'true');
            isTutorialMode = false;
            currentPuzzle = getDailyPuzzle();
            
            // User said they've played before - skip intro & disable for future
            showIntroOnStart = false;
            localStorage.setItem('rungsShowIntro', 'false');
            skipIntroAfterTutorial = true; // Extra safeguard to prevent intro
            
            renderPuzzleQuietly();
        }
        
        function completeTutorial() {
            tutorialCompleted = true;
            localStorage.setItem('rungsTutorialDone', 'true');
            isTutorialMode = false;
        }
        
        function showPostTutorialPrompt() {
            // Show a prompt to play the daily puzzle
            const modal = document.getElementById('result-modal');
            const content = modal.querySelector('.modal-content');
            
            // Add "Play Daily Puzzle" button if not already there
            if (!document.getElementById('play-daily-btn')) {
                const btn = document.createElement('button');
                btn.id = 'play-daily-btn';
                btn.className = 'btn btn-primary';
                btn.style.cssText = 'margin-top: 15px; width: 100%;';
                btn.innerHTML = 'üéØ Now try today\'s puzzle!';
                btn.onclick = () => {
                    closeResultModal();
                    currentPuzzle = getDailyPuzzle();
                    renderPuzzle();
                };
                content.appendChild(btn);
            }
        }

        // ============ INTRO FUNCTIONS ============
        function showIntro() {
            document.getElementById('intro-modal').classList.add('active');
            document.getElementById('skip-intro-checkbox').checked = false;
        }

        function closeIntro() {
            document.getElementById('intro-modal').classList.remove('active');
            
            if (document.getElementById('skip-intro-checkbox').checked) {
                showIntroOnStart = false;
                localStorage.setItem('rungsShowIntro', 'false');
                updateIntroToggle();
            }
        }

        function toggleIntroSetting() {
            showIntroOnStart = document.getElementById('intro-toggle').checked;
            localStorage.setItem('rungsShowIntro', showIntroOnStart ? 'true' : 'false');
        }

        function updateIntroToggle() {
            const toggle = document.getElementById('intro-toggle');
            if (toggle) {
                toggle.checked = showIntroOnStart;
            }
        }

        // ============ MODE FUNCTIONS ============
        function toggleHardMode() {
            const isHard = document.getElementById('hard-mode-toggle').checked;
            gameMode = isHard ? 'hard' : 'easy';
            localStorage.setItem('rungsMode', gameMode);
            updateThemeHint();
        }

        function updateModeUI() {
            const toggle = document.getElementById('hard-mode-toggle');
            if (toggle) {
                toggle.checked = gameMode === 'hard';
            }
        }

        function updateThemeHint() {
            const subtitle = document.getElementById('subtitle');
            
            if (!currentPuzzle) return;
            
            const defaultText = 'Pair the words. Climb the rungs.';
            const hintText = `Theme: ${currentPuzzle.stackName}`;
            
            if (gameMode === 'hard') {
                // Hard mode: never show hint
                subtitle.textContent = defaultText;
                subtitle.classList.remove('hint-revealed');
            } else if (gameMode === 'easy') {
                // Easy mode: show after 2 failed attempts
                if (attemptsUsed >= 2 && !gameOver) {
                    subtitle.textContent = hintText;
                    if (!hintRevealed) {
                        subtitle.classList.add('hint-revealed');
                        hintRevealed = true;
                        showMessage('Hint revealed!', 'success');
                    }
                } else {
                    subtitle.textContent = defaultText;
                    subtitle.classList.remove('hint-revealed');
                }
            }
        }

        // ============ MENU FUNCTIONS ============
        let countdownInterval = null;
        
        function updateCountdownDisplay() {
            const { hours, minutes } = getTimeUntilNextPuzzle();
            const display = document.getElementById('countdown-timer');
            if (display) {
                display.textContent = `${hours}h ${minutes}m`;
            }
        }
        
        function openMenu() {
            updateStatsDisplay();
            updateModeUI();
            updateIntroToggle();
            updateSoundToggle();
            updateCountdownDisplay();
            
            // Update version display
            const versionEl = document.getElementById('version-display');
            if (versionEl) versionEl.textContent = VERSION;
            
            // Update puzzle number
            const puzzleNumEl = document.getElementById('puzzle-number-display');
            if (puzzleNumEl && currentPuzzle) {
                const idx = PUZZLES.indexOf(currentPuzzle);
                puzzleNumEl.textContent = idx >= 0 ? (idx + 1) : '-';
            }
            
            // Start countdown updates
            if (countdownInterval) clearInterval(countdownInterval);
            countdownInterval = setInterval(updateCountdownDisplay, 60000); // Update every minute
            
            document.getElementById('menu-modal').classList.add('active');
        }

        function closeMenu() {
            document.getElementById('menu-modal').classList.remove('active');
            if (countdownInterval) {
                clearInterval(countdownInterval);
                countdownInterval = null;
            }
        }

        // ============ PRACTICE MODE ============
        let isPracticeMode = false;
        let practiceDate = null;
        let currentPickerMonth = new Date();
        
        function getPracticeStats() {
            try {
                const stats = localStorage.getItem('rungsPracticeStats');
                if (stats) return JSON.parse(stats);
            } catch (e) {
                console.error('Error reading practice stats:', e);
            }
            return { played: 0, won: 0, history: {} };
        }
        
        function savePracticeStats(stats) {
            try {
                localStorage.setItem('rungsPracticeStats', JSON.stringify(stats));
            } catch (e) {
                console.error('Error saving practice stats:', e);
            }
        }
        
        function openPracticeModal() {
            closeMenu();
            currentPickerMonth = new Date();
            renderDatePicker();
            updatePracticeStatsDisplay();
            document.getElementById('practice-modal').classList.add('active');
        }
        
        function closePracticeModal() {
            document.getElementById('practice-modal').classList.remove('active');
        }
        
        function updatePracticeStatsDisplay() {
            const stats = getPracticeStats();
            document.getElementById('practice-played').textContent = stats.played;
            document.getElementById('practice-won').textContent = stats.won;
            const rate = stats.played > 0 ? Math.round((stats.won / stats.played) * 100) : 0;
            document.getElementById('practice-rate').textContent = rate + '%';
        }
        
        function changeMonth(delta) {
            currentPickerMonth.setMonth(currentPickerMonth.getMonth() + delta);
            renderDatePicker();
        }
        
        function renderDatePicker() {
            const grid = document.getElementById('date-picker-grid');
            const monthLabel = document.getElementById('current-month');
            
            const year = currentPickerMonth.getFullYear();
            const month = currentPickerMonth.getMonth();
            
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                               'July', 'August', 'September', 'October', 'November', 'December'];
            monthLabel.textContent = `${monthNames[month]} ${year}`;
            
            // Clear existing day cells (keep header labels)
            const dayLabels = grid.querySelectorAll('.day-label');
            grid.innerHTML = '';
            dayLabels.forEach(label => grid.appendChild(label.cloneNode(true)));
            
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            const practiceStats = getPracticeStats();
            
            // Add empty cells for days before first of month
            for (let i = 0; i < firstDay.getDay(); i++) {
                const empty = document.createElement('div');
                empty.className = 'date-cell disabled';
                grid.appendChild(empty);
            }
            
            // Add day cells
            for (let day = 1; day <= lastDay.getDate(); day++) {
                const dateCell = document.createElement('div');
                dateCell.className = 'date-cell';
                dateCell.textContent = day;
                
                const cellDate = new Date(year, month, day);
                cellDate.setHours(0, 0, 0, 0);
                const dateStr = formatDateString(cellDate);
                
                const launchCopy = new Date(LAUNCH_DATE);
                launchCopy.setHours(0, 0, 0, 0);
                
                if (cellDate < launchCopy) {
                    dateCell.classList.add('disabled');
                } else if (cellDate >= today) {
                    dateCell.classList.add('future');
                    if (cellDate.getTime() === today.getTime()) {
                        dateCell.classList.add('today');
                        dateCell.title = "Play today's puzzle from main screen";
                    }
                } else {
                    // Check if played in practice
                    if (practiceStats.history[dateStr]) {
                        if (practiceStats.history[dateStr].won) {
                            dateCell.classList.add('won');
                        } else {
                            dateCell.classList.add('lost');
                        }
                    }
                    
                    dateCell.onclick = () => startPractice(cellDate);
                    dateCell.style.cursor = 'pointer';
                }
                
                grid.appendChild(dateCell);
            }
            
            // Update nav buttons
            const launchMonth = new Date(LAUNCH_DATE.getFullYear(), LAUNCH_DATE.getMonth(), 1);
            const currentMonth = new Date(year, month, 1);
            const todayMonth = new Date(today.getFullYear(), today.getMonth(), 1);
            
            document.getElementById('prev-month').disabled = currentMonth <= launchMonth;
            document.getElementById('next-month').disabled = currentMonth >= todayMonth;
        }
        
        function formatDateString(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        
        function getPuzzleForDate(date) {
            const dateCopy = new Date(date);
            dateCopy.setHours(0, 0, 0, 0);
            const launchCopy = new Date(LAUNCH_DATE);
            launchCopy.setHours(0, 0, 0, 0);
            const daysSinceLaunch = Math.floor((dateCopy - launchCopy) / (1000 * 60 * 60 * 24));
            return PUZZLES[daysSinceLaunch % PUZZLES.length];
        }
        
        function startPractice(date) {
            isPracticeMode = true;
            practiceDate = date;
            
            closePracticeModal();
            
            // Reset game state
            items = [];
            selectedItems = [];
            pairs = [];
            stack = [null, null, null, null];
            attemptsUsed = 0;
            gameOver = false;
            gameWon = false;
            hintRevealed = false;
            
            // Load puzzle for selected date
            currentPuzzle = getPuzzleForDate(date);
            
            // Update subtitle with practice badge
            const dateStr = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
            const subtitle = document.querySelector('.subtitle');
            if (subtitle) {
                subtitle.innerHTML = `${dateStr} <span class="practice-badge">Practice</span>`;
            }
            
            // Render the puzzle
            renderPuzzle();
        }
        
        function returnToDaily() {
            isPracticeMode = false;
            practiceDate = null;
            
            closePracticeModal();
            
            // Reload daily puzzle
            initGame();
        }
        
        function recordPracticeResult(won) {
            if (!isPracticeMode || !practiceDate) return;
            
            const stats = getPracticeStats();
            const dateStr = formatDateString(practiceDate);
            
            if (!stats.history[dateStr]) {
                stats.played++;
                if (won) stats.won++;
                stats.history[dateStr] = { won: won, date: dateStr };
                savePracticeStats(stats);
            }
        }

        // ============ RESET STATS ============
        function confirmResetStats() {
            document.getElementById('reset-modal').classList.add('active');
        }
        
        function closeResetModal() {
            document.getElementById('reset-modal').classList.remove('active');
        }
        
        function resetStats() {
            localStorage.removeItem('rungsStats');
            localStorage.removeItem('rungsPracticeStats');
            closeResetModal();
            closeMenu();
            showMessage('Statistics reset!', 'success');
            
            // Refresh the page to start fresh
            setTimeout(() => location.reload(), 500);
        }

        // ============ DARK MODE ============
        let darkMode = localStorage.getItem('rungsDarkMode') !== 'false';

        function initDarkMode() {
            if (!darkMode) {
                document.documentElement.setAttribute('data-theme', 'light');
            } else {
                document.documentElement.setAttribute('data-theme', 'dark');
            }
            document.getElementById('dark-mode-toggle').checked = darkMode;
        }

        function toggleDarkMode() {
            darkMode = document.getElementById('dark-mode-toggle').checked;
            localStorage.setItem('rungsDarkMode', darkMode);
            
            if (darkMode) {
                document.documentElement.setAttribute('data-theme', 'dark');
            } else {
                document.documentElement.setAttribute('data-theme', 'light');
            }
        }

        // ============ STATISTICS ============
        function getStats() {
            try {
                const stats = localStorage.getItem('rungsStats');
                if (stats) {
                    return JSON.parse(stats);
                }
            } catch (e) {
                console.error('Error reading stats:', e);
            }
            return {
                gamesPlayed: 0,
                gamesWon: 0,
                currentStreak: 0,
                maxStreak: 0,
                totalAttempts: 0,
                lastPlayedDate: null
            };
        }

        function saveStats(stats) {
            try {
                localStorage.setItem('rungsStats', JSON.stringify(stats));
            } catch (e) {
                console.error('Error saving stats:', e);
            }
        }

        function hasPlayedToday() {
            const stats = getStats();
            const today = getTodayString();
            return stats.lastPlayedDate === today;
        }

        function getTodayResult() {
            try {
                const result = localStorage.getItem('rungsTodayResult');
                if (result) {
                    const parsed = JSON.parse(result);
                    if (parsed.date === getTodayString()) {
                        return parsed;
                    }
                }
            } catch (e) {
                console.error('Error reading today result:', e);
            }
            return null;
        }

        function saveTodayResult(won, attempts, bonusCorrect, shareText) {
            try {
                const result = {
                    date: getTodayString(),
                    won: won,
                    attempts: attempts,
                    bonusCorrect: bonusCorrect,
                    puzzleNumber: currentPuzzleNumber,
                    stackName: currentPuzzle.stackName,
                    shareText: shareText
                };
                localStorage.setItem('rungsTodayResult', JSON.stringify(result));
            } catch (e) {
                console.error('Error saving today result:', e);
            }
        }

        function getTodayString() {
            const now = new Date();
            return `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;
        }

        function updateStats(won, attempts) {
            // Don't count tutorial towards stats
            if (isTutorialMode) {
                return getStats();
            }
            
            // Handle practice mode separately
            if (isPracticeMode) {
                recordPracticeResult(won);
                return getStats();
            }
            
            const stats = getStats();
            const today = getTodayString();
            
            // Only count if not already played today
            if (stats.lastPlayedDate === today) {
                return stats;
            }
            
            stats.gamesPlayed++;
            
            if (won) {
                stats.gamesWon++;
                stats.totalAttempts += attempts;
                
                // Check streak
                if (stats.lastPlayedDate) {
                    const lastDate = new Date(stats.lastPlayedDate);
                    const todayDate = new Date(today);
                    const diffDays = Math.floor((todayDate - lastDate) / (1000 * 60 * 60 * 24));
                    
                    if (diffDays === 1) {
                        stats.currentStreak++;
                    } else {
                        stats.currentStreak = 1;
                    }
                } else {
                    stats.currentStreak = 1;
                }
                
                if (stats.currentStreak > stats.maxStreak) {
                    stats.maxStreak = stats.currentStreak;
                }
            } else {
                stats.currentStreak = 0;
            }
            
            stats.lastPlayedDate = today;
            saveStats(stats);
            return stats;
        }

        function updateStatsDisplay() {
            const stats = getStats();
            
            document.getElementById('current-streak').textContent = stats.currentStreak;
            document.getElementById('max-streak').textContent = stats.maxStreak;
            document.getElementById('games-played').textContent = stats.gamesPlayed;
            document.getElementById('games-won').textContent = stats.gamesWon;
            
            const winRate = stats.gamesPlayed > 0 
                ? Math.round((stats.gamesWon / stats.gamesPlayed) * 100) 
                : 0;
            document.getElementById('win-rate').textContent = winRate + '%';
            
            const avgAttempts = stats.gamesWon > 0 
                ? (stats.totalAttempts / stats.gamesWon).toFixed(1) 
                : '-';
            document.getElementById('avg-attempts').textContent = avgAttempts;
        }

        // ============ DAILY PUZZLE ============
        // Launch date for calculating puzzle numbers (Jan 15, 2026)
        const LAUNCH_DATE = new Date('2026-01-15');
        
        function getDailySeed() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            return parseInt(`${year}${month}${day}`);
        }
        
        function getPuzzleNumber() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const launch = new Date(LAUNCH_DATE);
            launch.setHours(0, 0, 0, 0);
            const diffTime = today - launch;
            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
            return Math.max(1, diffDays + 1); // Puzzle #1 on launch day
        }

        function getDailyPuzzle() {
            const seed = getDailySeed();
            const index = seed % PUZZLES.length;
            const puzzle = PUZZLES[index];
            
            // Validation: ensure puzzle exists and has required properties
            if (!puzzle || !puzzle.items || !puzzle.pairs || !puzzle.order) {
                console.error('Invalid puzzle at index', index, '- falling back to puzzle 0');
                currentPuzzleNumber = getPuzzleNumber();
                return PUZZLES[0];
            }
            
            currentPuzzleNumber = getPuzzleNumber();
            
            // Store hint data for Game Shelf Hint Helper
            storeHintData(puzzle);
            
            return puzzle;
        }
        
        // Store puzzle data for Game Shelf Hint Helper (exposes items, NOT solution)
        function storeHintData(puzzle) {
            try {
                const hintData = {
                    gameId: 'rungs',
                    gameName: 'Rungs',
                    puzzleNumber: currentPuzzleNumber,
                    timestamp: Date.now(),
                    data: {
                        // Only expose the 8 items - NOT the pairs, order, or theme
                        items: puzzle.items.map(item => item.display),
                        difficulty: puzzle.difficulty
                    }
                };
                localStorage.setItem('gameshelf_hint_data', JSON.stringify(hintData));
                console.log('ü™ú Rungs hint data stored for puzzle #' + currentPuzzleNumber);
            } catch (e) {
                console.warn('Could not store hint data:', e);
            }
        }
        
        function getTimeUntilNextPuzzle() {
            const now = new Date();
            const tomorrow = new Date(now);
            tomorrow.setDate(tomorrow.getDate() + 1);
            tomorrow.setHours(0, 0, 0, 0);
            
            const diff = tomorrow - now;
            const hours = Math.floor(diff / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            
            return { hours, minutes, total: diff };
        }

        function shuffleWithSeed(array, seed) {
            const shuffled = [...array];
            let state = seed;
            
            const random = () => {
                state = (state * 1103515245 + 12345) & 0x7fffffff;
                return state / 0x7fffffff;
            };

            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            
            return shuffled;
        }

        // ============ INITIALIZATION ============
        
        // Helper to render puzzle without showing intro
        function renderPuzzleQuietly() {
            const tempShowIntro = showIntroOnStart;
            showIntroOnStart = false;
            renderPuzzle();
            showIntroOnStart = tempShowIntro;
        }
        
        function showAlreadyPlayed() {
            const result = getTodayResult();
            const stats = getStats();
            
            gameOver = true;
            
            const modal = document.getElementById('result-modal');
            const content = document.getElementById('result-content');
            
            // v1.0.14: Handle case where we know user played but result is missing
            if (!result) {
                content.innerHTML = `
                    <button class="modal-close-btn" onclick="closeResultModal()">&times;</button>
                    <h2 class="success">‚úÖ Already Played</h2>
                    <p style="color: var(--text-muted); margin-bottom: 15px;">You've already completed today's puzzle</p>
                    <div class="final-result">ü™ú</div>
                    ${stats.currentStreak > 1 ? `<p style="margin-top: 10px;">üî• Current Streak: <strong>${stats.currentStreak}</strong></p>` : ''}
                    <p style="margin-top: 20px; color: var(--text-muted);">‚è∞ Come back tomorrow for a new puzzle!</p>
                `;
                modal.classList.add('active');
                return;
            }
            
            const explanation = currentPuzzle ? currentPuzzle.explanation : '';
            
            if (result.won) {
                const bonusText = result.bonusCorrect === true ? 'Bonus: ‚úì' : 
                                  result.bonusCorrect === false ? 'Bonus: ‚úó' : '';
                
                content.innerHTML = `
                    <button class="modal-close-btn" onclick="closeResultModal()">&times;</button>
                    <h2 class="success">‚úÖ Already Played</h2>
                    <p style="color: var(--text-muted); margin-bottom: 15px;">You completed Rungs #${result.puzzleNumber} today</p>
                    <div class="final-result">üèÜ</div>
                    <p>Solved in ${result.attempts} attempt${result.attempts > 1 ? 's' : ''}!</p>
                    <p style="margin-top: 10px;" class="text-secondary">The stack was: <strong class="text-accent">${result.stackName}</strong></p>
                    ${explanation ? `<p style="margin-top: 8px; font-size: 0.9rem; color: var(--text-muted); font-style: italic;">${explanation}</p>` : ''}
                    ${bonusText ? `<p style="margin-top: 10px;">${bonusText}</p>` : ''}
                    ${stats.currentStreak > 1 ? `<p style="margin-top: 10px;">üî• Current Streak: <strong>${stats.currentStreak}</strong></p>` : ''}
                    <div class="share-text" id="share-text">${result.shareText || ''}</div>
                    <button class="btn btn-primary" onclick="copyShareFromSaved()">Share Result</button>
                    <p style="margin-top: 20px; color: var(--text-muted);">‚è∞ Come back tomorrow for a new puzzle!</p>
                `;
            } else {
                content.innerHTML = `
                    <button class="modal-close-btn" onclick="closeResultModal()">&times;</button>
                    <h2 class="fail">‚úÖ Already Played</h2>
                    <p style="color: var(--text-muted); margin-bottom: 15px;">You attempted Rungs #${result.puzzleNumber} today</p>
                    <div class="final-result">üòî</div>
                    <p style="margin-bottom: 10px;" class="text-secondary">The correct answer was:</p>
                    <p style="margin-bottom: 15px;"><strong class="text-accent">${result.stackName}</strong></p>
                    ${explanation ? `<p style="margin-bottom: 15px; font-size: 0.9rem; color: var(--text-muted); font-style: italic;">${explanation}</p>` : ''}
                    <div class="share-text" id="share-text">${result.shareText || ''}</div>
                    <button class="btn btn-primary" onclick="copyShareFromSaved()">Share Result</button>
                    <p style="margin-top: 20px; color: var(--text-muted);">‚è∞ Come back tomorrow for a new puzzle!</p>
                `;
            }
            
            modal.classList.add('active');
        }
        
        function copyShareFromSaved() {
            const result = getTodayResult();
            if (!result || !result.shareText) {
                showMessage('Unable to share - no saved result');
                return;
            }
            
            // Try native share first (mobile)
            if (navigator.share) {
                navigator.share({
                    title: 'Rungs',
                    text: result.shareText
                }).catch(() => {
                    // User cancelled or share failed, fall back to clipboard
                    fallbackCopyToClipboard(result.shareText);
                });
            } else {
                // Desktop fallback - copy to clipboard
                fallbackCopyToClipboard(result.shareText);
            }
        }

        function initGame() {
            // Check if already played today (daily mode only)
            if (!isPracticeMode && !isTutorialMode && hasPlayedToday()) {
                currentPuzzle = getDailyPuzzle();
                renderPuzzleQuietly();
                showAlreadyPlayed();
                return;
            }
            
            // Hide test mode in production
            if (!DEBUG_MODE) {
                const testSection = document.getElementById('test-mode-section');
                if (testSection) testSection.style.display = 'none';
            } else {
                // Populate puzzle dropdown for testing
                populatePuzzleDropdown();
            }
            
            // Check if first-time player
            if (!tutorialCompleted) {
                currentPuzzle = getDailyPuzzle();
                renderPuzzleQuietly();
                showTutorialChoice();
            } else {
                currentPuzzle = getDailyPuzzle();
                renderPuzzle();
                
                // v1.0.9: Restore saved game state if available
                const savedState = loadGameState();
                if (savedState && !isPracticeMode && !isTutorialMode) {
                    restoreGameState(savedState);
                }
            }
        }
        
        function populatePuzzleDropdown() {
            const dropdown = document.getElementById('puzzle-selector');
            const diffIcon = { easy: 'üü¢', medium: 'üü°', hard: 'üî¥' };
            dropdown.innerHTML = '<option value="">-- Daily Puzzle --</option>' + 
                PUZZLES.map((p, i) => 
                    `<option value="${i}">${diffIcon[p.difficulty] || '‚ö™'} #${i + 1}: ${p.stackName}</option>`
                ).join('');
        }
        
        function loadSelectedPuzzle() {
            const dropdown = document.getElementById('puzzle-selector');
            const index = dropdown.value;
            
            if (index === '') {
                // Load daily puzzle
                currentPuzzle = getDailyPuzzle();
            } else {
                currentPuzzle = PUZZLES[parseInt(index)];
                currentPuzzleNumber = parseInt(index) + 1; // Set puzzle number for test mode
            }
            
            renderPuzzleQuietly();
            closeMenu();
        }
        
        function renderPuzzle() {
            // Shuffle items for display (use puzzle index + date for consistent but unique shuffle)
            const puzzleIndex = PUZZLES.indexOf(currentPuzzle);
            const shuffleSeed = getDailySeed() + puzzleIndex;
            const shuffledItems = shuffleWithSeed(currentPuzzle.items, shuffleSeed);
            
            // Create pool
            const pool = document.getElementById('pool');
            pool.innerHTML = '';
            
            shuffledItems.forEach(item => {
                const div = document.createElement('div');
                div.className = 'item';
                div.dataset.id = item.id;
                
                if (item.type === 'emoji') {
                    div.innerHTML = `<span class="emoji">${item.display}</span>`;
                } else {
                    div.textContent = item.display;
                }
                
                div.onclick = () => selectItem(item.id);
                pool.appendChild(div);
            });
            
            // Reset stack
            stack = [null, null, null, null];
            updateStackDisplay();
            
            // Reset state
            selectedItems = [];
            selectedSlot = null;
            attemptsUsed = 0;
            gameOver = false;
            gameWon = false;
            hintRevealed = false;
            
            updateAttempts();
            updateButtons();
            updateModeUI();
            updateThemeHint();
            updateDifficultyBadge();
            
            // Show intro on first visit (unless coming from tutorial)
            if (showIntroOnStart && !skipIntroAfterTutorial) {
                showIntro();
            }
            skipIntroAfterTutorial = false; // Reset flag
        }

        function updateDifficultyBadge() {
            const badge = document.getElementById('difficulty-badge');
            const solveTimeEl = document.getElementById('solve-time');
            if (!currentPuzzle || !badge) return;
            
            const diff = currentPuzzle.difficulty || 'medium';
            badge.className = 'difficulty-badge ' + diff;
            badge.textContent = diff;
            
            // Set solve time
            if (solveTimeEl && currentPuzzle.solveTime) {
                solveTimeEl.textContent = '‚è±Ô∏è ' + currentPuzzle.solveTime;
                solveTimeEl.style.display = 'block';
            } else if (solveTimeEl) {
                solveTimeEl.style.display = 'none';
            }
        }

        // ============ SELECTION ============
        function selectItem(id) {
            if (gameOver) return;
            
            // Clear slot selection when selecting pool items
            if (selectedSlot !== null) {
                document.getElementById(`slot-${selectedSlot}`).classList.remove('selected');
                selectedSlot = null;
            }
            
            const itemEl = document.querySelector(`.item[data-id="${id}"]`);
            if (!itemEl || itemEl.classList.contains('stacked')) return;
            
            const index = selectedItems.indexOf(id);
            
            if (index !== -1) {
                // Deselect
                selectedItems.splice(index, 1);
                itemEl.classList.remove('selected');
            } else if (selectedItems.length < 2) {
                // Select
                selectedItems.push(id);
                itemEl.classList.add('selected');
            }
            
            updateButtons();
        }

        function selectSlot(slotIndex) {
            if (gameOver) return;
            if (stack[slotIndex] === null) return;
            
            // Clear pool selection
            selectedItems.forEach(id => {
                document.querySelector(`.item[data-id="${id}"]`).classList.remove('selected');
            });
            selectedItems = [];
            
            // Toggle slot selection
            if (selectedSlot === slotIndex) {
                document.getElementById(`slot-${slotIndex}`).classList.remove('selected');
                selectedSlot = null;
            } else {
                if (selectedSlot !== null) {
                    document.getElementById(`slot-${selectedSlot}`).classList.remove('selected');
                }
                selectedSlot = slotIndex;
                document.getElementById(`slot-${slotIndex}`).classList.add('selected');
            }
            
            updateButtons();
        }

        // ============ STACK OPERATIONS ============
        function stackSelected() {
            if (selectedItems.length !== 2) return;
            
            // Find next empty slot
            const slotIndex = stack.findIndex(s => s === null);
            if (slotIndex === -1) return;
            
            // Clear any slot selection
            selectedSlot = null;
            
            // Add to stack
            stack[slotIndex] = [...selectedItems];
            
            // Mark items as stacked
            selectedItems.forEach(id => {
                const itemEl = document.querySelector(`.item[data-id="${id}"]`);
                itemEl.classList.remove('selected');
                itemEl.classList.add('stacked');
            });
            
            selectedItems = [];
            updateStackDisplay();
            updateButtons();
            saveGameState(); // v1.0.9: Persist progress
            
            // Check if only 2 items remain - auto stack them (but don't auto-submit)
            const remainingItems = document.querySelectorAll('.item:not(.stacked)');
            if (remainingItems.length === 2) {
                setTimeout(() => {
                    // Auto-select and stack the last pair
                    const ids = Array.from(remainingItems).map(el => parseInt(el.dataset.id));
                    const slotIndex = stack.findIndex(s => s === null);
                    stack[slotIndex] = ids;
                    
                    remainingItems.forEach(el => el.classList.add('stacked'));
                    updateStackDisplay();
                    updateButtons();
                    saveGameState(); // v1.0.9: Persist progress after auto-stack
                }, 300);
            }
        }

        function unstackSelected() {
            if (selectedSlot === null) return;
            
            const pair = stack[selectedSlot];
            if (!pair) return;
            
            // Return items to pool
            pair.forEach(id => {
                const itemEl = document.querySelector(`.item[data-id="${id}"]`);
                itemEl.classList.remove('stacked');
            });
            
            // Remove from stack and collapse
            stack.splice(selectedSlot, 1);
            stack.push(null);
            
            selectedSlot = null;
            updateStackDisplay();
            updateButtons();
            saveGameState(); // v1.0.9: Persist progress
        }

        function resetGame() {
            // Return all items to pool
            document.querySelectorAll('.item').forEach(el => {
                el.classList.remove('selected', 'stacked');
            });
            
            // Clear stack
            stack = [null, null, null, null];
            selectedItems = [];
            selectedSlot = null;
            
            updateStackDisplay();
            updateButtons();
            saveGameState(); // v1.0.9: Persist progress (cleared state)
        }

        // ============ DISPLAY UPDATES ============
        function updateStackDisplay() {
            // Find the highest filled slot index
            let maxFilledIndex = -1;
            for (let i = 0; i < 4; i++) {
                if (stack[i] !== null) maxFilledIndex = i;
            }
            
            for (let i = 0; i < 4; i++) {
                const slot = document.getElementById(`slot-${i}`);
                const pair = stack[i];
                
                if (pair) {
                    // Get pair display in correct order
                    const { item1, item2, pairIndex } = getCorrectPairDisplay(pair);
                    
                    // Format display as "A & B"
                    const display1 = item1.type === 'emoji' ? `<span style="font-size: 1.3em;">${item1.display}</span>` : item1.display;
                    const display2 = item2.type === 'emoji' ? `<span style="font-size: 1.3em;">${item2.display}</span>` : item2.display;
                    const pairDisplay = `${display1} <span style="color: var(--accent-gold); margin: 0 4px;">&</span> ${display2}`;
                    
                    // With column-reverse, higher index = visually higher on screen
                    // So "up" means +1 index, "down" means -1 index
                    const canMoveUp = i < maxFilledIndex;
                    const canMoveDown = i > 0 && stack[i-1] !== null;
                    
                    slot.innerHTML = `
                        <button class="reorder-btn btn-up" onclick="event.stopPropagation(); moveStackItem(${i}, 1)" ${!canMoveUp ? 'disabled' : ''} title="Move up">‚ñ≤</button>
                        <span class="pair-item">${pairDisplay}</span>
                        <button class="reorder-btn btn-down" onclick="event.stopPropagation(); moveStackItem(${i}, -1)" ${!canMoveDown ? 'disabled' : ''} title="Move down">‚ñº</button>
                    `;
                    slot.classList.add('filled');
                    // Sync selected state with selectedSlot variable
                    if (selectedSlot === i) {
                        slot.classList.add('selected');
                    } else {
                        slot.classList.remove('selected');
                    }
                    slot.draggable = true;
                    slot.onclick = () => selectSlot(i);
                } else {
                    slot.innerHTML = '';
                    slot.classList.remove('filled', 'selected', 'drag-over');
                    slot.draggable = false;
                    slot.onclick = null;
                }
            }
            
            updateButtons();
        }

        function moveStackItem(index, direction) {
            if (gameOver) return;
            
            const newIndex = index + direction;
            if (newIndex < 0 || newIndex > 3) return;
            if (stack[newIndex] === null) return; // Can't swap with empty slot
            
            // Swap items
            const temp = stack[index];
            stack[index] = stack[newIndex];
            stack[newIndex] = temp;
            
            // Clear selection
            if (selectedSlot !== null) {
                document.getElementById(`slot-${selectedSlot}`).classList.remove('selected');
                selectedSlot = null;
            }
            
            updateStackDisplay();
            saveGameState(); // v1.0.9: Persist progress
        }

        function updateButtons() {
            document.getElementById('stack-btn').disabled = selectedItems.length !== 2;
            document.getElementById('unstack-btn').disabled = selectedSlot === null;
            
            const hasStackedItems = stack.some(s => s !== null);
            document.getElementById('reset-btn').disabled = !hasStackedItems && selectedItems.length === 0;
            
            // Submit enabled only when all 4 slots are filled
            const allSlotsFilled = stack.every(s => s !== null);
            document.getElementById('submit-btn').disabled = !allSlotsFilled;
        }

        function updateAttempts() {
            const dots = document.querySelectorAll('.attempt-dot');
            dots.forEach((dot, i) => {
                dot.classList.remove('active', 'used');
                if (i < attemptsUsed) {
                    dot.classList.add('used');
                } else if (i === attemptsUsed) {
                    dot.classList.add('active');
                }
            });
        }

        // ============ VALIDATION ============
        // Helper to display pair in correct order
        // - For emoji/number pairs: use puzzle-defined order
        // - For text-only pairs: alphabetical order
        function getCorrectPairDisplay(pair) {
            // Find which puzzle pair this matches
            for (let i = 0; i < currentPuzzle.pairs.length; i++) {
                const puzzlePair = currentPuzzle.pairs[i];
                if ((pair[0] === puzzlePair[0] && pair[1] === puzzlePair[1]) ||
                    (pair[0] === puzzlePair[1] && pair[1] === puzzlePair[0])) {
                    // Get items in puzzle-defined order
                    let item1 = currentPuzzle.items.find(it => it.id === puzzlePair[0]);
                    let item2 = currentPuzzle.items.find(it => it.id === puzzlePair[1]);
                    
                    // If both are text, sort alphabetically
                    if (item1.type === 'text' && item2.type === 'text') {
                        if (item1.display > item2.display) {
                            [item1, item2] = [item2, item1];
                        }
                    }
                    
                    return { item1, item2, pairIndex: i };
                }
            }
            // No match - return in selection order
            const item1 = currentPuzzle.items.find(it => it.id === pair[0]);
            const item2 = currentPuzzle.items.find(it => it.id === pair[1]);
            return { item1, item2, pairIndex: -1 };
        }

        // Format pair display as "A & B"
        function formatPairDisplay(item1, item2) {
            return `${item1.display} & ${item2.display}`;
        }

        function validateStack() {
            const results = {
                pairs: [],
                orderCorrect: true
            };
            
            // Check each pair
            stack.forEach((pair, stackIndex) => {
                if (!pair) return;
                
                // Use helper to get correct display order
                const { item1, item2, pairIndex } = getCorrectPairDisplay(pair);
                const pairDisplay = formatPairDisplay(item1, item2);
                
                results.pairs.push({
                    display: pairDisplay,
                    correct: pairIndex !== -1,
                    pairIndex: pairIndex
                });
            });
            
            // Check order (only if all pairs are correct)
            const allPairsCorrect = results.pairs.every(p => p.correct);
            
            if (allPairsCorrect) {
                // Check if order matches
                for (let i = 0; i < 4; i++) {
                    if (results.pairs[i].pairIndex !== currentPuzzle.order[i]) {
                        results.orderCorrect = false;
                        break;
                    }
                }
            } else {
                results.orderCorrect = false;
            }
            
            // Determine outcome
            const success = allPairsCorrect && results.orderCorrect;
            
            if (success) {
                gameWon = true;
                gameOver = true;
                clearGameState(); // v1.0.9: Clear saved state on win
                playCorrectSound();
                showBonusRound();
            } else {
                attemptsUsed++;
                updateAttempts();
                updateThemeHint();
                
                if (attemptsUsed >= 4) {
                    gameOver = true;
                    clearGameState(); // v1.0.9: Clear saved state on loss
                    playLoseSound();
                    showFinalResult(false, results);
                } else {
                    saveGameState(); // v1.0.9: Save state after failed attempt
                    playIncorrectSound();
                    showAttemptResult(results);
                }
            }
        }

        // ============ MODALS ============
        function showAttemptResult(results) {
            const modal = document.getElementById('result-modal');
            const content = document.getElementById('result-content');
            
            const pairsHTML = results.pairs.map((p, i) => `
                <div class="result-pair">
                    <span class="pair-text">${i + 1}. ${p.display}</span>
                    <span class="pair-status">${p.correct ? '‚úì' : '‚úó'}</span>
                </div>
            `).join('');
            
            const allPairsCorrect = results.pairs.every(p => p.correct);
            
            // Build order feedback
            let orderHTML = '';
            if (allPairsCorrect && !results.orderCorrect) {
                // Show which positions are correct
                const positionResults = results.pairs.map((p, i) => {
                    const isCorrectPosition = p.pairIndex === currentPuzzle.order[i];
                    return `<span style="color: ${isCorrectPosition ? 'var(--accent-success)' : 'var(--accent-error)'};">${isCorrectPosition ? '‚úì' : '‚úó'}</span>`;
                });
                orderHTML = `
                    <div class="result-order incorrect">
                        Stack Order: ‚úó Wrong
                        <div style="margin-top: 8px; font-size: 0.9rem;">
                            Positions: ${positionResults.join(' ')}
                        </div>
                    </div>
                `;
            } else {
                orderHTML = `
                    <div class="result-order ${results.orderCorrect ? 'correct' : 'incorrect'}">
                        Stack Order: ${results.orderCorrect ? '‚úì Correct' : '‚úó Wrong'}
                        ${!allPairsCorrect ? '<div style="font-size: 0.85rem; margin-top: 5px; opacity: 0.7;">(fix pairs first)</div>' : ''}
                    </div>
                `;
            }
            
            // Show hint reveal message if this was the 2nd attempt in easy mode
            const hintMessage = (attemptsUsed === 2 && gameMode === 'easy') 
                ? `<div style="margin: 15px 0; padding: 12px; background: var(--bg-tertiary); border: 2px solid var(--accent-gold); border-radius: 8px;">üí° Hint revealed: <strong style="color: var(--accent-gold);">${currentPuzzle.stackName}</strong></div>`
                : '';
            
            content.innerHTML = `
                <h2 class="fail">Attempt ${attemptsUsed} Result</h2>
                <div class="result-pairs">
                    ${pairsHTML}
                </div>
                ${orderHTML}
                ${hintMessage}
                <div class="attempts-remaining">
                    ${4 - attemptsUsed} attempt${4 - attemptsUsed !== 1 ? 's' : ''} remaining
                </div>
                <button class="btn btn-primary" onclick="continueGame()">Continue</button>
            `;
            
            modal.classList.add('active');
        }

        function continueGame() {
            document.getElementById('result-modal').classList.remove('active');
            // Don't reset - keep stack intact so player can adjust based on feedback
        }

        function closeResultModal() {
            document.getElementById('result-modal').classList.remove('active');
            // For testing - allows going to menu to pick another puzzle
        }

        function showBonusRound() {
            const modal = document.getElementById('result-modal');
            const content = document.getElementById('result-content');
            
            // Update stats for the win
            updateStats(true, attemptsUsed + 1);
            
            // Shuffle answer options
            const options = [currentPuzzle.stackName, ...currentPuzzle.decoys];
            const shuffledOptions = shuffleWithSeed(options, getDailySeed() + 1);
            
            const optionsHTML = shuffledOptions.map(opt => 
                `<option value="${opt}">${opt}</option>`
            ).join('');
            
            content.innerHTML = `
                <h2 class="success">üéâ Correct!</h2>
                <p>You solved it in ${attemptsUsed + 1} attempt${attemptsUsed > 0 ? 's' : ''}!</p>
                <div class="bonus-section">
                    <label>What is this stack called?</label>
                    <select class="bonus-select" id="bonus-answer">
                        <option value="">Select answer...</option>
                        ${optionsHTML}
                    </select>
                    <button class="btn btn-primary" onclick="submitBonusAnswer()">Submit</button>
                    <button class="btn btn-secondary" onclick="skipBonus()" style="margin-top: 10px;">Skip</button>
                </div>
            `;
            
            modal.classList.add('active');
        }

        function submitBonusAnswer() {
            const answer = document.getElementById('bonus-answer').value;
            if (!answer) {
                showMessage('Please select an answer', 'error');
                return;
            }
            
            const correct = answer === currentPuzzle.stackName;
            if (correct) {
                playWinSound();
            }
            showFinalResult(true, null, correct);
        }

        function skipBonus() {
            playWinSound();
            showFinalResult(true, null, null);
        }

        function showFinalResult(won, results, bonusCorrect) {
            const modal = document.getElementById('result-modal');
            const content = document.getElementById('result-content');
            
            // Update stats for loss (wins are handled in showBonusRound)
            if (!won) {
                updateStats(false, attemptsUsed);
            }
            
            const detailedExp = currentPuzzle.detailedExplanation || '';
            const tellMeMoreHTML = detailedExp ? `
                <button class="tell-me-more-btn" onclick="toggleDetailedExplanation()">üìñ Tell me more</button>
                <div class="detailed-explanation" id="detailed-explanation">
                    ${detailedExp}
                </div>
            ` : '';
            
            if (won) {
                const bonusText = bonusCorrect === true ? 'Bonus: ‚úì' : 
                                  bonusCorrect === false ? 'Bonus: ‚úó' : '';
                
                const explanation = currentPuzzle.explanation || '';
                
                content.innerHTML = `
                    <button class="modal-close-btn" onclick="closeResultModal()">&times;</button>
                    <h2 class="success">üéâ Victory!</h2>
                    <div class="final-result">üèÜ</div>
                    <p>Solved in ${attemptsUsed + 1} attempt${attemptsUsed > 0 ? 's' : ''}!</p>
                    <p style="margin-top: 10px;" class="text-secondary">The stack was: <strong class="text-accent">${currentPuzzle.stackName}</strong></p>
                    ${explanation ? `<p style="margin-top: 8px; font-size: 0.9rem; color: var(--text-muted); font-style: italic;">${explanation}</p>` : ''}
                    ${bonusText ? `<p style="margin-top: 10px;">${bonusText}</p>` : ''}
                    ${tellMeMoreHTML}
                    <div class="share-text" id="share-text"></div>
                    <button class="btn btn-primary" onclick="copyShare()">Share Result</button>
                `;
                
                generateShareText(true, bonusCorrect);
            } else {
                // Build correct answer display with A & B format
                const correctPairsHTML = currentPuzzle.order.map((pairIndex, position) => {
                    const pair = currentPuzzle.pairs[pairIndex];
                    let item1 = currentPuzzle.items.find(it => it.id === pair[0]);
                    let item2 = currentPuzzle.items.find(it => it.id === pair[1]);
                    
                    // If both are text, sort alphabetically
                    if (item1.type === 'text' && item2.type === 'text') {
                        if (item1.display > item2.display) {
                            [item1, item2] = [item2, item1];
                        }
                    }
                    
                    const pairText = `${item1.display} & ${item2.display}`;
                    return `
                        <div class="result-pair" style="background: var(--bg-hover);">
                            <span class="pair-text">${position + 1}. <strong>${pairText}</strong></span>
                        </div>
                    `;
                }).join('');
                
                const explanation = currentPuzzle.explanation || '';
                
                content.innerHTML = `
                    <button class="modal-close-btn" onclick="closeResultModal()">&times;</button>
                    <h2 class="fail">Game Over</h2>
                    <div class="final-result">üòî</div>
                    <p style="margin-bottom: 10px;" class="text-secondary">The correct answer was:</p>
                    <p style="margin-bottom: 5px;"><strong class="text-accent">${currentPuzzle.stackName}</strong></p>
                    ${explanation ? `<p style="margin-bottom: 15px; font-size: 0.9rem; color: var(--text-muted); font-style: italic;">${explanation}</p>` : ''}
                    <div class="result-pairs">
                        ${correctPairsHTML}
                    </div>
                    ${tellMeMoreHTML}
                    <div class="share-text" id="share-text"></div>
                    <button class="btn btn-primary" onclick="copyShare()">Share Result</button>
                `;
                
                generateShareText(false, null);
            }
            
            // Handle tutorial mode completion
            if (isTutorialMode) {
                completeTutorial();
                // Add "Play Daily Puzzle" button
                const tutorialBtn = document.createElement('button');
                tutorialBtn.className = 'btn btn-primary';
                tutorialBtn.style.cssText = 'margin-top: 15px; width: 100%; background: var(--accent-success);';
                tutorialBtn.innerHTML = 'üéØ Now play today\'s puzzle!';
                tutorialBtn.onclick = () => {
                    closeResultModal();
                    isTutorialMode = false;
                    skipIntroAfterTutorial = true; // Don't show intro after tutorial
                    currentPuzzle = getDailyPuzzle();
                    renderPuzzle();
                };
                content.appendChild(tutorialBtn);
                
                // Hide share button in tutorial mode
                const shareBtn = content.querySelector('.btn-primary');
                if (shareBtn && shareBtn.textContent.includes('Share')) {
                    shareBtn.style.display = 'none';
                }
                const shareText = document.getElementById('share-text');
                if (shareText) shareText.style.display = 'none';
            }
            
            modal.classList.add('active');
        }

        function toggleDetailedExplanation() {
            const el = document.getElementById('detailed-explanation');
            const btn = document.querySelector('.tell-me-more-btn');
            if (el.classList.contains('show')) {
                el.classList.remove('show');
                btn.textContent = 'üìñ Tell me more';
            } else {
                el.classList.add('show');
                btn.textContent = 'üìñ Hide details';
            }
        }

        // Report game result to Game Shelf
        function reportToGameShelf(won, bonusCorrect) {
            const stats = JSON.parse(localStorage.getItem('rungsStats') || '{}');
            const attempts = won ? attemptsUsed + 1 : 4;
            
            // Generate grid
            let grid;
            if (won) {
                grid = 'üü©'.repeat(attempts) + '‚¨õ'.repeat(4 - attempts);
            } else {
                grid = 'üü•üü•üü•üü•';
            }
            
            // Result emoji
            let resultEmoji = '‚ùå';
            if (won) {
                resultEmoji = (attempts === 1 && bonusCorrect === true) ? 'üéØ' : '‚úÖ';
            }
            
            // Mode
            const modeEmoji = gameMode === 'hard' ? 'üî•' : 'üí°';
            const modeLabel = gameMode === 'hard' ? 'Hard' : 'Easy';
            
            // Score line
            let scoreLine = won ? `${attempts}/4` : '0/4';
            if (bonusCorrect === true) scoreLine += ' ¬∑ ‚≠ê Bonus';
            
            // Mode line with streak
            let modeLine = `${modeEmoji} ${modeLabel}`;
            if (stats.currentStreak > 1) {
                modeLine += ` ¬∑ üî•${stats.currentStreak}`;
            }
            
            // Build share text
            const shareText = `ü™ú Rungs #${currentPuzzleNumber} ${resultEmoji}
${grid}
${scoreLine}
${modeLine}
rungs.game`;
            
            GameShelfIntegration.reportComplete({
                puzzleNumber: currentPuzzleNumber,
                puzzleId: new Date().toISOString().split('T')[0],
                won: won,
                attempts: attempts,
                maxAttempts: 4,
                perfect: won && attempts === 1 && bonusCorrect === true,
                mode: gameMode,
                streak: {
                    current: stats.currentStreak || 0,
                    max: stats.maxStreak || 0
                },
                grid: grid,
                scoreLine: scoreLine,
                shareText: shareText,
                meta: {
                    bonusCorrect: bonusCorrect,
                    stackName: currentPuzzle.stackName,
                    difficulty: currentPuzzle.difficulty
                }
            });
        }

        function generateShareText(won, bonusCorrect) {
            const stats = JSON.parse(localStorage.getItem('rungsStats') || '{}');
            const attempts = won ? attemptsUsed + 1 : 4;
            
            // Generate grid
            let grid;
            if (won) {
                grid = 'üü©'.repeat(attempts) + '‚¨õ'.repeat(4 - attempts);
            } else {
                grid = 'üü•üü•üü•üü•';
            }
            
            // Result emoji
            let resultEmoji = '‚ùå';
            if (won) {
                resultEmoji = (attempts === 1 && bonusCorrect === true) ? 'üéØ' : '‚úÖ';
            }
            
            // Mode
            const modeEmoji = gameMode === 'hard' ? 'üî•' : 'üí°';
            const modeLabel = gameMode === 'hard' ? 'Hard' : 'Easy';
            
            // Score line
            let scoreLine = won ? `${attempts}/4` : '0/4';
            if (bonusCorrect === true) scoreLine += ' ¬∑ ‚≠ê Bonus';
            
            // Mode line with streak
            let modeLine = `${modeEmoji} ${modeLabel}`;
            if (stats.currentStreak > 1) {
                modeLine += ` ¬∑ üî•${stats.currentStreak}`;
            }
            
            // Build standardized share text
            const result = `ü™ú Rungs #${currentPuzzleNumber} ${resultEmoji}
${grid}
${scoreLine}
${modeLine}
rungs.game`;
            
            document.getElementById('share-text').textContent = result;
            
            // Save today's result for "already played" check
            if (!isTutorialMode && !isPracticeMode) {
                saveTodayResult(won, attempts, bonusCorrect, result);
            }
            
            // Report to Game Shelf (only for daily puzzles, not tutorial)
            if (!isTutorialMode) {
                reportToGameShelf(won, bonusCorrect);
            }
        }

        function copyShare() {
            const text = document.getElementById('share-text').textContent;
            
            // Try native share first (mobile)
            if (navigator.share) {
                navigator.share({
                    title: 'Rungs',
                    text: text,
                    url: GAME_URL
                }).catch(() => {
                    // User cancelled or share failed, fall back to clipboard
                    fallbackCopyToClipboard(text);
                });
            } else {
                // Desktop fallback - copy to clipboard
                fallbackCopyToClipboard(text);
            }
        }
        
        function fallbackCopyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                showMessage('Copied to clipboard!', 'success');
            }).catch(() => {
                showMessage('Could not copy', 'error');
            });
        }

        // ============ UTILITIES ============
        function showMessage(text, type) {
            const msg = document.getElementById('message');
            msg.textContent = text;
            msg.className = `message ${type} show`;
            
            setTimeout(() => {
                msg.classList.remove('show');
            }, 2000);
        }

        // ============ START ============
        // Initialize Game Shelf Integration
        GameShelfIntegration.init('rungs', {
            name: 'Rungs',
            icon: 'ü™ú',
            url: 'rungs.game',
            version: VERSION,
            type: 'daily'
        });
        
        initDarkMode();
        
        // Initialize Plain Mode
        applyPlainMode();
        initPlainModeToggle();
        
        // Initialize Cloud Sync (GSAuth)
        GSAuth.init('rungs', {
            stats: 'rungsStats',
            practice: 'rungsPracticeStats'
        });
        
        initGame();
        
        // Drag and drop for reordering stack
        let draggedSlot = null;
        
        document.querySelectorAll('.stack-slot').forEach(slot => {
            slot.addEventListener('dragstart', (e) => {
                if (!slot.classList.contains('filled')) {
                    e.preventDefault();
                    return;
                }
                draggedSlot = parseInt(slot.dataset.slot);
                slot.classList.add('dragging');
            });
            
            slot.addEventListener('dragend', () => {
                slot.classList.remove('dragging');
                document.querySelectorAll('.stack-slot').forEach(s => s.classList.remove('drag-over'));
                draggedSlot = null;
            });
            
            slot.addEventListener('dragover', (e) => {
                e.preventDefault();
                if (draggedSlot !== null && slot.classList.contains('filled')) {
                    slot.classList.add('drag-over');
                }
            });
            
            slot.addEventListener('dragleave', () => {
                slot.classList.remove('drag-over');
            });
            
            slot.addEventListener('drop', (e) => {
                e.preventDefault();
                slot.classList.remove('drag-over');
                
                const targetSlot = parseInt(slot.dataset.slot);
                
                if (draggedSlot !== null && draggedSlot !== targetSlot) {
                    // Clear any selection when dragging
                    selectedSlot = null;
                    
                    // Swap the stack positions
                    const temp = stack[draggedSlot];
                    stack[draggedSlot] = stack[targetSlot];
                    stack[targetSlot] = temp;
                    
                    updateStackDisplay();
                    updateButtons();
                    saveGameState(); // v1.0.9: Persist progress
                }
            });
        });
        
        // Close menu when clicking outside
        document.getElementById('menu-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeMenu();
            }
        });
    </script>
    
    <!-- PWA Service Worker Registration -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then((reg) => {
                        console.log('[Rungs] SW registered');
                        setInterval(() => reg.update(), 3600000);
                        reg.addEventListener('updatefound', () => {
                            const nw = reg.installing;
                            nw.addEventListener('statechange', () => {
                                if (nw.state === 'installed' && navigator.serviceWorker.controller) {
                                    if (confirm('New version of Rungs available! Reload?')) location.reload();
                                }
                            });
                        });
                    }).catch((e) => console.log('[Rungs] SW failed:', e));
            });
        }
        let deferredInstallPrompt = null;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredInstallPrompt = e;
            if (!window.matchMedia('(display-mode: standalone)').matches && !sessionStorage.getItem('rungs_prompted')) {
                const b = document.createElement('div');
                b.id = 'pwa-install-banner';
                b.innerHTML = `<div style="position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:linear-gradient(135deg,#2d2535,#1a1520);color:#e8e0f0;padding:12px 20px;border-radius:12px;box-shadow:0 4px 20px rgba(0,0,0,0.3);display:flex;align-items:center;gap:12px;z-index:9999;max-width:90%;border:2px solid #ffd369;">
                    <span style="font-size:1.5rem;">ü™ú</span>
                    <div style="flex:1;"><div style="font-weight:600;">Install Rungs</div><div style="font-size:0.85rem;opacity:0.9;">Add to home screen</div></div>
                    <button onclick="installPWA()" style="background:#ffd369;color:#1a1520;border:none;padding:8px 16px;border-radius:8px;font-weight:600;cursor:pointer;">Install</button>
                    <button onclick="dismissInstall()" style="background:transparent;border:none;color:#e8e0f0;font-size:1.2rem;cursor:pointer;opacity:0.7;">‚úï</button>
                </div>`;
                document.body.appendChild(b);
            }
        });
        function installPWA() { if (deferredInstallPrompt) { deferredInstallPrompt.prompt(); deferredInstallPrompt.userChoice.then(() => { deferredInstallPrompt = null; dismissInstall(); }); } }
        function dismissInstall() { const b = document.getElementById('pwa-install-banner'); if (b) b.remove(); sessionStorage.setItem('rungs_prompted', 'true'); }
    </script>
</body>
</html>
